---
title: "Trigger instance refresh of Amazon EC2 Auto Scaling group with a launch template update using Terraform"
date: 2023-10-06 03:40:05 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note continues my discussion on the Amazon EC2 Auto Scaling group that I started in <strong><a href="https://skundunotes.com/2023/09/12/create-amazon-ec2-auto-scaling-group-and-load-balancer-using-terraform-and-github-actions/" target="_blank" rel="noopener">my previous post</a></strong>, so please read that before this one. In that post, I explain the fundamentals of creating an Amazon EC2 Auto Scaling Group using Terraform.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon Auto Scaling group consists of Amazon EC2 instances with specific properties like the instance type, the AMI ID, the subnet where the instances are placed, the user data script to run, etc. All of that information is stored in a <span style="text-decoration: underline">launch template</span>. An Auto Scaling group creates EC2 instances based on the specifications in the launch template.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Instance refresh</strong> is a functionality that enables auto-provisioning (creation) of new EC2 instances and de-provisioning (termination) of the older EC2 instances in an Amazon EC2 Auto Scaling group. Since EC2 instances in an Amazon Auto Scaling Group are created based on the specifications in a <span style="text-decoration: underline">launch template</span>, a change in the launch template can trigger an <span style="text-decoration: underline">instance refresh</span> event.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to this concept, you might have a question  -<em>Why should I care about an instance refresh?</em> And here is my <span style="text-decoration: underline">answer</span>. A project team uses an Amazon EC2 Auto Scaling group to host applications, services, etc. An application or service is a continuously changing/evolving product based on customer feedback. If a project team hosts their applications/services on an Amazon EC2 Auto Scaling group, they specify the details in the <span style="text-decoration: underline">launch template</span>. The change could be, for example, in the form of a new AMI ID, a different instance type, or an updated user data script. A launch template consists of all that information. Hence, a project team would <span style="text-decoration: underline">update the launch template</span> as part of their application or service release. However, updating a launch template <strong>does not</strong> automatically deploy new Amazon EC2 instances. Yes, newly created instances in the Auto Scaling group would follow the new launch template due to a scale-out event or if existing instances got terminated. However, in the absence of that, the existing Amazon EC2 instances won’t be replaced unless that is <span style="text-decoration: underline">explicitly called out</span> in the Amazon EC2 Auto Scaling group properties. And that is what I <strong>demonstrate in this note</strong>. Here is a link to my <a href="https://github.com/kunduso/add-asg-elb-terraform" target="_blank" rel="noopener">GitHub repository for your reference</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that an instance refresh can also be triggered manually, which adds the extra step of someone having to trigger that.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The properties to enable an Amazon Auto Scaling group instance refresh event with a launch template update using Terraform are specified in the <code>aws_autoscaling_group</code> resource definition. Here is a <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group" target="_blank" rel="noopener">link to the official Terraform registry</a> for that. Two property blocks trigger the instance refresh. These are <code>launch_template</code> and <code>instance_refresh</code>.</span></span></span>
<img class="alignnone size-full wp-image-2927" src="https://skundunotes.com/wp-content/uploads/2023/10/84-image-1.png" alt="84-image-1" width="493" height="639" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Inside the <code>launch_template</code> property block, <span style="text-decoration: underline">two</span> values are specified: id and version. A <span style="text-decoration: underline">direct dependency</span> is created by specifying these values to a specific <code>aws_launch_template</code> resource.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, inside the <code>instance_refresh</code> property, the <code>triggers</code> value is set to <code>launch_template</code>, ensuring that the Amazon EC2 Auto Scaling group would trigger that as soon as the launch template is updated.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To test this theory, I updated the <code>instance_type</code> from a <code>t3.medium</code> to a <code>t2.medium</code> and deployed the changes using the command <code>terraform apply</code>. Then, on the AWS Console, I navigated to EC2 →Auto Scaling Groups → select the Auto Scaling group → Instance Refresh → Active instance refresh and saw that the process had started. Below is a screenshot of the same activity.</span></span></span>
<img class="alignnone size-full wp-image-2928" src="https://skundunotes.com/wp-content/uploads/2023/10/84-image-2.png" alt="84-image-2" width="1337" height="364" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, under Instance refresh history, I saw the status of the activity.</span></span></span>
<img class="alignnone size-full wp-image-2929" src="https://skundunotes.com/wp-content/uploads/2023/10/84-image-3.png" alt="84-image-3" width="1348" height="325" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And under the Activity Tab → Activity History, I saw the below messages as instances were updated:</span></span></span>
<img class="alignnone size-full wp-image-2930" src="https://skundunotes.com/wp-content/uploads/2023/10/84-image-4.png" alt="84-image-4" width="1230" height="258" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since I had the <code>min_healthy_percentage</code> set to 50% for the <code>instance_refresh</code> preference property, the Auto Scaling Group ensured that at any point in time during the instance refresh, <span style="text-decoration: underline">that many instances remained available</span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, under the Instance management tab, I saw that one of the Amazon EC2 instances ran with a <code>t2.medium</code> instance type.</span></span></span>
<img class="alignnone size-full wp-image-2931" src="https://skundunotes.com/wp-content/uploads/2023/10/84-image-5.png" alt="84-image-5" width="1280" height="369" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After a few minutes, all the Amazon EC2 instances were on the <code>t2.medium</code> instance type, and the instance refresh activity was complete. And that brings us to the end of this note. I also have a separate note on <a href="https://skundunotes.com/2023/09/27/create-an-amazon-ec2-auto-scaling-group-with-metric-scaling-policies-using-terraform/" target="_blank" rel="noopener">creating an Amazon EC2 Auto Scaling group with metric scaling policies using Terraform</a>, which you might find helpful.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope this note was helpful, and please do not hesitate to comment if you have any questions or suggestions.</span></span></span>
