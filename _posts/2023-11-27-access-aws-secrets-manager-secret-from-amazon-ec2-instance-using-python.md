---
title: "Access AWS Secrets Manager secret from Amazon EC2 instance using Python"
date: 2023-11-27 14:00:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" target="_blank" rel="noopener">AWS-Docs</a>, AWS Secrets Manager is a service to manage, retrieve, and rotate database credentials, application credentials, OAuth tokens, API keys, and other secrets throughout their lifecycles. Many AWS services store and use secrets in Secrets Manager. In this note, I <span style="text-decoration: underline">demonstrate</span> how to access the AWS Secrets Manager secret value using Python from an Amazon EC2 instance.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For that, I:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. created a couple of secrets and stored those inside AWS Secrets Manager secrets,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. created a couple of Amazon EC2 instances, and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. created Python files inside the Amazon EC2 instances using the user data script to access the secret.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used Terraform to create all these resources. Then, one by one, I logged into the EC2 instances using Session Manager and <span style="text-decoration: underline">accessed</span> the secret value using the Python file. I have the <strong>code in my GitHub repository</strong> so you can follow along if you are interested: <a href="https://github.com/kunduso/ec2-userdata-terraform/tree/access-secrets-python" target="_blank" rel="noopener">ec2-userdata-terraform</a> (please note the branch name: <code>access-secrets-python</code>).</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I broke down this use case into eight steps. The first four demonstrate how to create the resources, and the last four show how to access the secret from the Amazon EC2 instances.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an Amazon VPC and network components to enable internet access</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I assigned a small CIDR block to the Amazon VPC and created only one subnet. Then, I created an Internet Gateway and attached that to the Amazon VPC. Finally, I added a route to <code>0.0.0.0/0</code> and updated the subnet’s route table to point to that using the Internet Gateway.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There is no need for a route to the internet to test how to access the AWS Secrets Manager secret from an Amazon EC2 instance. I did that because I installed packages on the Amazon EC2 instance and required Sessions Manager access to the Amazon EC2 instances. I required access to the internet for both of these.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2: Create a couple of AWS Secrets Manager secrets</strong>
I created two AWS Secrets Manager secrets to store a secret as a string and JSON. I used the <a href="https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/password" target="_blank" rel="noopener">random provider’s</a> <code>random_password</code> resource type to create the secrets.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The below image is the secret stored as a string:</span></span></span>
<img class="alignnone size-full wp-image-3121" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-1.png" alt="86-image-1" width="958" height="295" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This image is the secret stored as a JSON:</span></span></span>
<img class="alignnone size-full wp-image-3122" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-2.png" alt="86-image-2" width="1039" height="346" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create an IAM role that has permissions to access the AWS Secrets Manager secrets</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this step, I created the IAM policy to access the value of the secrets. I created a tight permission policy by providing the ARN of the resources and specific action (<code>secretsmanager:GetSecretValue</code>).</span></span></span>
<strong><img class="alignnone size-full wp-image-3123" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-3.png" alt="86-image-3" width="967" height="632" /></strong>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create Amazon EC2 instances and attach the EC2 instance profile</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The next step is to create the two Amazon EC2 instances and attach the IAM instance profile. Below is an image of one Amazon EC2 instance’s code:</span></span></span>
<img class="alignnone size-full wp-image-3124" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-4.png" alt="86-image-4" width="902" height="490" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I passed the AWS Secrets Manager Secret string for the EC2 instance provisioned via the above code; for the other instance, I passed the AWS Secrets Manager Secret JSON.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to attaching an IAM role to an Amazon EC2 instance, I have a detailed note: <a href="http://skundunotes.com/2021/11/16/attach-iam-role-to-aws-ec2-instance-using-terraform/" target="_blank" rel="noopener">Attach an IAM role to an Amazon EC2 instance using Terraform</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I ran the <code>terraform init</code> and <code>terraform apply</code> steps to provision the resources. Please note that if you use my code, please update the <code>backend.tf</code> to store the state file.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Log in to the Amazon EC2 instance using Session Manager</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">One of the permissions policies I attached to the IAM role was <code>arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore</code>, which enabled the Amazon EC2 instance to be accessible from the AWS Console. You need the Amazon EC2 instance to have access to the internet for this to work (or a VPC endpoint for Systems Manager). I have a detailed note on that at: <a href="http://skundunotes.com/2023/08/27/provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform/" target="_blank" rel="noopener">create an Amazon EC2 instance with Session Manager access using Terraform</a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After running the Terraform code, you will see that two Amazon EC2 instances were created in your AWS console. Select any one of the instances and click on the Connect button. You will be presented with the below options in the case of Linux.</span></span></span>
<img class="alignnone size-full wp-image-3125" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-5.png" alt="86-image-5" width="808" height="346" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Select “Session Manager” and click on Connect. You will then have CLI access to the instance.</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Navigate to the Python file and inspect that</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The file is stored in the <code>/var</code> folder as <code>read_secret.py</code> inside the Amazon EC2 instance. You can find that from the <code>user_data</code> script stored in the repository. After you <code>cd</code> into the <code>/var</code> folder using the command <code>cd /var</code>, you can run the <code>ls</code> command. If the Amazon EC2 user data file ran correctly, you must see the <code>read_secret.py</code> file. If interested, you can <code>cat</code> open the file and inspect it. Here is what one of the rendered files looks like:</span></span></span>
<img class="alignnone size-full wp-image-3126" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-6.png" alt="86-image-6" width="724" height="403" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that it can take <span style="text-decoration: underline">10-12 mins</span> for the <code>user_data</code> script to run and generate the file for you after the Amazon EC2 instance is in the <code>Running</code> state.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 7: Run the Python file</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Run the Python file using the command <code>python3 read_secret.py</code>, and you must get an output as shown in the below image. The secret value may be different for you since that is randomly generated.</span></span></span>
<img class="alignnone size-full wp-image-3127" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-7.png" alt="86-image-7" width="731" height="171" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Log in to the other Amazon EC2 instance and run the Python file. This time, you must get a message as below:</span></span></span>
<strong><img class="alignnone size-full wp-image-3128" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-8.png" alt="86-image-8" width="826" height="187" /></strong>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 8: Verify the AWS Secrets Manager Secret value</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the AWS Console, navigate to AWS Secrets Manager Secret, and you’ll see the two secrets created via this Terraform configuration. Here is the value of the <code>app-1-secret-json</code> secret:</span></span></span>
<img class="alignnone size-full wp-image-3129" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-9.png" alt="86-image-9" width="761" height="287" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And here is the value of <code>app-1-secret-string</code> secret:</span></span></span>
<img class="alignnone size-full wp-image-3130" src="https://skundunotes.com/wp-content/uploads/2023/11/86-image-10.png" alt="86-image-10" width="623" height="277" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can see that the secret values match what the Python script displayed.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. I hope you understood the use case that I discussed. Please review the <code>user_data</code> template file in the GitHub repository to understand how the Python files were created. Let me know if you have any questions or suggestions.</span></span></span>
