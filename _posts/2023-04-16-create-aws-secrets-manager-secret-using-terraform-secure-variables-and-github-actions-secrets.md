---
title: "Create AWS Secrets Manager secret using Terraform secure variables and GitHub Actions secrets"
date: 2023-04-16 13:53:05 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A little while back, I encountered an exciting use case requiring me to use GitHub Actions secrets. The use case was to create an AWS Secrets Manager secret resource using Terraform in a CI/CD pipeline.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An AWS Secrets Manager secret is a resource to store secure credentials. In the past, I created an AWS Secrets Manager resource using Terraform from my laptop. I did this by storing the secret value in the <code>tfvars</code> file and ensuring that the <code>tfvars</code> file is not part of the repository using the <code>.gitignore</code> file. Since the secret value was not committed to the repository, the approach worked fine in that case. However, how do you do that when provisioning resources with secure values via a pipeline using Terraform configuration code? Enter <strong>Github Actions secrets</strong>  -<em>a secure information transfer mechanism for GitHub Actions pipelines.</em></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I detail all the nuances of creating an <strong>AWS Secrets Manager secret using Terraform and GitHub Actions.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before working on this use case, please understand two critical concepts associated with deploying Terraform configuration to the AWS cloud using GitHub actions.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Concept#1:</strong> <a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener">Securely integrate AWS Credentials with GitHub Actions using OpenID Connect</a></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Concept#2:</strong> <a href="https://skundunotes.com/2023/03/07/ci-cd-with-terraform-and-github-actions-to-deploy-to-aws/" target="_blank" rel="noopener">CI-CD with Terraform and GitHub Actions to deploy to AWS</a></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once you are comfortable with the above two concepts, you can move to the next section in this use case.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are <span style="text-decoration: underline">three aspects</span> to this use case.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. <strong>Store</strong> the secret value in a GitHub repository secret</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Securely <strong>transfer</strong> the GitHub repository secrets to Terraform, and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. The Terraform configuration to <strong>create</strong> the AWS Secrets Manager secret.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the following few paragraphs, I will walk you through each aspect. If interested, please access my<strong> GitHub</strong> <a href="https://github.com/kunduso/add-aws-secretsmanager-terraform" target="_blank" rel="noopener"><code>repository: add-aws-secretsmanager-terraform</code></a> and follow along.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Store the secret value in a GitHub repository secret.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Each GitHub repository can store secure variables  -navigate to the Settings Tab and under the Security category, Secrets and variables -&gt; Actions. This option can be used to store variables and secrets. For example, below is a screenshot of a secret I added.</span></span></span>
<img class="alignnone size-full wp-image-2521" src="https://skundunotes.com/wp-content/uploads/2023/04/74-image-2.png" alt="74-image-2" width="937" height="388" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After reviewing the correct value, I clicked the "Add secret" button. Once a secret is added to GitHub Actions secrets, <span style="text-decoration: underline">one cannot view the value.</span> For this use case, I stored three secrets in GitHub Actions secrets.</span></span></span>
<img class="alignnone size-full wp-image-2522" src="https://skundunotes.com/wp-content/uploads/2023/04/74-image-3.png" alt="74-image-3" width="772" height="250" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Securely transfer the GitHub repository secrets to Terraform.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As I mentioned in <a href="https://skundunotes.com/2023/03/07/ci-cd-with-terraform-and-github-actions-to-deploy-to-aws/" target="_blank" rel="noopener">concept#2 above, CI-CD with Terraform and GitHub Actions to deploy to AWS</a>, Terraform is invoked via the GitHub Actions pipeline. GitHub Actions secrets are accessible to the pipeline via the <code>${{ secrets.SecretName }}</code> construct where <code>SecretName</code> is <code>VariableOne</code> in our use case. I passed the values to Terraform during the <code>terraform plan</code> and <code>terraform apply</code> step in the <code>terraform.yml</code> pipeline that I stored in the <code>.github\workflows</code> folder in my GitHub repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Below is an image of the <code>terraform apply</code> step:</span></span></span>
<img class="alignnone size-full wp-image-2526" src="https://skundunotes.com/wp-content/uploads/2023/04/74-image-6.png" alt="74-image-6" width="853" height="208" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. The Terraform configuration to create the AWS Secrets Manager secret</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I stored two types of AWS Secrets Manager secrets in the Terraform configuration file <a href="https://github.com/kunduso/add-aws-secretsmanager-terraform/blob/main/secretmanager.tf" target="_blank" rel="noopener"><code>secretmanager.tf</code></a>  -one as a <span style="text-decoration: underline">secret string</span> and the other as a <span style="text-decoration: underline">key-value pair</span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After committing the changes to my local repository, I pushed the changes up to the remote repository in GitHub. That action triggered a couple of pipelines; the <span style="text-decoration: underline"><a href="https://github.com/kunduso/add-aws-secretsmanager-terraform/actions/workflows/code-scan.yml" target="_blank" rel="noopener">checkov scan</a></span> of the terraform configuration and a <span style="text-decoration: underline"><a href="https://github.com/kunduso/add-aws-secretsmanager-terraform/actions/workflows/terraform.yml" target="_blank" rel="noopener">terraform pipeline</a></span> run. Next, I created a pull request and merged the changes to the <code>main</code> branch. This merge operation triggered another pipeline run with the <code>terraform apply</code> step enabled.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After the pipeline succeeded, I logged into my AWS account and navigated to AWS Secrets Manager -&gt; Secrets. Then I clicked on the "retrieve secret value" button to access the values of these secrets. Next, I reviewed the secrets that GitHub Actions created using the Terraform configurations there. As you can see from the screenshot below, two types of secrets were available -one is a plaintext secret, while the other is a key-value pair. <span style="text-decoration: underline">And GitHub Actions provisioned the AWS Secret Manager secrets without exposing the secure values.</span></span></span></span>

<img class="alignnone size-full wp-image-2524" src="https://skundunotes.com/wp-content/uploads/2023/04/74-image-5.png" alt="74-image-5" width="937" height="363" />
<img class="alignnone size-full wp-image-2523" src="https://skundunotes.com/wp-content/uploads/2023/04/74-image-4.png" alt="74-image-4" width="1054" height="405" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope this was a helpful note to understand how to manage secure variables for AWS cloud resources using Terraform and GitHub Actions. Please do let me know if you have any questions.</span></span></span>
