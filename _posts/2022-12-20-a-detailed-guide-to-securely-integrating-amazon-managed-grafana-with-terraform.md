---
title: "A detailed guide to securely integrating Amazon Managed Grafana with Terraform"
date: 2022-12-20 16:52:58 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Over the last couple of months, I worked extensively on <strong>Amazon Managed Grafana</strong> to create dashboards for observability. In the course of automating the deployment using Terraform and a CI-CD system, I learned about a few challenges and identified solutions. I'm sharing my learnings in this note so that<strong> you do not make the same mistakes I made.</strong> In addition, towards the end of this guide, I have links to detailed notes on provisioning a workspace and dashboards in that workspace using Terraform.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/grafana/latest/userguide/what-is-Amazon-Managed-Service-Grafana.html" target="_blank" rel="noopener">AWS-Docs</a></span>, Amazon Managed Grafana is a fully managed and secure data visualization service that you can use to instantly query, correlate, and visualize operational metrics, logs, and traces from multiple data sources. In addition, Amazon Managed Grafana makes it easy to deploy, operate, and scale Grafana.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Amazon Managed Grafana can be classified into <strong>two planes: the control plane and the data plane.</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <strong>control plane</strong> deals with the Amazon Managed Grafana workspace, SSO/Identity Center integration, and managing access to AWS services like Amazon CloudWatch.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <strong>data plane</strong> deals with setting up the data source, creating the dashboard, and managing access to folders and dashboards inside the workspace. <span style="text-decoration: underline">Identifying this classification is necessary since it will reduce your learning curve considerably</span>. As you have noticed, since the data plane depends on the control plane, the control plane must be provisioned and configured before the data plane can be created and used.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Coming from the DevOps mindset, I wanted to create a <strong>repeatable, testable, modular, and efficient system</strong> for creating the workspace and dashboards in Amazon Managed Grafana.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let me walk through how I achieved the objective, beginning with ensuring that the process is <strong>repeatable</strong> and <strong>testable</strong>. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The simplest way to ensure that is to use infrastructure as a code tool. By adopting <strong>Terraform to provision these resources</strong> for the control and data planes and running <strong>Bridgecrew checkov on the source code</strong>, I ensured just that.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Continuing, let's focus on how the process is <strong>modular</strong>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I began by <span style="text-decoration: underline">ideating a single Terraform stack</span> to automate the provisioning of both the control and data planes. So I planned to create all the resources in the project:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-the workspace,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-the Identity Center integration,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-the IAM role and policy for the workspace to assume,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-setting up the data source,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-creating a folder,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-and deploying the dashboard using <span style="text-decoration: underline">a single Terraform project</span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <strong>control plane</strong> was automated using the <strong><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" target="_blank" rel="noopener">AWS provider for Terraform</a></strong>. The <strong>data plan</strong> was automated using the <strong><a href="https://registry.terraform.io/providers/grafana/grafana/latest/docs" target="_blank" rel="noopener">Grafana provider for Terraform</a></strong>. Although you can use both providers in the same Terraform stack, I soon realized that the system would be <strong>challenged</strong> when deploying the data plane with the control plane, <span style="text-decoration: underline">particularly while managing the workspace API key.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <strong>Grafana workspace API key</strong> and the <strong>Grafana workspace URL</strong> are mandatory values for the Grafana provider for Terraform. Hence, that value should be available before the usage of the grafana provider, which is before the <code>terraform init</code> stage. In addition, there is a resource in the AWS provider for Terraform registry called <code><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/grafana_workspace_api_key" target="_blank" rel="noopener">aws_grafana_workspace_api_key</a></code> that Terraform can use to create the workspace API key.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Hence the process could look like this:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(i) create the control plane resources using the AWS Terraform provider, including the <code>aws_grafana_workspace_api_key</code>,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(ii) store the API key securely, and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(iii) access the API key and provision the data plane resources using the Grafana Terraform provider.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, there is a limitation to the above process. The workspace API key has a duration field (seconds to live) during which it is active, and once it has expired, there is no way to use that key. So, per Terraform, the resource exists, but it is useless after its expiry -which Terraform does not manage.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> To test this out, create an <code>aws_grafana_workspace_api_key</code> resource with </span></span></span><code class="terraform language-terraform"><span class="token property">seconds_to_live</span> <span class="token punctuation">=</span> <span class="token number">60</span></code><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">. After 60 seconds (when the key has expired), try to run a <code>terraform apply</code> command. You will get a <code>Apply complete! Resources: 0 added, o changed, o destroyed.</code> message. So after 60 seconds, the key has expired, but per Terraform, there isn't any change required.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Another Note:</strong> I know the AWS provider maintainers will fix this bug at a future date. When I was testing this issue, the latest version of the AWS Terraform provider was 4.48.0.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An <span style="text-decoration: underline">alternate approach</span> would be to <span style="text-decoration: underline">destroy only the workspace API key</span> after each usage in the data plane such that the process can be automated and work the next time via the CI-CD pipeline that there is a <code>terraform apply</code> step. But you see the challenge? This is different from the conventional approach. <span style="text-decoration: underline">We seldom destroy resources after they are provisioned</span>. Moreover, what if there is an error and the process of provisioning resources and destroying the workspace API key does not end successfully, leaving the resource provisioned and un-deleted? The next run of <code>terraform apply</code> would blow up because the <code>aws_grafana_workspace_api_key</code> resource would still be provisioned but not usable since the key has expired.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This limitation restricts the process of creating resources belonging to the control and data plane in one Terraform stack. Hence, my preferred solution was to have <strong>separate Terraform stacks</strong> for the control and data plane with their CI-CD pipelines.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Regarding creating the workspace API key, I preferred not to use Terraform to create the key. Instead, I created the key using <strong><em>PowerShell (I have used Python to create it too)</em></strong>. The question to ask is -<strong><em>why do I need the workspace API key?</em></strong> Because the workspace API key, along with the workspace URL, is a mandatory value to use the Grafana Terraform provider. Creating the data plane implies that the control plane exists and is already provisioned. In that case, my CI-CD process for the data plane could look something like this:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- get the value of the Grafana workspace URL (this value is available from the control plane CI-CD pipeline),</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- create an API key using PowerShell or Python,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- pass the value of the Grafana workspace URL and workspace API key to the Terraform code, and </span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- provision resources belonging to the data plane using the Grafana Terraform provider, and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- delete the workspace API key using PowerShell or Python.</span></span></span>

<span style="text-decoration: underline"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000;text-decoration: underline">Why do I believe this process to be better?</span></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">By managing the workspace API key outside of Terraform, <span style="text-decoration: underline">I ensured the process of provisioning resources does not include variations</span>. Its still <code>terraform init -&gt; plan -&gt; apply</code>. <strong>Security-wise,</strong> the workspace API key does not leave the environment where it was provisioned -the CI-CD system. The workspace API key is deleted in the same CI-CD pipeline that created it; hence, in the following pipeline run, there are no lingering effects of the previous pipeline run.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And finally, let me address the <strong>efficiency</strong> aspect of the process</span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Adopting two individual CI-CD approaches for provisioning resources in the control and data plane of Amazon Managed Grafana workspace makes it <strong>easy to understand and maintain.</strong> And by managing the workspace API key outside of Terraform, I ensured that the resource provisioning process did not involve any variation or alternate paths.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, to sum it up, here are my recommendations:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-use the AWS Terraform provider to provision the Amazon Managed Grafana workspace (control plane),</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-use the Grafana Terraform provider to provision resources inside the Amazon Managed Grafana workspace (data plane),</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-manage the workspace API key outside of Terraform (via AWS CLI, Python, or PowerShell), and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-create separate CI-CD pipelines while working with the Amazon Managed Grafana workspace and dashboards.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can read more about this process along with the link to my <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard" target="_blank" rel="noopener">GitHub repository</a>, where I have the code stored to provision the control and data plane resources. And I have separate CI-CD pipelines for the control and data plane.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><a href="https://skundunotes.com/2022/11/12/create-an-amazon-managed-grafana-workspace-using-terraform/" rel="nofollow">Create Amazon Managed Grafana Workspace using Terraform.</a>
<a href="https://skundunotes.com/2022/12/03/create-an-amazon-managed-grafana-dashboard-using-terraform-and-azure-pipelines/" rel="nofollow">Create Amazon Managed Grafana Dashboard using Terraform</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note helpful. Let me know if you disagree or have alternate views. I'd love to learn more from your use case.</span></span></span>
