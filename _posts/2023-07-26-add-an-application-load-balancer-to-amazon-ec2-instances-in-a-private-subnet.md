---
title: "Add an application load balancer to Amazon EC2 instances in a private subnet"
date: 2023-07-26 17:46:36 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I create a highly available environment using Amazon EC2 instances spread over multiple availability zones attached to an application load balancer. I also have a link to my GitHub repository with the code.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the past, I wrote a note on how to <a href="https://skundunotes.com/2022/07/30/add-an-application-load-balancer-to-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">toggle traffic between three EC2 instances in three availability zones using an application load balancer</span></span></span></a>. However, the EC2 instances were in a public subnet. I will do the same on this note, except the <strong>private subnet will host the EC2 instances.</strong> I'll demonstrate how to create EC2 instances in a private subnet <em>(no access to the internet via an internet gateway)</em> and then attach them to an application load balancer in a public subnet that toggles traffic to the EC2 instances.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before that, let me quickly explain the <span style="text-decoration: underline">fundamental difference between a public and a private subnet.</span></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Any subnet attached to a route table with a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> using an internet gateway is a public subnet. Hence, a private subnet does not have a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> in its route table via the internet gateway. A private subnet can have a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> using a NAT gateway in the public subnet.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the following paragraphs, I'll briefly describe all the resources I created and how they are linked. If you are interested and want to follow along, here is a link to the GitHub repository: <a href="https://github.com/kunduso/add-aws-elb-ec2-private-subnet-terraform/tree/ec2-lb" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add-aws-elb-ec2-private-subnet-terraform</span></span></span></a>. <span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000">Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = ec2-lb</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can broadly classify the activities into four steps:</span></span></span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create the network resources</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>UPDATE:</strong> As of March 2025, the network stack was converted to consume from a VPC module instead of the Terraform configuration, as shown below.</span></span></span>
<img class="alignnone size-large wp-image-5805" src="https://skdevops.wordpress.com/wp-content/uploads/2023/07/79-image-9.png?w=656" alt="" width="656" height="434" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Passing variables to the VPC module achieves the same functionality as previously achieved from the Terraform code written earlier and described below for the network resources.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created a VPC with a CIDR size of <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/24</code> which was sufficient for meÂ  -256 IP addresses. Then I broke that CIDR into six subnets (three public and three private) of <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/27</code>. A <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/27</code> will have 32 IP addresses. I used <a href="https://cidr.xyz/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">my fav CIDR tool</span></span></span></a> for that.</span></span></span>
<img class="alignnone size-full wp-image-2727" src="https://skundunotes.com/wp-content/uploads/2023/07/79-image-2.png" alt="79-image-2" width="614" height="391" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, I created an internet gateway in the VPC. <span style="text-decoration: underline">The (external) application load balancer requires an internet gateway to communicate with the internet.</span> I also added a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> in the public subnet's route table to use the internet gateway.</span></span></span>
<img class="alignnone size-full wp-image-2728" src="https://skundunotes.com/wp-content/uploads/2023/07/79-image-3.png" alt="79-image-3" width="577" height="213" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <strong>user data script</strong> that the EC2 instances are using <strong>requires access to the internet</strong>, and hence I also created three elastic IP addresses in the VPC and three NAT gateways in the public subnet of the VPC. Then I attached the three NAT gateways to the three elastic IP addresses. The EC2 instances in the private subnet use the NAT gateway to communicate with the internet.</span></span></span>
<img class="alignnone size-full wp-image-2729" src="https://skundunotes.com/wp-content/uploads/2023/07/79-image-4.png" alt="79-image-4" width="594" height="233" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, I created a route in the three private subnet's route tables with a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> using the NAT gateway.</span></span></span>
<img class="alignnone size-full wp-image-2730" src="https://skundunotes.com/wp-content/uploads/2023/07/79-image-5.png" alt="79-image-5" width="562" height="121" />
<span style="text-decoration: underline"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000;text-decoration: underline">Please note that if the EC2 instances do not need to communicate with the internet to install anything, there is no need to create the three elastic IP addresses and three NAT gateways.</span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create the compute resource</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created three EC2 instances in three subnets spread across three availability zones.</span></span></span>
<img class="alignnone size-full wp-image-5841" src="https://skdevops.wordpress.com/wp-content/uploads/2023/07/79-image-6-1.png" alt="79-image-6" width="656" height="513" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also created two separate security groups, one for the application load balancer with ingress and egress for all IP addresses and the other for the EC2 instances with ingress from the load balancer security group only and egress to all IP addresses. This approach tightens up the security of the EC2 instances.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Create an Amazon S3 bucket for load balancer access logs</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>, access logs contain detailed information about requests sent to the load balancer. Each log contains information such as the time the request was received, the client's IP address, latencies, request paths, and server responses. You can use these access logs to analyze traffic patterns and troubleshoot issues.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Following the steps outlined at <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/enable-access-logging.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">enable-access-logging</span></span></span></a>, I created the S3 bucket, enabled server-side encryption, and attached a permissions policy. Amazon S3-managed keys (SSE-S3) are the only server-side encryption option supported.</span></span></span>
<img class="alignnone size-full wp-image-5843" src="https://skdevops.wordpress.com/wp-content/uploads/2023/07/79-image-8-1.png" alt="79-image-8" width="647" height="578" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please pay special attention to the policy since it depends on the region where the resources are created.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Create the application load balancer</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I created a target group and attached the three EC2 instances to the target group.</span></span></span>
<img class="alignnone size-full wp-image-5842" src="https://skdevops.wordpress.com/wp-content/uploads/2023/07/79-image-7-1.png" alt="79-image-7" width="584" height="122" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I followed that by creating an application load balancer in the public subnets in the VPC and a listener with a default action of forwarding the request to the target group.</span></span></span>
<img class="alignnone size-full wp-image-5844" src="https://skdevops.wordpress.com/wp-content/uploads/2023/07/79-image-10.png" alt="79-image-10" width="664" height="586" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also automated the process using <strong>GitHub actions pipelines with Terraform, Checkov, and Infracost</strong>. You can access the pipeline YAML files in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">.github/workflows</code> folder in the GitHub repository. GitHub Actions deployed the terraform code in this repository using the pull request-based workflow process. You can read more about that at -<a href="https://skundunotes.com/2023/07/18/implement-pull-request-based-workflow-using-terraform-infracost-checkov-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">implement pull request-based workflow using Terraform, Infracost, Checkov, and GitHub actions.</span></span></span></a></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that is all there is to create an AWS application load balancer with EC2 instances in a private subnet. I hope this note was helpful. Let me know if you have any questions.</span></span></span>
