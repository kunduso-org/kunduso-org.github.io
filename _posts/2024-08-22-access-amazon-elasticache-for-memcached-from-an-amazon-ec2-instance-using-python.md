---
title: "Access Amazon ElastiCache for Memcached from an Amazon EC2 instance using Python"
date: 2024-08-22 04:26:03 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note is the second part of my notes on Amazon ElastiCache for Memcached. In the first note, I demonstrated how to <a href="https://skundunotes.com/2024/08/16/create-amazon-elasticache-for-memcached-using-terraform-and-github-actions/" target="_blank" rel="noopener">create an Amazon ElastiCache for Memcached using Terraform</a>. In this note, I list the steps to create the additional infrastructure and <span style="text-decoration: underline">access the Memcached cluster using Python</span>.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To accomplish the use-case, I'll use the two AWS Cloud resources created in the previous note for this purpose - (a) the <code><span style="font-size: 15px"><span style="color: #0047ab">aws_ssm_parameter</span></span></code> resource that has the ElastiCache <code><span style="font-size: 15px"><span style="color: #0047ab">configuration_endpoint</span></span></code> and (b) the <code><span style="font-size: 15px"><span style="color: #0047ab">aws_iam_policy</span></span></code> that enables access to the SSM Parameter Store parameter.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">At a high level, this use case can be classified into three steps:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(1) Create the additional AWS Cloud resources to access the ElastiCache cluster.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(2) Access the ElastiCache cluster from an Amazon EC2 instance to write to the ElastiCache cluster.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(3) Access the ElastiCache cluster from an Amazon EC2 instance to read from the ElastiCache cluster.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will explain these steps in detail. If you are interested in following along, please check my repository <a href="https://github.com/kunduso/amazon-elasticache-memcached-tf/tree/main" target="_blank" rel="noopener"><code><span style="font-size: 15px"><span style="color: #0047ab">GitHub:kunduso/amazon-elasticache-memcached-tf</span></span></code></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create the additional AWS Cloud resources to access the ElastiCache cluster</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In my previous note, I discussed most of the infrastructure for this use case, such as the Amazon Virtual private cloud, subnets, route tables, security groups, Amazon ElastiCache, and the SSM parameter store to store the ElastiCache endpoint. However, since I am connecting to the ElastiCache cluster from an Amazon EC2 instance using Python, I need additional AWS cloud resources. These are:</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- an Internet Gateway and a route to the Internet,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- an IAM policy and instance profile to access the Amazon EC2 instance and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- the Amazon EC2 instances to access the ElastiCache cluster.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This use case requires Internet access for a specific purpose. Since I am using Python3 to access the Amazon ElastiCache cluster, there are particular libraries to install on the Amazon EC2 instance, such as <code><span style="font-size: 15px"><span style="color: #0047ab">python-pip</span></span></code>, <code><span style="font-size: 15px"><span style="color: #0047ab">python3</span></span></code>, <code><span style="font-size: 15px"><span style="color: #0047ab">pylibmc</span></span></code>, and <code><span style="font-size: 15px"><span style="color: #0047ab">boto3</span></span></code>. The Amazon EC2 instances require Internet access to install these libraries. That is possible by attaching an Internet Gateway to the Amazon VPC and adding a route in the route table.</span></span></span>
<img class="alignnone size-full wp-image-4658" src="https://skundunotes.com/wp-content/uploads/2024/08/100-image-1.png" alt="100-image-1" width="825" height="369" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So, if you have an Amazon machine image (AMI) with these Python libraries installed, you do not require an Internet Gateway or the route.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since I connected to the ElastiCache cluster from an Amazon EC2 instance, the instance <span style="text-decoration: underline">required specific permissions</span>. In my previous note, I created an IAM policy that had permission to access the ElastiCache endpoint stored in the SSM parameter store. I attached the IAM policy to an IAM role that the Amazon EC2 instance uses. Since I was required to access the Amazon EC2 instance via <span style="text-decoration: underline">Session Manager</span>, I also attached an AWS-managed policy to the IAM role.</span></span></span>
<img class="alignnone size-full wp-image-4659" src="https://skundunotes.com/wp-content/uploads/2024/08/100-image-2.png" alt="100-image-2" width="1218" height="624" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last AWS cloud resources are the two Amazon EC2 instances. My idea was to create two Amazon EC2 instances, one to write into the ElastiCache cluster and the other to read from the ElastiCache cluster. Using the user data script, I created a Python file and stored it in the <code><span style="font-size: 15px"><span style="color: #0047ab">var</span></span></code> folder of the two Amazon EC2 instances. Hence, both the Amazon EC2 instances use separate user data scripts. I also passed the ElastiCache endpoint address to the Python file. Below is an image of one of the Amazon EC2 instances' Terraform code.</span></span></span>
<img class="alignnone size-full wp-image-4660" src="https://skundunotes.com/wp-content/uploads/2024/08/100-image-3.png" alt="100-image-3" width="1049" height="678" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These were all the additional AWS cloud resources required for this use case. I checked-in my code and merged it with the <code><span style="font-size: 15px"><span style="color: #0047ab">main</span></span></code> branch. That triggered the GitHub Actions pipeline and provisioned all the AWS cloud resources.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After all the cloud resources were provisioned, I waited an additional 5 minutes since the Amazon EC2 instances had the user data script to run, install a few packages, and create the Python file.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Access the ElastiCache cluster from an Amazon EC2 instance to write to the ElastiCache cluster</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I selected the Amazon EC2 instance named <code><span style="font-size: 15px"><span style="color: #0047ab">app-10-write-instance</span></span></code> and clicked the Connect button to connect via Session Manager. I could log into the Amazon EC2 instance since I had the correct AWS-managed policy and appropriate security group rule attached to it. You can read more about that at <a href="https://skundunotes.com/2023/08/27/provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform/" target="_blank" rel="noopener">provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform</a>. In particular, read about the Security Group attached to the Amazon EC2 instance since no <code><span style="font-size: 15px"><span style="color: #0047ab">ingress</span></span></code> </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">rule is associated.</span></span></span>
<img class="alignnone size-full wp-image-4661" src="https://skundunotes.com/wp-content/uploads/2024/08/100-image-4.png" alt="100-image-4" width="759" height="191" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After logging in, I navigated to the <code><span style="font-size: 15px"><span style="color: #0047ab">var</span></span></code> folder and ran the <code><span style="font-size: 15px"><span style="color: #0047ab">ls</span></span></code> command. I could see the user data generated <code><span style="font-size: 15px"><span style="color: #0047ab">write_cache.py</span></span></code> file. I ran <code><span style="font-size: 15px"><span style="color: #0047ab">python3 write_cache.py</span></span></code>, which prompted me to enter a City name.</span></span></span>
<img class="alignnone size-full wp-image-4662" src="https://skundunotes.com/wp-content/uploads/2024/08/100-image-5.png" alt="100-image-5" width="734" height="147" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last message confirmed the information was successfully stored in the ElastiCache cluster using the Python code.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Access the ElastiCache cluster from an Amazon EC2 instance to read from the ElastiCache cluster</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I repeated the same steps on the other Amazon EC2 instances—<code><span style="font-size: 15px"><span style="color: #0047ab">app-10-read-instance</span></span></code>—and logged in via Session Manager. Then, I navigated to the <code><span style="font-size: 15px"><span style="color: #0047ab">/var</span></span></code> folder and ran the Python file <code><span style="font-size: 15px"><span style="color: #0047ab">python3 read_cache.py</span></span></code>. The correct value was printed. As part of the execution, the Python script connected to the ElastiCache cluster and read the value the other Python script wrote.</span></span></span>
<img class="alignnone size-full wp-image-4663" src="https://skundunotes.com/wp-content/uploads/2024/08/100-image-6.png" alt="100-image-6" width="706" height="133" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can iterate through Steps 2 and 3 multiple times with different values.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. I recommend you <code><span style="font-size: 15px"><span style="color: #0047ab">cat</span></span></code> open the two Python files to review their contents. You will see that the files do not contain any sensitive value, such as the ElastiCache endpoint. Access to the endpoint value is managed via the IAM role attached to the Amazon EC2 instance.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to learn how to connect to an Amazon ElastiCache for Redis, you can examine <a href="https://skundunotes.com/2023/12/13/connect-to-an-amazon-elasticache-cluster-from-an-amazon-ec2-instance-using-python/" target="_blank" rel="noopener">connect-to-an-amazon-elasticache-cluster-from-an-amazon-ec2-instance-using-python</a>. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note helpful. Let me know if you have any questions or suggestions.</span></span></span>
