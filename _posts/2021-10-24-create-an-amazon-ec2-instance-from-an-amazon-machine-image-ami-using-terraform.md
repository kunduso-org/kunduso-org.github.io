---
title: "Create an Amazon EC2 instance from an Amazon Machine Image (AMI) using Terraform"
date: 2021-10-24 07:00:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">
A few weeks ago, I worked on a use case to create an Amazon EC2 instance from an Amazon Machine Image using Terraform. I had worked on that concept without automation, and my approach was to (i) identify an AMI and (ii) create an instance out of that AMI. I'll cover the network bits to host the VM in a separate note.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To manually create an EC2 using the AWS console, (a) navigate to EC2 (under Services) -&gt; Images -&gt; AMIs, (b) set the filter to Pubic images (default is Owned by me ), (c) add a filter for the AMI Name: <em>&lt;enter image name&gt;</em> or <em>&lt;enter some keyword that uniquely identifies the image&gt;</em> for e.g. "AMI Name: Windows". A list of all images that match the AMI Name criteria is displayed with the AMI ID. The other option is to select the AMI from the EC2 dashboard -&gt; Instances - Click on "Launch Instances" and then select the AMI as part of creating a virtual machine. Under either option, I could access the AMI and use it to launch an EC2 instance.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, I was required to use Terraform to create an Amazon EC2 instance. Although the approach was the same: (i) use a data source to identify the AMI uniquely, and (ii) create an Amazon EC2 instance using the AMI.</span></span></span>
<img class="alignnone size-full wp-image-1517" src="https://skundunotes.com/wp-content/uploads/2021/10/52.image-2.png" alt="52.Image-2" width="417" height="304" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Using the <strong>"data source,"</strong> the idea was to filter out a particular AMI. <strong>But how would I know what value to fill under the name filter such that the result is only one AMI?</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Enter AWS CLI.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">My objective was to access the name of the AMI. The command is <code>aws ec2 describe-images</code>. More info at <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/describe-images.html" target="_blank" rel="noopener"><span style="text-decoration: underline">AWS-Docs</span></a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I knew my requirement was a Windows Server, and hence, I started with the following command: <code>aws ec2 describe-images --owners amazon --region us-east-2 --filters "Name=name,Values=*Windows*" --query 'Images[*].[Name]' --output text</code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The output was a long list of the AMI image names. But that gave me some leads to work on. I saw the pattern of the name was <code>Windows_Server-YYYY</code> in the list, and so at the next run, I updated the command to: <code>aws ec2 describe-images --owners amazon --region us-east-2 --filters "Name=name,Values=*Windows_Server-2019*" --query 'Images[*].[Name]' --output text</code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The output was shorter than that of the previous run. And hence, with each iteration of running the command, I updated the <code>Name</code> value such that the output was down to multiple versions of the same instance; the last version of the command was: <code>aws ec2 describe-images --owners amazon --region us-east-2 --filters "Name=name,Values=Windows_Server-2019-English-Full-Base-2021*" --query 'Images[*].[Name]' --output text</code></span></span></span>
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> I could have gone specific on the "values" and removed the "*" from the name, but since I was using the <code>most_recent = true</code> flag in the <code>data "aws_ami" "windows-ami"</code> source block, it was fine. The AWS CLI helped me identify the value that would go into the name filter. With that information, the data source block looked as below.</span></span></span></em>
<img class="alignnone size-full wp-image-1518" src="https://skundunotes.com/wp-content/uploads/2021/10/52.image-3.png" alt="52.Image-3" width="479" height="308" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And the Amazon EC2 instance block was as belowâ€”nothing fancy there. I was using the AMI that I selected from the data source above.</span></span></span>
<img class="alignnone size-full wp-image-1519" src="https://skundunotes.com/wp-content/uploads/2021/10/52.image-4.png" alt="52.Image-4" width="487" height="216" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this helpful note. Do you know an efficient way to identify the AMI name without going through the AWS CLI? Would you mind sharing that in the comments, please?</span></span></span>
