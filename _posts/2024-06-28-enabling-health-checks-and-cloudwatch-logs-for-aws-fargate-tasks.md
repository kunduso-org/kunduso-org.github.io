---
title: "Enabling Health Checks and CloudWatch Logs for AWS Fargate Tasks"
date: 2024-06-28 01:06:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In Amazon Elastic Container Service (ECS), <span style="text-decoration: underline">HealthCheck</span> is a mechanism for monitoring the health status of containerized applications running in tasks. It helps ensure that <span style="text-decoration: underline">only healthy containers</span> (with health check passing) serve traffic and unhealthy containers are replaced automatically. Configuring the ECS Managed Healthcheck is crucial for maintaining the <span style="text-decoration: underline">availability, reliability, and scalability</span> of your containerized applications running on ECS Fargate.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So that we're on the same page, Amazon ECS is a fully managed container orchestration service that helps development teams deploy, manage, and scale containerized applications. AWS Fargate is a technology that can be used with Amazon ECS to run <a href="https://aws.amazon.com/what-are-containers" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">containers</span></span></span></a> without managing servers or clusters of Amazon EC2 instances. <strong>AWS Fargate</strong> supports the Amazon ECS Managed <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_HealthCheck.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">HealthCheck</span></span></span></a>, a built-in health check provided by Amazon ECS. With this health check, ECS periodically sends a ping (HTTP, HTTPS, or gRPC) to a specific endpoint into the container, and if the container responds successfully, it is considered healthy.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I explain how to (a) <span style="text-decoration: underline">add a health check</span> to the AWS Fargate task and (b) <span style="text-decoration: underline">monitor the health check logs</span> with Amazon CloudWatch.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I built on the concepts discussed in <a href="https://skundunotes.com/2024/05/06/continuous-deployment-of-amazon-ecs-service-using-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">deploying an Amazon ECS service using Terraform</span></span></span></a>. Hence, it will be helpful if you read that note first. If you are interested and want to follow along, here is a link to my code repository on <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/tree/create-ecs-service" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub: kunduso/add-aws-ecr-ecs-fargate</span></span></span></a>.</span></span></span><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000"> Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = create-ecs-service</code>.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Add HealthCheck to the AWS Fargate task</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To enable HealthCheck, I first added a file inside the Docker image at a specific location (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/route/healthcheck.js</code>), and then updated the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">healthCheck</code> configuration in the Amazon ECS task definition to run the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">curl</code> command.</span></span></span>
<img class="alignnone size-full wp-image-4244" src="https://skundunotes.com/wp-content/uploads/2024/06/94-image-1.png" alt="94-image-1" width="1051" height="219" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The application is hosted on port# 8080, and a health check file exists in the folder. Also, if you examine, the contents of the CURL command are written into the docker logs folder (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/proc/1/fd/1</code>). The logs that are written into the path <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/proc/1/fd/1</code> are redirected to Amazon CloudWatch because of the log configuration settings in the Amazon ECS task definition.</span></span></span>
<img class="alignnone size-full wp-image-4245" src="https://skundunotes.com/wp-content/uploads/2024/06/94-image-2.png" alt="94-image-2" width="781" height="244" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Monitor logs with Amazon CloudWatch</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once the AWS Fargate task is deployed and after the service comes up, you'll see the container Health status as "<strong><span style="color: #05ac26">Healthy</span></strong>."</span></span></span>
<img class="alignnone size-full wp-image-4246" src="https://skundunotes.com/wp-content/uploads/2024/06/94-image-3.png" alt="94-image-3" width="1276" height="531" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the AWS Console, I searched for Amazon CloudWatch, navigated to Log Groups (under Logs), and chose <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/amazon-ecs/app-6/log</code>. That is the name of the Amazon CloudWatch log group created as part of infrastructure deployment, which was discussed in detail at <a href="https://skundunotes.com/2024/04/10/create-infrastructure-to-host-an-amazon-ecs-service-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">deploy-ecs-infrastructure</span></span></span></a>. Under the log group, there were two log streams, one for each container, with log messages such as the one below:</span></span></span>
<img class="alignnone size-full wp-image-4247" src="https://skundunotes.com/wp-content/uploads/2024/06/94-image-4.png" alt="94-image-4" width="1210" height="287" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The container's health check command posts a new message to the log stream every 30 seconds. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that is how to enable and monitor health checks in AWS Fargate tasks.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are some necessary features of the ECS Managed HealthCheck in AWS Fargate tasks that you must understand before using it:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1. Configuration:</strong> The health check is configured in the healthCheck section of the AWS Fargate task definition. You can specify the protocol (HTTP, HTTPS, or gRPC), port, path, interval, timeout, and other settings.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2. Load Balancing:</strong> When you use an Elastic Load Balancing (ELB) service with AWS Fargate tasks, the load balancer routes traffic only to healthy containers based on the health check status. Unhealthy containers are automatically removed from the load balancer's target group.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3. Container Replacement:</strong> If a container becomes unhealthy (based on the health check), Amazon ECS automatically stops the unhealthy task and starts a new task to replace it. This feature ensures that your application remains available and responsive.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4. Auto Scaling:</strong> When using Auto Scaling with AWS Fargate service, health checks help determine when to scale out (add more tasks) or scale in (remove tasks) based on the number of healthy and unhealthy containers.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5. Monitoring and Alerting:</strong> You can monitor the health check status of your containers using Amazon CloudWatch metrics or other monitoring tools, which can trigger alerts if containers become unhealthy.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"> Please note that as of May 2024, <span style="text-decoration: underline">ECS Managed Healthcheck</span> is the only health check mechanism available for AWS Fargate tasks. AWS Fargate does not support Docker container health checks defined in the Dockerfile. Also, please note that not all Docker images come with the CURL utility, and you might have to add an installation step to the Dockerfile.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope this note will be helpful when you configure a health check for your Amazon ECS Fargate task the next time. Let me know if you have any questions or suggestions.</span></span></span>
