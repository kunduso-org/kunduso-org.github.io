---
title: "Create infrastructure to host an Amazon ECS Service using Terraform"
date: 2024-04-11 02:49:13 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This is the first part of an umbrella note in which I describe how to create and deploy an Amazon ECS service using Terraform and GitHub Actions.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The cloud engineering team must provision particular AWS cloud services before hosting a container in <strong>Amazon ECS</strong>. In this note, I list all the required AWS services, their specific properties, and how to create them using Terraform.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>, <strong>Amazon ECS</strong> is a fully managed container orchestration service that helps you easily deploy, manage and scale containerized applications. It hosts one or more Docker images as container(s) in an Amazon ECS <strong>Cluster</strong> as one or more tasks or services. Per <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/clusters.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>, an Amazon ECS cluster is a <span style="text-decoration: underline">logical grouping of tasks or services</span>. It requires a <strong>VPC</strong> where the tasks and services run. These tasks or services are created from a <strong>task definition</strong>. The task definition also contains the metadata about the task/service, such as the number of containers, port-mapping, memory, the environment variables, and the Docker image source, which, in our case, is<strong> Amazon ECR</strong>. Amazon ECR is a managed AWS Docker registry service that stores images. You may find more information at <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecr-repositories.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Architecture Decision</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Depending on your use case, you may provision more AWS cloud services. In my case, I attached a <strong>load balancer</strong> to the Amazon ECS service and, hence, required that along with a target group and listener. Since this was an external-facing load balancer, I hosted that in (public) subnets attached to a route table with a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> (the internet) using the internet gateway. I was required to create the Amazon ECS service in private subnets to make the architecture secure. A private subnet is a subnet that is not attached to a route table with a route to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> (the internet). The Amazon ECS service requires access to Amazon ECR and Amazon S3 to pull the Docker image layers and Amazon CloudWatch for container logging. Hence, to access these from the private subnet, I created VPC endpoints to Amazon ECR, S3, and CloudWatch, along with the private subnet's route table changes. If I were required to host the Amazon ECS service in a public subnet and assign a public IP address to the service, these VPC endpoints would not be necessary since Amazon ECS could access these services via the internet gateway.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Tying all of these together, you will notice that all these specific AWS cloud services can exist <strong>before a service is hosted on Amazon ECS</strong>. These are Amazon VPC, subnets, route tables, internet gateway, security group, VPC endpoints, an Amazon ECS cluster, Amazon ECR, a load balancer, a target group, and a listener. At a secondary level, there are additional AWS services like <strong>AWS KMS Key</strong> and <strong>Amazon CloudWatch log group</strong> to encrypt the data and store the logs.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will list these AWS cloud resources and show you how to create them using Terraform. I also list the specific properties of these AWS cloud services and why they are necessary. If you want to follow along, here is a link to the Terraform code in my <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/tree/create-ecs-service/infra" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub repository and folder: kunduso/add-aws-ecr-ecs-fargate</span></span></span></a>. I also automated the process using the GitHub Actions pipeline, which you may access at: <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/blob/create-ecs-service/.github/workflows/terraform.yml" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">terraform.yml</span></span></span></a>. </span></span></span><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000">Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = create-ecs-service</code>.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create AWS KMS key and policy</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS KMS key encrypts the data stored in the Amazon CloudWatch logs and the Docker image stored in the Amazon ECR repository. By encrypting the data, we ensure that only those with the key can access it.</span></span></span>
<img class="alignnone size-full wp-image-3625" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-2.png" alt="90-image-2" width="746" height="448" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create an Amazon CloudWatch log group</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The log group stores messages from the Amazon ECS service. These messages are log information, which is helpful during review and debugging.</span></span></span>
<img class="alignnone size-full wp-image-3626" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-3.png" alt="90-image-3" width="612" height="124" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create the network components</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The network components include the Amazon VPC, public and private subnets, route tables, routes, and internet gateway. These resources are standard; however, I set two VPC properties to true. You can read them at <a href="https://docs.aws.amazon.com/glue/latest/dg/set-up-vpc-dns.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs: Setting Up DNS in Your VPC</span></span></span></a>.</span></span></span>
<img class="alignnone size-full wp-image-3670" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-4-1.png" alt="90-image-4" width="574" height="616" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If interested, you can read more about Amazon VPC, subnets, route tables, route table associations, internet gateway, and routes in a route table at  -<a href="https://skundunotes.com/2021/11/01/create-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff"> create Amazon EC2 using Terraform</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create security groups and rules</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Two security groups are required for this use case: one to <span style="text-decoration: underline">enable traffic flow</span> to the load balancer and the other for the VPC endpoints. The ports and CIDRs are different for both security groups. For ease of management, I created separate<span style="text-decoration: underline"> security group rules</span> rather than inline rules with the security group.</span></span></span>
<img class="alignnone size-full wp-image-3672" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-9.png" alt="90-image-9" width="785" height="703" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Create VPC endpoints</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This use case requires <span style="text-decoration: underline">four VPC endpoints</span>: two ECR interface endpoints, one CloudWatch interface endpoint, and one Gateway endpoint for Amazon S3. I created the VPC endpoints and attached the VPC endpoint security group with the three interface endpoints and a private subnet route table associated with the Gateway endpoint for Amazon S3.</span></span></span>
<img class="alignnone size-full wp-image-3671" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-8.png" alt="90-image-8" width="924" height="514" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Create an Amazon ECR repository</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon ECR repository is where the (Docker) container images are stored.</span></span></span>
<img class="alignnone size-full wp-image-3628" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-5.png" alt="90-image-5" width="525" height="172" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">image_tag_mutability</code> property states whether the same image tag can be reused. Setting it to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">IMMUTABLE</code> = same image tag cannot be reused.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 7: Create an Amazon ECS Cluster</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon ECS cluster is a logical grouping of tasks or services to be created before hosting them. While creating the ECS cluster, I enabled and added the logging configuration to direct the task or service logs to the Amazon CloudWatch log group.</span></span></span>
<img class="alignnone size-full wp-image-3629" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-6.png" alt="90-image-6" width="722" height="466" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 8: Create the load balancer, target group, and listener</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created an Amazon ECS service with a couple of tasks that served a static page and placed a load balancer in front to toggle traffic between the two tasks. Hence, I required a load balancer, target group, and listener.</span></span></span>
<img class="alignnone size-full wp-image-3677" src="https://skundunotes.com/wp-content/uploads/2024/04/90-image-7-1.png" alt="90-image-7" width="817" height="342" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For a detailed explanation of the load balancer, target group, and listener, refer to my previous note  -<a href="https://skundunotes.com/2022/07/30/add-an-application-load-balancer-to-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add an application load balancer to Amazon EC2 using Terraform</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of this note. Once all these AWS cloud resources are provisioned, developers can start developing containerized applications and storing the Docker image in Amazon ECR.</span></span></span>
