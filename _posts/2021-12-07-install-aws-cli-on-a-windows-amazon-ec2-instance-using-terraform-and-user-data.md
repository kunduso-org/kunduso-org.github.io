---
title: "Install AWS CLI on a Windows Amazon EC2 instance using Terraform and user data"
date: 2021-12-07 11:59:31 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the last post, I discussed the steps involved in installing <span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/19/install-aws-tools-module-for-powershell-on-aws-ec2-using-user-data-and-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS.Tools module for PowerShell on Amazon EC2 using user data and Terraform</span></span></span></a></span>. This post lists the steps to install the AWS CLI on an Windows Amazon EC2 instance.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used Amazon EC2 user data and Terraform to automate AWS CLI installation as part of the Amazon EC2 provisioning process. Moreover, I prefer to have the user data script be persistent (starts each time after a machine restart). <strong>Hence, all the functions within the user data script must be idempotent, including the AWS CLI installation.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to the Amazon EC2 user data script, I have a separate note to discuss <span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/07/working-with-aws-ec2-user-data-and-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">the steps to start using the user data script -working with Amazon EC2 user data and Terraform</span></span></span></a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To install AWS CLI and to make the process idempotent, I classified it into the following steps:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> Check if AWS CLI was installed. If installed, do nothing.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The idea behind this step is due to the need to create idempotent scripts. If the desired end state (AWS CLI installed) is achieved, do not download the installer or proceed with the installation.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> If AWS CLI is not installed, install the latest version and restart the Amazon EC2 instance.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I first downloaded the installer and then used the PowerShell <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">Start-Process</code> block with the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000"> -Wait</code> flag to install the CLI. After that, I set the flag value <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">InstallAWSFlag.txt</code> to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">true</code>. A machine restart followed this. If you wonder about the need to restart the Amazon EC2 instance, there is no need. You see, as part of successful install verification, <em>I could not identify a method to check for the AWS CLI version right after the installation since the PowerShell instance does not have the environment variables updated.</em> A new PowerShell instance would have that, but I could not find a way to manage that using the user data script. A quicker approach was to trigger a machine restart which caused the user data script to rerun, and the condition under Step 1 was fulfilled.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I applied the logic associated with the algorithm in the user data script (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">user_data\user_data.tpl</code>) and stored it in my Github repo: <span style="text-decoration: underline"><a href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-awscli-to-userdata" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add-aws-cli-to-userdata</span></span></span></a></span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is an image from the user data log file generated by the user data script when Terraform provisioned the Amazon EC2 instance and after each restart.</span></span></span>

<img class="alignnone size-full wp-image-1643" src="https://skundunotes.com/wp-content/uploads/2021/12/58.image-2.png" alt="58.Image-2" width="841" height="566" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see, the identification of the AWS CLI version took place after a machine restart.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that is how I installed the AWS CLI and ran a few AWS CLI commands from the Amazon EC2 instance. If you want to know more, I have two more related notes on the user data script that you will find interestingÂ  - <span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/16/attach-iam-role-to-aws-ec2-instance-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">How to attach an IAM role to an Amazon EC2 instance</span></span></span></a></span> and <span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/17/manage-sensitive-variables-in-aws-ec2-user-data-with-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">how to manage sensitive variables in the user data script</span></span></span></a></span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note useful. Please do not hesitate to reach out with your suggestion or comments.</span></span></span>
