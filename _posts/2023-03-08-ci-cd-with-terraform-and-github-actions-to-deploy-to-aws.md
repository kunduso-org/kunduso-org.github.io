---
title: "CI-CD with Terraform and GitHub Actions to deploy to AWS"
date: 2023-03-08 01:10:22 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">GitHub Actions is a CI/CD tool that can automate the provisioning of AWS resources using Terraform. Previously, I wrote a detailed post explaining the concepts associated with using Terraform to create an application load balancer that you can read here -<a href="https://skundunotes.com/2022/07/30/add-an-application-load-balancer-to-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add an application load balancer to Amazon EC2 using Terraform</span></span></span></a>. In this note, I further automate the provisioning of all the AWS resources using <strong>Terraform and GitHub Actions</strong>.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Provisioning a Terraform resource consists of the following <strong>four steps</strong>:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Initialize the repository (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform init</code>) with appropriate provider versions,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. (Optionally) format (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform fmt</code>) and validate (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform validate</code>) the code,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Plan (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform plan</code>), and finally,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Apply (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform apply</code>) the changes stated in the Terraform configuration files.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the past, I've used<span style="text-decoration: underline"> Azure Pipelines to automate the same</span>, and if you are interested, you can read that at -<a href="https://skundunotes.com/2021/02/17/azure-pipelines-yaml-and-terraform-to-provision-aws-s3/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">azure-pipelines-yaml-and-terraform-to-provision-aws-s3</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In GitHub actions, <strong>the process mostly stays the same compared to the manual process</strong>. The few differences are in how you <strong>authenticate GitHub Actions</strong> to communicate with your AWS account to provision resources and an automation step, namely, <strong>updating the pull request</strong>. To create a secure process, I stored the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">ARN</code> of the IAM role (<strong>OpenID Connect</strong>) as a secret in this GitHub repository and then accessed via the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">secrets.IAM_ROLE</code> <a href="https://github.com/kunduso/add-aws-elb-ec2-terraform/blob/9fa61ad4792c73f233eb1dccb61c477c957d4cdb/.github/workflows/terraform.yml#L33-L38" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">construct</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I based my note on the learnings I found on <a href="https://developer.hashicorp.com/terraform/tutorials/automation/github-actions" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">this tutorial from HashiCorp</span></span></span></a>, which is <span style="text-decoration: underline">helpful and well-described</span>. Since I was not using the Terraform cloud account, the only little change I made was -how I authenticated to GitHub actions.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I covered the <strong>authentication concept in a separate detailed note</strong>, <a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">securely-integrate-aws-credentials-with-github-actions-using-openid-connect</span></span></span></a> which you <span style="text-decoration: underline">must understand</span> before using the Terraform configuration stack that I have in my repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A couple of essential items in the GitHub Actions YAML file to note are as follows:</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Item#1: Enable GitHub Actions to acquire the below three permissions.</span></span></span></strong>
<img class="alignnone size-full wp-image-2348" src="https://skundunotes.com/wp-content/uploads/2023/03/72-image-2.png" alt="72-image-2" width="490" height="118" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These permissions enable GitHub actions to read the Terraform configuration files, write the authentication token( as part of using the Open ID connect approach), and write to the pull request (the output of the terraform plan step).</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Item#2: Terraform plan runs only under two conditions.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see from the image below, there are only two conditions for the terraform plan command to run.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">When the (i) branch is not equal to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">main</code>, and (ii) when the event is a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">pull_request</code>.</span></span></span>
<img class="alignnone size-full wp-image-2349" src="https://skundunotes.com/wp-content/uploads/2023/03/72-image-3.png" alt="72-image-3" width="937" height="157" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As a developer, I write the Terraform configuration to provision resources. And as best practice, I commit the code, not on the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">main</code> branch. As I create the Terraform configurations, I need feedback to check if the code is correct. I get that when I push my code to GitHub, which triggers this pipeline. And since I am not working off the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">main</code> branch, the Terraform Plan step is executed. And in case of a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">pull request</code>, this step is necessary since the <span style="text-decoration: underline">PR reviewer needs to see the plan file to evaluate whether to approve or reject the pull request.</span></span></span></span>
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: An option to get quick feedback if my Terraform configuration is correct is to run <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform plan</code> from my local before pushing the code to GitHub, but that would require me to store credentials on my local (laptop), which I could not do in this case.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And finally, here is a link to my <strong>GitHub repository: <a href="https://github.com/kunduso/add-aws-elb-ec2-terraform" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add-aws-elb-ec2-terraform</span></span></span></a></strong>, where I have the <a href="https://github.com/kunduso/add-aws-elb-ec2-terraform/blob/main/.github/workflows/terraform.yml" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub Actions file</span></span></span></a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can also check the <strong>GitHub Actions workflow to review the build logs</strong> for this Terraform project at <a href="https://github.com/kunduso/add-aws-elb-ec2-terraform/actions" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub-actions</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope this note was helpful, and let me know if you have any questions or suggestions. And although I worked with an application load balancer in AWS in this use case,<span style="text-decoration: underline"> you can provision any AWS resource using the above approach with GitHub Actions. </span></span></span></span>
