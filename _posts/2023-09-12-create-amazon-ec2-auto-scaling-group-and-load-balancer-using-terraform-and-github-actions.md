---
title: "Create Amazon EC2 Auto Scaling group and load balancer using Terraform and GitHub Actions"
date: 2023-09-12 10:16:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">When project teams host an application or service on an Amazon EC2 instance, they have specific questions about the underlying infrastructure. A few of them could be:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(a) Can the project team be assured that if some or all existing EC2 instances were terminated or unresponsive, new Amazon EC2 instances (with the application hosted) would be <strong>auto-created</strong>?</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(b) Can the number of Amazon EC2 instances scale based on <strong>metrics</strong> like CPU? Add more instances when the<strong> load is high</strong> and decrease them when it is low. Click <a href="https://skundunotes.com/2023/09/27/create-an-amazon-ec2-auto-scaling-group-with-metric-scaling-policies-using-terraform/" target="_blank" rel="noopener">here to read</a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(c) Can the project team implement a <strong>zero downtime deployment</strong> of the application hosted on Amazon EC2 instances? Click <a href="https://skundunotes.com/2023/10/05/trigger-instance-refresh-of-amazon-ec2-auto-scaling-group-with-a-launch-template-update-using-terraform/" target="_blank" rel="noopener">here to read.</a></span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Amazon EC2 Auto Scaling group</strong> is the answer to the use cases above. Per <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-groups.html" target="_blank" rel="noopener">AWS-Docs</a>, an Auto Scaling group contains a collection of EC2 instances that are treated as a logical grouping for the purposes of automatic scaling and management. An Auto Scaling group also lets you use Amazon EC2 Auto Scaling features such as health check replacements and scaling policies.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the following paragraphs, I explain creating an Amazon EC2 Auto Scaling group with Terraform. Toward the end, I also have a link to an article demonstrating how to automate the process using GitHub Actions.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In my previous note, I described how to <a href="https://skundunotes.com/2023/07/26/attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet/" target="_blank" rel="noopener">host a few EC2 instances in a private subnet and attach them to an application load balancer in a public subnet</a>. Compared to that stack, everything remains the same except for the EC2 instances that I replaced with an Amazon EC2 Auto Scaling group and the load balancer attachment. I have the code committed to my <strong><a href="https://github.com/kunduso/add-asg-elb-terraform" target="_blank" rel="noopener">GitHub repository: add-asg-elb-terraform</a></strong>, and you can follow along if you are interested.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Creating an Amazon EC2 Auto Scaling group involves creating two resource types in Terraform. They are the <code>aws_launch_template</code> and the <code>aws_autoscaling_group</code>. However, at a higher level, this use case has four essential infrastructure components. These are:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create the network stack</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create the launch template</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Create the autoscaling group from the launch template</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Create the load balancer's target group and attach it to the autoscaling group</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let us thoroughly explore these infrastructure components, beginning with the network stack.</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create the network stack</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created the Amazon EC2 Auto Scaling group in the private subnet spread over three availability zones in a VPC. If you want to learn about that networking stack hosting the Amazon EC2 Auto Scaling group, head to <a href="https://skundunotes.com/2023/07/26/attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet/" target="_blank" rel="noopener">this note</a> and focus on section  -<em>1. Create the network stack section</em>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create the launch template</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The launch template contains the meta-data of the Amazon EC2 Auto Scaling group, like the AMI image id, the instance type to host the AMI, the user data script to run after provisioning the EC2 instance, etc. Head to the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template" target="_blank" rel="noopener">official Terraform registry page</a> for an updated list of all the supported properties. As you can see from the image below, in my code, I provided the details with a few additional information, like the security group to attach with the EC2 instances and the IAM profile to attach with the EC2 instances. Attaching the IAM instance profile is optional.</span></span></span>
<img class="alignnone size-full wp-image-2860" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-1.png" alt="82-image-1" width="780" height="369" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Create the autoscaling group from the launch template</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Amazon EC2 Auto Scaling group creates Amazon EC2 instances from the launch template configurations. It does this by referencing the launch template ID and version to use, the number of instances to create, the subnet to host the Amazon EC2 instances, etc. Please refer to the<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group" target="_blank" rel="noopener"> official Terraform registry page</a> for a detailed note on these options.</span></span></span>
<img class="alignnone size-full wp-image-2861" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-2.png" alt="82-image-2" width="536" height="636" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are additional values like the <code>lifecycle ignore_changes</code> and the <code>instance_refresh</code> configuration values. The <code>lifecycle</code> block specifies that the autoscaling group should not scale down the instances if a scale-out activity is in effect while redeploying. Similarly, the <code>instance_refresh</code> property ensures that newer instances are rolled out when a more recent version of the <code>launch_template</code> is available.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Create the load balancer's target group and attach it to the autoscaling group</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I borrowed from section 3. Create the application load balancer of my note  <a href="https://skundunotes.com/2023/07/26/attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet/" target="_blank" rel="noopener">-attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet</a>. The only difference is that the resource type is <code>aws_autoscaling_attachment</code>.</span></span></span>
<img class="alignnone size-full wp-image-2862" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-3.png" alt="82-image-3" width="1185" height="288" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also <strong>automated</strong> the provisioning of the AWS resources using <strong>GitHub Actions</strong>. If you want to learn how I managed the authentication process, head over to this note  -<a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener">securely-integrate-aws-credentials-with-github-actions-using-openid-connect</a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also scanned my code for vulnerabilities using Bridgecrew Checkov, which generated a scan report. Here is a note on <a href="https://skundunotes.com/2023/04/12/automate-terraform-configuration-scan-with-checkov-and-github-actions/" target="_blank" rel="noopener">how to enable Checkov with GitHub Actions</a>. I'm also interested in the cost of these resources and use Infracost for that, which I have covered in detail in this note  -<a href="https://skundunotes.com/2023/07/17/estimate-aws-cloud-resource-cost-with-infracost-terraform-and-github-actions/" target="_blank" rel="noopener">estimate AWS resource cost</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once I had added all the resources and their configurations to my Terraform code, I pushed the changes to my remote repository and created a pull request (<a href="https://github.com/kunduso/add-asg-elb-terraform/pull/15" target="_blank" rel="noopener">open link</a>). Since I had the Checkov and Infracost integrations, I learned about the coding violation and the cost of the infrastructure stack in the pull request. Here is a link to the pull request comment for Infracost (<a href="https://github.com/kunduso/add-asg-elb-terraform/pull/15#issuecomment-1712260413" target="_blank" rel="noopener">open link</a>) and the coding violations report (<a href="https://github.com/kunduso/add-asg-elb-terraform/pull/15#pullrequestreview-1618364372" target="_blank" rel="noopener">open link</a>).</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After I merged the pull request into the <code>main</code> branch, the GitHub Actions workflow started with the command <code>terraform apply</code> enabled. At the end of a successful GitHub Actions automation, the output was in <a href="https://github.com/kunduso/add-asg-elb-terraform/actions/runs/6126819407/job/16631580307" target="_blank" rel="noopener">the logs</a>:</span></span></span>
<img class="alignnone size-full wp-image-2863" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-4.png" alt="82-image-4" width="786" height="175" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the AWS Console, I navigated to EC2 -&gt; Instances -&gt; Launch Templates and found that Terraform created the launch template with the desired specifications.</span></span></span>
<img class="alignnone size-full wp-image-2864" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-5.png" alt="82-image-5" width="1246" height="231" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And the same for the Auto Scaling Group (EC2 -&gt; Auto Scaling -&gt; Auto Scaling Groups).</span></span></span>
<img class="alignnone size-full wp-image-2865" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-6.png" alt="82-image-6" width="1372" height="185" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, I selected the Auto Scaling group, navigated under the Activity tab, and reviewed the Amazon EC2 instances creation and addition process to the load balancer's target group.</span></span></span>
<img class="alignnone size-full wp-image-2867" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-8.png" alt="82-image-8" width="1336" height="635" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And finally, when I navigated to EC2 -&gt; Instances -&gt; Instances, I saw the three Amazon EC2 instances.</span></span></span>
<img class="alignnone size-full wp-image-2866" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-7.png" alt="82-image-7" width="1120" height="131" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I pasted the GitHub Actions output on a browser, and at each refresh, there was a "Hello World" message from a different EC2 instance. Below is an example of one of them.</span></span></span>
<img class="alignnone size-full wp-image-2868" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-9.png" alt="82-image-9" width="1065" height="175" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">At this point, you might have a question  -<strong><em>How different is this Auto Scaling group setup compared to hosting the Amazon EC2 setup I previously had?</em></strong> To understand that, <span style="text-decoration: underline">terminate</span> one of the EC2 instances from the AWS Console (select any EC2  -&gt; Instance state  -&gt; Terminate instance). After a few seconds, when you refresh the URL, you will notice that the link hovers between the two active EC2 instances (instead of the three earlier).</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you navigate the Auto Scaling group page, you will notice some activity similar to the one below.</span></span></span>
<img class="alignnone size-full wp-image-2869" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-10.png" alt="82-image-10" width="1331" height="129" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Similarly, in the EC2 Instances section, you'll notice that a <span style="text-decoration: underline">new EC2 is initialized</span> in the <span style="text-decoration: underline">same availability zone</span> as the previous (terminated) instance.</span></span></span>
<img class="alignnone size-full wp-image-2870" src="https://skundunotes.com/wp-content/uploads/2023/09/82-image-11.png" alt="82-image-11" width="1155" height="171" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After a few minutes, you'll notice that the new Amazon EC2 instance is part of the Load Balancer's target group ( check EC2 -&gt;Load Balancing -&gt; Target Groups).</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And on each URL refresh, the new instance's webpage is added to the existing two. <strong>So, that is how hosting an application in an Auto Scaling group differs from hosting it on an Amazon EC2 instance.</strong> We observed this behavior because the <code>desired_capacity</code> of the autoscaling group is set to 3 (check the code repository). When we terminated one instance, the autoscaling group came into effect and not only created a new instance but also added that to the load balancer's target group. Once the EC2 instance started reporting healthy, the load balancer also started routing traffic to that instance.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">At the beginning of this note, I mentioned <strong>three use cases</strong>; in this note, <span style="text-decoration: underline">I addressed the first one</span> and added the links to the other two notes next to them.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So, that is how I created an Amazon EC2 Auto Scaling group and attached that to an application load balancer. Let me know if you have any questions.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">NOTE:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note is part of a series I wrote on <span style="text-decoration: underline">Amazon EC2 instances</span>. Read along if you are interested in learning more.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In my first note, I demonstrated how to <a href="https://skundunotes.com/2022/07/11/create-a-web-server-on-aws-ec2-instance-using-terraform-and-user-data/" target="_blank" rel="noopener">host an application in one EC2 instance</a>. However, the challenge was that the application would no longer be available if the EC2 instance were terminated (manually or otherwise).
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That leads me to identify how <a href="https://skundunotes.com/2022/07/30/add-an-application-load-balancer-to-aws-ec2-using-terraform/" target="_blank" rel="noopener">to attach a load balancer to multiple EC2 instances</a> so that the user is not impacted if a server goes down and the load is evenly distributed across all the EC2 instances. However, I had the EC2 instances hosted in a public subnet (with a route to the internet). I then tightened up the architecture and <a href="https://skundunotes.com/2023/07/26/attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet/" target="_blank" rel="noopener">moved the EC2 instances into a private subnet</a> (no route to the internet via the internet gateway). Although the architecture is better than the previous ones, there is no way to manage the EC2 instances if one or all went down or were inaccessible. We covered that in this note when we hosted our application on Amazon EC2 Auto Scaling group.</span></span></span></span></span></span>
