---
title: "Estimate AWS Cloud resource cost with Infracost, Terraform, and GitHub Actions"
date: 2023-07-17 16:34:38 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are <strong>two</strong> broad aspects to running a successful business. These are (a) creating a product that generates revenue and (b) managing the product cost that is lower than the revenue. E.g., if the product generates $100 in revenue and costs $90, then the business can survive because it is generating a 10% profit margin. Predicting sales is like predicting the future -<em>no one knows with surety</em>. But compared to sales, cost (to a large extent) is relatively predictable.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">When it comes to <strong>hosting a product on the AWS cloud</strong>, you want to know the <strong>cost</strong> of the AWS resource/s <strong>beforehand</strong> and not from the <strong>AWS Billing dashboard</strong> when it has already accrued <strong>or at the end of the month.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Many organizations hosting their products on the <strong>AWS</strong> cloud have benefitted from adopting<strong> IAC principles</strong> like automation, scalability, consistency, repeatability, and testability using tools like <strong>Terraform</strong>. In addition, using a CI-CD approach to deploying IAC enables teams to collaborate and benefit from automation: <strong>automated testing and automated deployment, thereby increasing team productivity.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Infrastructure changes</strong> can be deployed by a <strong>CI-CD pipeline</strong> using the familiar <strong>pull-request-based approach</strong>, like product features and bug fixes. This approach allows the pull-request reviewer to review the infrastructure changes in a pull request. <strong>GitHub Actions</strong> does this by posting the <code>terraform plan</code> command output as a <strong>comment in the pull request.</strong> Here is a link to a <span style="text-decoration: underline"><a href="https://github.com/kunduso/add-aws-elb-ec2-terraform/pull/9#issuecomment-1454726347" target="_blank" rel="noopener">closed pull request</a></span> where GitHub Actions updated the pull-request comments with the <code>terraform plan</code> command output. A reviewer can review the comments to evaluate the resources that will be created once the pull request is merged and determine if the pull request can be merged or not.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, the <strong>AWS resource cost is missing</strong> in the pull request. Could the pull request reviewer also <strong>review the cost</strong> of deploying the infrastructure in the <strong>pull request?</strong> Having the <strong>resource cost information </strong>in a pull request enables them to evaluate and eventually approve or decline it. And that is what <strong>Infracost</strong> addresses.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Setting up Infracost (<a href="https://www.infracost.io/docs/" target="_blank" rel="noopener">creating an account and generating the TOKEN</a>) took me less than 15 mins. I stored the TOKEN as a GitHub repo secret where I wanted to run <strong>Infracost.</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As of writing this note, there are three ways to generate an AWS resource cost estimate using Infracost in a pull request for Terraform code:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(a)</strong> by comparing the <strong>HCL code difference</strong> between the two branches in a pull request,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(b)</strong> from the <code>terraform plan</code> <strong>output</strong> in the pull request, and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(c)</strong> based on the AWS cloud resource usage.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I demonstrate generating a cost estimate in a pull request by (1) comparing the HCL code and (2) the <code>terraform plan</code> output review. Instead of having separate workflows for both these use cases (a project team will use only one use case in a repository), I merged both into the same workflow using a flag variable. I created a GitHub variable (<code>INFRACOST_SCAN_TYPE</code>) </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">and added conditions based on the variable's value to all the impacted steps in the GitHub Actions workflow YAML file.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Option 1: Comparing the HCL code difference in a pull request</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I followed this approach in the <span style="text-decoration: underline">GitHub repo: <a href="https://github.com/kunduso/add-asg-elb-terraform" target="_blank" rel="noopener">add-asg-elb-terraform</a></span>. The process could be broken down into three steps.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> Store the value of the TOKEN as a GitHub repository secret (<code>INFRACOST_API_KEY</code>) so that the GitHub Actions Yaml pipeline can reference it.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> Add a GitHub variable <code>INFRACOST_SCAN_TYPE</code> and set its value as <code>hcl_code</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3:</strong> Add the following steps with the condition to the GitHub workflow Yaml file -
GitHub Actions ensures that the below steps are run when both conditions <code>${{ (github.event_name == 'pull_request') &amp;&amp; (vars.INFRACOST_SCAN_TYPE == 'hcl_code') }}</code> are true, which would be the case if the trigger is a pull_request and the variable's value is <code>hcl_code</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The logic to generate the cost estimate is straightforward inside the YAML file.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(a) generate a cost baseline from the base (main) branch,</span></span></span><img class="alignnone size-full wp-image-2772" src="https://skundunotes.com/wp-content/uploads/2023/07/77-image2-1.png" alt="77-image2" width="801" height="274" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(b) compare that against the cost estimate from the pull-request branch to generate the difference, and</span></span></span><img class="alignnone size-full wp-image-2773" src="https://skundunotes.com/wp-content/uploads/2023/07/77-image3-1.png" alt="77-image3" width="777" height="257" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(d) publish the result as a comment in the pull request.</span></span></span>
<img class="alignnone size-full wp-image-2688" src="https://skundunotes.com/wp-content/uploads/2023/07/77-image4.png" alt="77-image4" width="1058" height="205" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is a link to a <a href="https://github.com/kunduso/add-asg-elb-terraform/pull/13#issuecomment-1656329770" target="_blank" rel="noopener">pull request comment</a> where you may review the cost estimate. As you can see, the comment is descriptive. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This option covers 90% of the use cases, as per Ali (founder).</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Although it is easy, I prefer the next option because it covers 100% of the use cases.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Option 2: From the terraform plan output</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I prefer this option because it is generated from the <code>terraform plan</code> output file. The first and second step of storing the TOKEN as a GitHub secret and the GitHub variable is applicable under this option too. However, unlike Option #1, the value of <code>INFRACOST_SCAN_TYPE</code> is set to <code>tf_plan</code>. Since Infracost needs to run only during a pull request, all those steps have an additional condition of <code>if: github.event_name == 'pull_request'</code>. You may review one such file <a href="https://github.com/kunduso/add-aws-elb-ec2-private-subnet-terraform/blob/main/.github/workflows/terraform.yml" target="_blank" rel="noopener">here</a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The workflow logic is as below:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(a) generate a <code>TFPlan.json</code> file as an output of the <code>terraform plan</code> command,</span></span></span>
<img class="alignnone size-full wp-image-2689" src="https://skundunotes.com/wp-content/uploads/2023/07/77-image5.png" alt="77-image5" width="949" height="209" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(b) generate a cost estimate from the <code>TFPlan.json</code> file, and</span></span></span>
<img class="alignnone size-full wp-image-2776" src="https://skundunotes.com/wp-content/uploads/2023/07/77-image8.png" alt="77-image8" width="771" height="145" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(c) publish the result as a comment in the pull request.</span></span></span>
<img class="alignnone  wp-image-2691" src="https://skundunotes.com/wp-content/uploads/2023/07/77-image7.png" alt="77-image7" width="825" height="184" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is a link to a pull request comment (<a href="https://github.com/kunduso/add-aws-elb-ec2-private-subnet-terraform/pull/14#issuecomment-1659020772" target="_blank" rel="noopener">Infracost-estimate</a>) where you can review the Infracost-generated cost estimate from the TFPlan output file.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note informative. I've provided a detailed description of the <strong>Infracost </strong>options and the<strong> pipeline YAML files</strong>, which should be sufficient for you to start. Let me know if you have any questions.
Adding the cost estimate of the AWS resources in a pull request will <span style="text-decoration: underline">empower</span> the reviewer to decide to approve or decline the change. This integration will also inform the project team about their <span style="text-decoration: underline"><strong>project's running cost</strong></span>, which can trigger them to identify if they are using the <span style="text-decoration: underline"><em>most cost-efficient mechanism</em></span> to host their product. <span style="text-decoration: underline">I think Infracost is an innovative solution that organizations and projects will find helpful.</span></span></span></span>
