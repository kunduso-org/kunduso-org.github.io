---
title: "Add an application load balancer to Amazon EC2 using Terraform"
date: 2022-07-30 20:15:14 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A highly available application has a higher chance of attracting customers because they are assured of consistency in service. <strong>Load balancing</strong> is a cost-effective way to increase an application's availability. In this note, I describe the steps to <strong>add an application load balancer to three Amazon EC2 instances hosted in three public subnets in different availability zones</strong> in a region using Terraform. If you want to create the same infrastructure but host the EC2 instances in three separate <strong>private subnets</strong>, check out this note  -<a href="https://skundunotes.com/2023/07/26/attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">attach an application load balancer to Amazon EC2 instances in a private subnet.</span></span></span></a></span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You may read about application load balancing at <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff"><span style="text-decoration: underline">AWS-Docs</span></span></span></span></a>. In this use case, I used concepts related to elastic load balancing, Amazon EC2, and Amazon VPC. In addition, I used Terraform to create and manage all the underlying resources to simplify my effort.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In my previous note (<span style="text-decoration: underline"><a href="https://skundunotes.com/2022/07/11/create-a-web-server-on-aws-ec2-instance-using-terraform-and-user-data/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">create-a-web-server-on-amazon-ec2-instance-using-terraform-and-user-data</span></span></span></a></span>), I described three Amazon EC2 instances hosting a static web page and displaying that when someone requested the public DNS hostname of the EC2 instances. Each EC2 instance had its own specific public DNS hostname. If an EC2 instance were deleted or was unavailable, the request to that particular DNS hostname would be denied. Placing a load balancer in front of the EC2 instances ensures that the application is not unavailable if a few EC2 instances go down.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to load balancing, I'd recommend this <span style="text-decoration: underline"><a href="https://en.wikipedia.org/wiki/Load_balancing_(computing)" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">wiki page</span></span></span></a></span>. In AWS, load balancing is supported via Elastic Load Balancing, which, per <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/what-is-load-balancing.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a></span>, automatically distributes your incoming traffic across multiple targets, such as EC2 instances, containers, and IP addresses, in one or more Availability Zones. Elastic Load Balancing supports the following load balancers: Application Load Balancers, Network Load Balancers, Gateway Load Balancers, and Classic Load Balancers.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I borrowed heavily from the concepts described in my previous note and built upon the available code. Previously, I used Terraform to provision an AWS VPC, subnets, route table, internet gateway, EC2 instance, etc. You may read about that at <a href="https://skundunotes.com/2022/07/11/create-a-web-server-on-aws-ec2-instance-using-terraform-and-user-data/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff"> -create a web server</span></span></span></a>. In this use case, I added an application load balancer too. To demonstrate how an application load balancer works, I hosted a static web page on three EC2 instances in three different availability zones that listed some specific info related to the EC2 -private IP address and availability zone. <strong>On each refresh of the load balancer DNS name, the request is routed to a different EC2 instance.</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you have the underlying VPC, subnets, security group, and EC2 instances ready like I had, you may add a load balancer to the stack in a five-step process. <strong>Here's the link to my <a href="https://github.com/kunduso/add-aws-elb-ec2-terraform" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Github repository</span></span></span></a> with the complete code</strong>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> In 2023, I automated this process using <strong>GitHub Actions</strong>. After going through all the steps in this note, if you want to learn how to automate the process, head over to <a href="http://skundunotes.com/2023/03/07/ci-cd-with-terraform-and-github-actions-to-deploy-to-aws/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">ci-cd-with-terraform-and-github-actions</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an Amazon S3 bucket for load balancer access logs</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>, access logs contain detailed information about requests sent to the load balancer. Each log contains information such as the time the request was received, the client's IP address, latencies, request paths, and server responses. You can use these access logs to analyze traffic patterns and troubleshoot issues.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Following the steps outlined at <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/enable-access-logging.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">enable-access-logging</span></span></span></a>, I created the S3 bucket, enabled server-side encryption, and attached a permissions policy. Amazon S3-managed keys (SSE-S3) are the only server-side encryption option supported.</span></span></span>
<img class="alignnone size-full wp-image-5813" src="https://skdevops.wordpress.com/wp-content/uploads/2022/07/65.image-7.png" alt="65.Image-7" width="633" height="622" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please pay special attention to the policy since it depends on the region where the resources are created.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create a target group</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a></span>, a target group is used to route requests to one or more registered targets. I specified the port and protocol that this target group was listening to.</span></span></span>
<img class="alignnone size-full wp-image-1869" src="https://skundunotes.com/wp-content/uploads/2022/07/65.image-2.png" alt="65.Image-2" width="762" height="349" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Attach the target group to the AWS instances</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this step, I attached the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_lb_target_group</code> to the three Amazon EC2 instances and specified the port number on which traffic would be routed.</span></span></span>
<img class="alignnone size-full wp-image-1870" src="https://skundunotes.com/wp-content/uploads/2022/07/65.image-3.png" alt="65.Image-3" width="823" height="116" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create the load balancer</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then I created the load balancer, enabled access logging, and attached a security group and a set of public subnets.</span></span></span>
<img class="alignnone size-full wp-image-5814" src="https://skdevops.wordpress.com/wp-content/uploads/2022/07/65.image-5-2.png" alt="65.Image-5" width="617" height="364" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Create a listener</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I attached the load balancer to the target group. Per <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a></span>, a listener is a process that checks for connection requests using the protocol and port that you configure. The rules that you define for a listener determine how the load balancer routes requests to its registered targets.</span></span></span>
<img class="alignnone size-full wp-image-1871" src="https://skundunotes.com/wp-content/uploads/2022/07/65.image-4.png" alt="65.Image-4" width="712" height="213" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With all the above code, I ran the usual Terraform commands <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform apply</code> (after initializing the repository). And after Terraform provisioned the resources, I received the message below. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That is due to the specification in the output block (in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">output.tf</code> file).</span></span></span>
<img class="alignnone size-full wp-image-1873" src="https://skundunotes.com/wp-content/uploads/2022/07/65.image-6.png" alt="65.Image-6" width="512" height="56" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>This is the load balancer DNS name.</strong> I typed that on my web browser, and the request was randomly routed to one of the EC2 instances' <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">index.html</code> page. The request was routed to a different EC2 instance with each web browser refresh. And that is how an application load balancer works. Other concepts are at play, like health checks and session stickiness, which I will discuss in a subsequent post.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you followed this note, I hope you found something useful. So go ahead and fork the <span style="text-decoration: underline"><a href="https://github.com/kunduso/add-aws-elb-ec2-terraform" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">git repository</span></span></span></a></span> and give it a try. Let me know if you have any questions or suggestions.</span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that I did not discuss the security aspect of managing the secret and access keys in this note. I am comfortable storing the values in the terraform in two methods - terraform.tfvars file OR passing them through the command line with terraform command. You can decide which option is secure and manageable depending on your use case and security posture.</span></span></span></em>
