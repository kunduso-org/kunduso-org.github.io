---
title: "VPC Peering using Terraform across separate AWS accounts"
date: 2021-08-25 04:21:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A few weeks ago, I created a <strong>peering relationship between two Amazon VPCs that belonged to separate AWS accounts using Terraform</strong>. This note captures my learning from that exercise. But before I do so, let me briefly give an overview of VPC peering and then walk through the process of creating one.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per AWS, "Amazon Virtual Private Cloud (Amazon VPC) is a service that lets you launch AWS resources in a logically isolated virtual network that you define." Hence resources created inside a particular VPC cannot communicate with the outside world unless specified. <strong>I was working on a use case to create a bridge between two VPCs belonging to separate AWS accounts so that communication could take place. This concept is known as VPC peering.</strong> It is a relationship that allows two-way communication between components hosted in separate VPCs. Here is the link to VPC Peering at <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-peering.html" target="_blank" rel="noopener">AWS Docs</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">While creating these separate Amazon VPCs in these individual AWS accounts, I was aware that I would have to create a peering relationship between the two later down the line. Hence, I allocated separate CIDR blocks to both Amazon VPCs with no overlap. <span style="text-decoration: underline">VPC peering would be possible only if the CIDR blocks have no overlap.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before I go into explaining the code, there are three prerequisites to enable vpc-peering:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(a) both the Amazon VPCs exist, (b) do not have a CIDR block overlap, and </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">(c) there is a trust relationship between the user account I am using in the trusted-account and the roles in the trusting-account. This relationship is required since I am using AWS-roles to apply the configuration changes across accounts.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are three steps to create a peering relationship between two VPCs:</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an Amazon VPC peering connection request from the peering owner account.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I started with uniquely identifying which Amazon VPCs need to be paired and the route tables to update their CIDR blocks. </span></span></span><span style="color: #000000;font-family: calibri;font-size: 18px">Then, I used resource </span><code>aws_vpc_peering_connection</code><span style="color: #000000;font-family: calibri;font-size: 18px"> to initiate a peering connection. <span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This information is available at <code><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_peering_connection" target="_blank" rel="noopener">vpc_peering_connection</a></code>.</span></span></span></span>
<img class="alignnone size-full wp-image-1431" src="https://skundunotes.com/wp-content/uploads/2021/08/48.image-2.png" alt="48.Image-2" width="459" height="173" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Accept the peering connection request in the accepter account.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used the resource <code>aws_vpc_peering_connection_accepter</code> to accept the peering connection. This information is available at <code><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_peering_connection_accepter" target="_blank" rel="noopener">vpc_peering_connection_accepter</a></code>.</span></span></span>
<img class="alignnone size-full wp-image-1432" src="https://skundunotes.com/wp-content/uploads/2021/08/48.image-3.png" alt="48.Image-3" width="530" height="155" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Update the route tables in both the VPCs with CIDR blocks for the peering connection from either side.</span></span></span></strong>
<img class="alignnone size-full wp-image-1433" src="https://skundunotes.com/wp-content/uploads/2021/08/48.image-4.png" alt="48.Image-4" width="667" height="268" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I used the <code>aws_route</code> resource type to update the route tables in the two Amazon VPCs. This information is available at <code><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route" target="_blank" rel="noopener">aws_route</a>.</code> </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you noticed, all the resources have a <code>provider</code> block associated. I had to add that since I was using assume-role to provision resources in both the accounts. </span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To confirm, you can log in to your AWS account (owner or accepter) and access peering connections under VPC to check the status of the peering connection that Terraform created.</span></span></span>
<img class="alignnone size-full wp-image-1437" src="https://skundunotes.com/wp-content/uploads/2021/08/48.image-5.png" alt="48.Image-5" width="636" height="222" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Also, the route tables in both Amazon VPCs would have an entry of the destination CIDR block. For example, the below image shows a route to the destination CIDR block using the peering connection.</span></span></span>
<img class="alignnone size-full wp-image-1439" src="https://skundunotes.com/wp-content/uploads/2021/08/48.image-6.png" alt="48.Image-6" width="633" height="207" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: I would suggest checking out a video on <span style="text-decoration: underline"><a href="https://www.youtube.com/results?search_query=how+to+peer+aws+vpc" target="_blank" rel="noopener">how to peer two VPCs in AWS manually</a></span>. That'll help you understand the Terraform code when you review that.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is the link to my GitHub repository: <a href="https://github.com/kunduso/aws-vpc-peering-using-terraform/tree/add-tf-config" target="_blank" rel="noopener">aws-vpc-peering-using-terraform.</a> Please note the branchname: add-tf-config.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">While working on this Terraform project, I came across a few keywords that I believe are necessary to elaborate on. These are below:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(a) data resource type:</strong> This is a resource identifier that allows Terraform to uniquely identify resources not managed by itself in the current configuration. Both the VPCs are identified by Terraform using the data <code>"aws_vpc" "owner"</code> code in the existing configuration. More information at <span style="text-decoration: underline"><a href="https://www.terraform.io/docs/language/data-sources/index.html" target="_blank" rel="noopener">data-sources</a></span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(b) elements and split functions:</strong> More information at <a href="https://www.terraform.io/docs/language/functions/element.html" target="_blank" rel="noopener">element()</a> and <a href="https://www.terraform.io/docs/language/functions/split.html" target="_blank" rel="noopener">split()</a>. Using the combination of these two functions, I extracted the account numbers of the VPC owners.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(c) alias keyword:</strong> Terraform uses Alias to uniquely identify the Terraform provider, when multiple providers of the same type are being used. In this case, I used two AWS providers, one for the peer owner VPC and the second for the peer accepter VPC. More information on alias is available at <span style="text-decoration: underline"><a href="https://www.terraform.io/docs/language/providers/configuration.html#alias-multiple-provider-configurations" target="_blank" rel="noopener">alias-multiple-provider-configurations</a></span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(d) assume-role:</strong> I haven't seen a better article than the one below to explain this concept. I would highly recommend going through that to understand <span style="text-decoration: underline"><a href="https://support.hashicorp.com/hc/en-us/articles/360041289933-Using-AWS-AssumeRole-with-the-AWS-Terraform-Provider" target="_blank" rel="noopener">how to use AWS assume-role to provision resources in multiple AWS accounts</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this project, I learned about VPC peering and how to do so using Terraform. Let me know if you find this note helpful.</span></span></span>
