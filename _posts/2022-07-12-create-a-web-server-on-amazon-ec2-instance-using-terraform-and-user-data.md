---
title: "Create a web-server on Amazon EC2 instance using Terraform and user data"
date: 2022-07-12 00:40:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I detail all the steps required to<strong> create a bare-bone web server on Amazon EC2</strong>. I discuss creating the Amazon Virtual Private Cloud, subnets, internet gateway, security group, and Amazon EC2 instances to finally automate the process via Terraform and user data.</span></span></span>
<!--more--><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: I did not include the concepts of load balancing, installing a certificate, or route53 in this note. At the end of this note, I have a link to my following note, where I added an application load balancer into the configuration.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A few YouTube videos or blogs are available on how to host a website on an Amazon EC2 instance. However, those were cases where the Amazon EC2 was hosted on the default VPC or created via the AWS console. There is nothing wrong with that. But I wanted to create the web servers right from the ground up, and that too using Terraform; hence, to capture my thought process, I came up with the idea of writing this note.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You will need a basic understanding of Terraform, Amazon VPC, subnets, internet gateway, security groups, route table, Amazon EC2, and user data to follow along. If you are new to these concepts, you can read about <a href="https://skundunotes.com/2020/10/28/getting-started-with-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">getting started with Terraform</span></span></span></a> and <a href="https://skundunotes.com/2021/11/01/create-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">how to create an Amazon EC2 instance</span></span></span></a> and underlying infrastructure (like vpc, subnets, etc) using Terraform.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to walk along, I have the code committed to my GitHub repository: <a href="https://github.com/kunduso/add-aws-elb-ec2-terraform" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add-aws-elb-ec2-terraform</span></span></span></a>.</span></span></span>
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> I updated the code repository with a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">loadbalancer.tf</code> later since I was using the same repository to work on the load balancer note (link shared at the end of this note). Creating a load balancer with the Amazon EC2 instances would not hurt. However, when you start working with the repository and if you do not want to explore load balancers, you can comment out the file <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">loadbalancer.tf</code> and the last three lines from <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">output.tf</code>.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I broke down this use case into four steps.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create the network components</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created a pretty small VPC since this was a proof of concept. Notably, I set two flags<strong> to true</strong>. You can read them at <a href="https://docs.aws.amazon.com/glue/latest/dg/set-up-vpc-dns.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs: Setting Up DNS in Your VPC</span></span></span></a>. The rest of the infrastructure bits are standard. If you want to know more, please refer <span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/01/create-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">to this note</span></span></span></a></span>.</span></span></span> 
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>UPDATE:</strong> As of March 2025, the network stack was converted to consume from a VPC module instead of the Terraform configuration, as shown below.</span></span></span>
<img class="alignnone size-large wp-image-5805" src="https://skdevops.wordpress.com/wp-content/uploads/2023/07/79-image-9.png?w=656" alt="" width="656" height="434" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create a security group</span></span></span></strong>
<img class="alignnone size-full wp-image-5823" src="https://skdevops.wordpress.com/wp-content/uploads/2022/07/64.image-3-1.png" alt="64.Image-3" width="466" height="408" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since this was a proof of concept and I did not require HTTPS traffic, I did not bother creating more than necessary.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create the user data file</span></span></span></strong>
<img class="alignnone size-full wp-image-5824" src="https://skdevops.wordpress.com/wp-content/uploads/2022/07/64.image-4-1.png" alt="64.Image-4" width="1017" height="391" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">User data is a feature that allows customization of Amazon EC2 (virtual machine) when provisioned and (if desired) with each restart. I was required to install the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">httpd service</code> and update the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">index.html</code> page in this use case. I have a detailed note on user data at <a href="https://skundunotes.com/2021/11/07/working-with-aws-ec2-user-data-and-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">working-with-amazon-ec2-user-data-and-terraform</span></span></span></a>. </span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an Amazon EC2 instance with a user data file</span></span></span></strong>
<img class="alignnone size-full wp-image-5825" src="https://skdevops.wordpress.com/wp-content/uploads/2022/07/64.image-5-2.png" alt="64.Image-5" width="661" height="523" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This is the last step, where I provisioned three Amazon EC2 instances using the infrastructure bits discussed earlier. An interesting observation is that since I required the <strong>instances accessible from outside the VPC, I had to associate them with a public IP address.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With all the above code, I ran the usual Terraform commands of <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform apply</code> (after initializing the repository). And after Terraform provisioned the resources, I received the message below. That is due to the specification in the output block (in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">output.tf</code> file).</span></span></span>
<img class="alignnone size-full wp-image-1849" src="https://skundunotes.com/wp-content/uploads/2022/07/64.image-6.png" alt="64.Image-6" width="616" height="92" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These are the public DNS of the three Amazon EC2 instances that Terraform provisioned.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, on the AWS console, I found the two Amazon EC2 instances were still initializing. <strong>Terraform</strong> does not manage the state of the Amazon EC2 instance after it provisions them, and the control passes over to the user data file. Stated differently, <strong>Terraform does not track whether the user data script was successful</strong>. However, I was confident that the user-data file I provided was correct (I'd run this code more than a few dozen times in the past). Therefore, I waited for the instances to pass the status checks before I tried to access the public DNS that Terraform provided.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since I did not install a certificate on the Amazon EC2 instances, HTTPS was not going to work, and I tried the HTTP URL, which was <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">HTTP://$(the public DNS provided in the output)</code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And this is what I saw for all three public DNS addresses.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After working on this repository, I added a load balancer and updated the security group of the EC2 instances to accept requests only from the load balancer's security group. <strong>Please note that after adding the load balancer, you can't access the below message</strong> using the Amazon EC2 instance's DNS because the updated security group rule will restrict that. </span></span></span>

<img class="alignnone size-full wp-image-1850" src="https://skundunotes.com/wp-content/uploads/2022/07/64.image-7.png" alt="64.Image-7" width="657" height="112" />
<img class="alignnone size-full wp-image-1851" src="https://skundunotes.com/wp-content/uploads/2022/07/64.image-8.png" alt="64.Image-8" width="662" height="112" />
<img class="alignnone size-full wp-image-1852" src="https://skundunotes.com/wp-content/uploads/2022/07/64.image-9.png" alt="64.Image-9" width="664" height="113" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <strong>"Not secure"</strong> right before the public DNS name denotes that this is an <strong>HTTP URL</strong>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This concludes this note on <span style="text-decoration: underline">how to provision a web server on an Amazon EC2 instance using Terraform and user data.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are familiar with Terraform, go ahead and fork the repository and try it. Then, let me know if you face any challenges. I also added an application load balancer to the three Amazon EC2 instances in my subsequent note at  -<a href="https://skundunotes.com/2022/07/30/add-an-application-load-balancer-to-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">add-an-application-load-balancer-to-amazon-ec2-using-terraform</span></span></span></a>.</span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that I did not discuss the security aspect of managing the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">secret key</code> and <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">access key</code></span></span></span></em> <span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">in</span></span></span><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"> this note. There are two methods I am comfortable with: storing the values in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform.tfvars</code> file OR passing them through the command line with <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform command</code>. Depending on your use case and security posture, you can decide which option is secure and manageable.</span></span></span></em>
