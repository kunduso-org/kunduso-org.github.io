---
title: "Create an Amazon EC2 Auto Scaling group with metric scaling policies using Terraform"
date: 2023-09-28 03:14:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note continues to explore the auto-scaling concept I discussed in my noteÂ <a href="https://skundunotes.com/2023/09/12/create-amazon-ec2-auto-scaling-group-and-load-balancer-using-terraform-and-github-actions/" target="_blank" rel="noopener"> -create an ASG and load balancer with Terraform</a>, so please read that note before this one.</span></span></span>
<!--more-->

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After creating the Amazon EC2 Auto Scaling group, the application development team would require the <span style="text-decoration: underline">scaling policies</span> to manage the correct number of Amazon EC2 instances. That way, the Amazon EC2 instances will continue to serve customer requests and use the <span style="text-decoration: underline">least number of instances</span> to host the application. Using adequate Amazon EC2 instances leads to <strong>cost savings</strong> for the project. In the previous note (linked above), I mentioned three use cases where an Amazon EC2 Auto Scaling group can be beneficial. I'll cover the <span style="text-decoration: underline">second use case</span><strong>:</strong> <strong>Can the number of Amazon EC2 instances be scaled based on a metric like CPU usage?</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before I dive into explaining the code, let me explain the concept. Suppose a load balancer with a round-robin algorithm routes traffic to three Amazon EC2 instances hosting an application. Until a certain level of high CPU usage, the EC2 instances could continue to serve the customer requests depending on the size of the instance. However, beyond a specific high use, the customers will start observing a <span style="text-decoration: underline">delay in processing their requests</span>. As a cloud engineer, you may also notice <span style="text-decoration: underline">high CPU utilization</span> metrics for the Amazon EC2 instances. In the case of an Amazon EC2 Auto Scaling group, you can track the high CPU usage for a specific duration and <span style="text-decoration: underline">create additional EC2 instances if the usage remains high</span>. With the creation of additional EC2 instances, the CPU utilization will be expected to reduce. The Amazon EC2 Auto Scaling group manages that via <strong>scaling policies.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Scaling policies could be <span style="text-decoration: underline">dynamic, predictive, or scheduled</span>. In the current use case, I am using the dynamic scaling policy. Scaling policies are of two types -<span style="text-decoration: underline"> increasing and decreasing</span>. Similar to increasing, if the CPU usage drops below a specific percentage, the Amazon EC2 Auto Scaling group would trigger a scale-in activity where the scaling policies would reduce the total number of Amazon EC2 instances. The scale-out and scale-in policy actions are managed via the <span style="text-decoration: underline">Amazon CloudWatch alarm</span>. The Amazon CloudWatch alarm tracks the CPU Utilization metric and, when a specific condition is met, triggers the alarm and takes a particular Auto Scaling action.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let me now explain this with the <strong>Terraform code</strong> in my <a href="https://github.com/kunduso/add-asg-elb-terraform/blob/main/autoscaling.tf" target="_blank" rel="noopener">GitHub repository: add-asg-elb-terraform/autoscaling.tf</a></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As I stated earlier, there are two scaling activities: <strong><em>increasing and decreasing</em></strong>. Each scaling policy is managed via an <span style="text-decoration: underline">Amazon CloudWatch alarm</span>. Hence, there are four additional resources.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create an Amazon EC2 Auto Scaling group policy to scale out</span></span></span>
<img class="alignnone size-full wp-image-2897" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-1.png" alt="83-image-1" width="841" height="211" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see from the image above, the auto-scaling policy adds one Amazon EC2 instance to the existing Amazon EC2 Auto Scaling group. The <code>cooldown</code> property is the number of seconds after a scaling activity completes and before the next scaling activity can start, provided the Amazon CloudWatch alarm is still in the "in alarm" state.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create an Amazon CloudWatch metric alarm to track the CPU metric and trigger a scale-out activity</span></span></span>
<img class="alignnone size-full wp-image-2898" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-2.png" alt="83-image-2" width="908" height="467" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon CloudWatch alarm triggers the Amazon EC2 Auto Scaling group policy to act provided a specific condition is met. In the code snippet above, if the CPU utilization of an instance in the Amazon EC2 Auto Scaling group crosses the threshold of 70% and remains there for two evaluation periods of 60 seconds each, the alarm state would change to "In alarm," and the alarm action would take effect. The effect here is to trigger the Amazon EC2 Auto Scaling group's scaling policy to add an Amazon EC2 instance to the group.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon EC2 Auto Scaling group with only a scale-out policy is an <span style="text-decoration: underline">incomplete strategy</span> without a scale-in policy. Just as a scale-out policy adds Amazon EC2 instances when specific conditions are met, a scale-in policy is needed to remove Amazon EC2 instances when the conditions change. In this case, the below two resources address that aspect.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Create an Amazon EC2 Auto Scaling group policy to scale in</span></span></span>
<img class="alignnone size-full wp-image-2899" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-3.png" alt="83-image-3" width="816" height="210" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see from the image above, the auto-scaling policy removes an Amazon EC2 instance from the existing Amazon EC2 Auto Scaling group.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Create an Amazon CloudWatch metric alarm to track the CPU metric and trigger a scale-in activity</span></span></span>
<img class="alignnone size-full wp-image-2900" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-4.png" alt="83-image-4" width="887" height="460" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here, the conditions are on the lower side. So if the CPU utilization drops below the threshold of 30% and remains there for two evaluation periods of 60 seconds each, the alarm action of triggering the Amazon EC2 Auto Scaling group's scale-in policy would go into effect. The scale-in policy would continue to remove instances until the number of instances in the Amazon EC2 Auto Scaling group equals the desired capacity.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So, that addresses the code aspect. Now, let me demonstrate <strong>the steps to test both scaling policies</strong>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since the Amazon EC2 Auto Scaling group tracks the CPU Utilization metric, I installed a <code>stress</code> utility on the EC2 instance. The <code>user_data</code> script has the code to install that. Then I followed the steps here: <a href="https://www.wellarchitectedlabs.com/performance-efficiency/100_labs/100_monitoring_linux_ec2_cloudwatch/5_generating_load/" target="_blank" rel="noopener">generate load to add stress to the Amazon EC2 instances.</a></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>TL;DR:</strong> Connect to any Amazon EC2 instance using Session Manager and run the command <code>sudo stress --cpu 8 --vm-bytes $(awk '/MemAvailable/{printf "%d\n", $2 * 0.9;}' &lt; /proc/meminfo)k --vm-keep -m 1</code> . Press <code>Ctrl+C</code> to stop the script after 4 minutes. You'll see the high percentage if you navigate to the Amazon EC2 instance's Monitoring Tab and check for CPU utilization. You will also notice that the rising CPU utilization triggered the Amazon CloudWatch monitoring alarm, which triggers the scale-out event.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I found new activities recorded under the Activity History of the Auto Scaling group.</span></span></span>
<img class="alignnone size-full wp-image-2901" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-5.png" alt="83-image-5" width="1364" height="281" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After approximately 5 minutes or so, another EC2 instance was added by the scaling policy, and I saw six instances. Even if there is high CPU consumption, there won't be any more Amazon EC2 instances because the maximum size specified in the Amazon EC2 Auto Scaling group is 6.</span></span></span>
<img class="alignnone size-full wp-image-2902" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-6.png" alt="83-image-6" width="1151" height="239" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After completing health check evaluations, the load balancer was routing traffic to all the Amazon EC2 instances. Here is the image of the load balancer's target group.</span></span></span>
<img class="alignnone size-full wp-image-2903" src="https://skundunotes.com/wp-content/uploads/2023/09/83-image-7.png" alt="83-image-7" width="1073" height="437" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: If you look carefully at the Instance IDs under activity history, instance IDs won't match because after launching, the health check kept failing for one of them, and they had to be re-provisioned.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that is how the scale-out policy works. Once I stopped the stress script [Ctrl+C], the CPU utilization was reduced to below 30%. Due to this, the Amazon CloudWatch alarm went into effect and triggered the Amazon EC2 Auto Scaling group's scale-in policy. Gradually, the Amazon EC2 instances were removed one by one until the number of active instances equaled the desired capacity.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If I had not added the scale-in policy, the number of Amazon EC2 instances would have remained high, defeating the purpose of having an auto-scaling group.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you understand how the Amazon EC2 Auto Scaling group's scaling policies work. Let me know if you have any questions.</span></span></span>
