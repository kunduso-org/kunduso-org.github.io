---
title: "Continuous Deployment of Amazon ECS service using Terraform and GitHub Actions"
date: 2024-05-07 00:12:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note demonstrates how to host a Docker image as a container in <strong>Amazon Elastic Container Service</strong> (Amazon ECS). Per <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/Welcome.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS Docs</span></span></span></a>, Amazon ECS is a fully managed container orchestration service that helps you easily deploy, manage, and scale containerized applications.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Deploying a service into Amazon ECS can be divided into<span style="text-decoration: underline"> three separate use cases</span>:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> Provision of the underlying infrastructure to host an Amazon ECS service.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2.</strong> Push a Docker image to Amazon Elastic Container Registry (Amazon ECR).</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> Create a service/task from the Docker image and host it on Amazon ECS.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before a container can be hosted in an Amazon ECS service and the Docker image can be uploaded into Amazon ECR, <span style="text-decoration: underline">you must provision specific AWS cloud services</span>. These are the underlying infrastructure components (mentioned in use case 1 above), such as Amazon Virtual Private Cloud, Amazon ECR, Amazon ECS Cluster, load balancer, target group, and listener. These Amazon cloud services are prerequisites and must be provisioned before application development. I have covered the details of provisioning these resources in a separate post: <a href="https://skundunotes.com/2024/04/10/create-infrastructure-to-host-an-amazon-ecs-service-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Create Infrastructure to Host an Amazon ECS Service Using Terraform.</span></span></span></a></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After provisioning the necessary AWS cloud services, the second use case is to <span style="text-decoration: underline">create a Docker image</span> and push it into Amazon ECR. I have covered the details of this process in another post: <a href="https://skundunotes.com/2024/04/28/push-docker-image-to-amazon-ecr-using-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Push Docker Image to Amazon ECR Using GitHub Actions.</span></span></span></a></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, the <span style="text-decoration: underline">last use case</span> belongs to the application development process, in which an Amazon ECS service is created from the Docker image stored in Amazon ECR. I will cover this use case in this note.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This use case can be divided into <strong>a)</strong> The Terraform code to provision the required AWS cloud resources and <strong>b)</strong> The GitHub Actions workflow to deploy the Terraform code and create the Amazon ECS service.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will first cover the AWS services provisioning, followed by the GitHub Actions workflow.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Use-Case 1: Provision AWS Cloud Services</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Apart from the AWS cloud resources provisioned under the infrastructure section (covered in use case 1), there are four more resources required for the Amazon ECS service:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> ECS execution role</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2</strong>. ECS task role</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> ECS task definition</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4.</strong> ECS service</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Optionally, the two IAM roles (task and execution roles) could also belong to the infrastructure stack. </span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let's review these resources one by one. To follow along, you can access the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deploy</code> folder in my GitHub repository: <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/tree/create-ecs-service/deploy" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff"> kunduso/add-aws-ecr-ecs-fargate</span></span></span></a>.</span></span></span><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000"> Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = create-ecs-service</code>.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Provision the ECS roles:</span></span></span>
</strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are two roles, the ECS execution role and the ECS task role. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">task execution role </span></span></span></a>must have permission to <span style="text-decoration: underline">create the ECS service</span>. The below resource block creates the AWS IAM role that can be assumed by the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">"ecs-tasks.amazonaws.com"</code> service.</span></span></span>
<img class="alignnone size-full wp-image-3752" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-1.png" alt="92-image-1" width="509" height="344" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The below IAM role policy attachment resource attaches the role to the AWS-managed policy of <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy</code>. </span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonECSTaskExecutionRolePolicy.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">managed policy</span></span></span></a> has the necessary permissions to other AWS service resources to run Amazon ECS tasks.</span></span></span>
<img class="alignnone size-full wp-image-3753" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-2.png" alt="92-image-2" width="805" height="136" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">ECS task role</span></span></span></a> is <span style="text-decoration: underline">attached to the tasks</span> running in the ECS service. If the task requires permission to access AWS Secrets Manager secrets, write to an Amazon S3 bucket, CloudWatch logs, DynamoDB, or other resources, it requires the necessary IAM permissions.</span></span></span>
<img class="alignnone size-full wp-image-3754" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-3.png" alt="92-image-3" width="848" height="502" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this use case, the task does not communicate with any other AWS resource and, hence, does not have a permission policy attached. </span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000">Update: A custom IAM policy was attached to the IAM role after the use case on accessing secure credentials stored in AWS Secrets Manager from the AWS Fargate task was added. However, for this use case, no custom IAM permission policy is required.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Provision the ECS task definition:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The ECS task definition is the blueprint of the ECS service. It defines the Docker image, CPU and memory requirements, networking configuration, and other settings for the tasks in the service.</span></span></span>
<img class="alignnone size-full wp-image-3755" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-4.png" alt="92-image-4" width="647" height="527" />
<span style="color: #000000;font-family: calibri"><span style="font-size: 18px">To access all the properties in an Amazon ECS task definition template, choose <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-definition-template.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">ECS-task-definition-template</span></span></span></a>, and for a detailed description of the properties, choose <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Amazon-ECS-task-definition-parameters</span></span></span></a>.</span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Provision the ECS service:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The ECS service defines the desired count of tasks, scaling policies, load balancing configurations, and other settings for running and managing the tasks.</span></span></span>
<img class="alignnone size-full wp-image-3756" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-5.png" alt="92-image-5" width="651" height="384" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of all the Terraform-managed AWS cloud resources.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Use-Case 2: Update GitHub Actions Workflow with Deploy Job</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This step adds a new job (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deploy</code>) to the existing GitHub Actions workflow (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">.github/workflows/app-ci-cd.yml</code>) stored in the <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/blob/create-ecs-service/.github/workflows/app-ci-cd.yml" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">repository</span></span></span></a>. The <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/blob/561b0a1c267d54c1fe20cb6a7e8edc455d0514e5/.github/workflows/app-ci-cd.yml#L21" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">first job (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">build</code>)</span></span></span></a> creates and pushes a Docker image to the Amazon ECR repository. The <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/blob/561b0a1c267d54c1fe20cb6a7e8edc455d0514e5/.github/workflows/app-ci-cd.yml#L95" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">second job (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deploy</code>)</span></span></span></a> runs the Terraform code to deploy the ECS service.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To authenticate with AWS from your GitHub Actions workflow, you'll need to configure AWS credentials. Follow the steps outlined in [<a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">this detailed guide</span></span></span></a>] to set up the required AWS credentials and store them as a GitHub repository secret. I completed that while setting up the first job -<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">build</code>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is the overview of the second job in the workflow:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1. Utilizing the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">needs</code> property:</strong> </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deploy</code> job must only run, if the previous <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">build</code> job was successful. That is managed by the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">needs: build</code> value in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deploy</code> job.</span></span></span>
<img class="alignnone size-full wp-image-3757" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-6.png" alt="92-image-6" width="389" height="138" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2. Read the inputs:</strong> The first job's output is the Docker image tag, which is the input for the second job. This image tag is an input to the Amazon ECS task definition. The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">image_tag</code> is a variable in the Terraform code for the Amazon ECS task definition resource, and no default value is configured for that. Hence, the new Docker image tag must be passed to the ECS task definition; otherwise, the provisioning process will fail.</span></span></span>
<img class="alignnone size-full wp-image-3758" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-7.png" alt="92-image-7" width="420" height="41" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3. Read and display the Tag name:</strong> This step helps the development team during debugging in case of a deployment failure. It will provide information regarding the Docker image used to create the Amazon ECS service.</span></span></span>
<img class="alignnone size-full wp-image-3759" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-8.png" alt="92-image-8" width="562" height="46" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4. Authenticate to AWS Cloud:</strong> This step uses the <a href="https://github.com/aws-actions/configure-aws-credentials" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">aws-actions/configure-aws-credentials</span></span></span></a> action to configure the AWS credentials required for authenticating with AWS services. The action retrieves the IAM_ROLE from the GitHub secrets you set up earlier.</span></span></span>
<img class="alignnone size-full wp-image-3760" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-9.png" alt="92-image-9" width="584" height="116" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5. Setup Terraform and Infracost:</strong> You can read about this at - <a href="https://skundunotes.com/2023/07/17/estimate-aws-cloud-resource-cost-with-infracost-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">How to setup Terraform and Infracost in GitHub Actions</span></span></span></a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>6. Condition for Terraform Apply:</strong> This workflow is configured to run with each check-in to the app and deploy folders, irrespective of which branch the developers are checking-in code. The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform apply</code> step deploys the Amazon ECS service and hence with the condition in place, only the code that belongs to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">main</code> branch can be deployed. The only way to commit to the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">main</code> branch is via pull request, which must pass through a review.</span></span></span>
<img class="alignnone size-full wp-image-3761" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-10.png" alt="92-image-10" width="492" height="101" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After the service is deployed, log into your AWS account, get the load balancer DNS, paste it into your favorite browser, and then enter the port number, which is <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">8080</code>. You'll see your Docker container live and serving traffic.</span></span></span>
<img class="alignnone size-full wp-image-3762" src="https://skundunotes.com/wp-content/uploads/2024/05/92-image-11.png" alt="92-image-11" width="1518" height="959" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you keep refreshing, you will see the private IP of the two containers in the message.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are a few <span style="text-decoration: underline">salient features</span> to this architecture that you must understand:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1. Infrastructure as Code (IaC):</strong> Terraform allows you to maintain and version control your infrastructure configuration, enabling consistent and repeatable deployments.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2. Continuous Integration and Continuous Deployment (CI/CD):</strong> The GitHub Actions workflow automates the build, scan, and deployment processes, ensuring a smooth and efficient delivery pipeline.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3. Scalability and High Availability:</strong> Amazon ECS allows you to scale your containerized applications horizontally and deploy them across multiple Availability Zones for high availability.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4. Separation of Concerns:</strong> By separating infrastructure provisioning, Docker image management, and application deployment, you can maintain a modular and maintainable architecture.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5. Immutable Infrastructure:</strong> Deploying new versions of your application as immutable Docker images can ensure consistency and reliability across deployments.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Using these <span style="text-decoration: underline">three notes</span>, you should have understood how to manage your containerized applications with Amazon ECR and ECS. If you have any questions or suggestions, please feel free to reach out via the comments.</span></span></span>
