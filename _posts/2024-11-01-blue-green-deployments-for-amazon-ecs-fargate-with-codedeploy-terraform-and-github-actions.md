---
title: "Blue-Green Deployments for Amazon ECS Fargate with CodeDeploy, Terraform, and GitHub Actions"
date: 2024-11-01 04:53:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Blue-green deployment</strong> is a software release strategy that <span style="text-decoration: underline">minimizes downtime and risk</span> by running two identical environments, "blue" and "green." At any given time, one environment (e.g., blue) is live and serving traffic, while the other (green) is idle and used for staging new updates. Once the updates are tested and validated in the green environment, traffic is switched from blue to green, allowing for a <span style="text-decoration: underline">seamless transition and easy rollback</span> if issues arise.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>AWS CodeDeploy</strong> automates the blue-green deployment process by managing the deployment of applications to separate load balancer target groups. It allows for seamless traffic shift between the blue and green target groups, ensuring a smooth transition and minimal downtime. <strong>CodeDeploy</strong> monitors the deployment's health, enabling automatic rollbacks if any issues are detected during the switch.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I explain how to create a blue-green deployment process for the <strong>Amazon ECS Fargate</strong> service using <strong>CodeDeploy</strong>. I used <strong>Terraform</strong> to provision all the <strong>AWS cloud resources</strong> and automated the deployment process with <strong>GitHub Actions</strong>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note builds upon the concepts discussed in my previous notes, so it would be helpful to examine them before you start. If you are short on time, do not miss note #3 since the AWS cloud resources discussed there overlap with those in this note.</span></span></span>

<a href="https://skundunotes.com/2024/04/10/create-infrastructure-to-host-an-amazon-ecs-service-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">1. Provision of the underlying infrastructure to host an Amazon ECS service</span></span></span></a>
<a href="https://skundunotes.com/2024/04/28/push-docker-image-to-amazon-ecr-using-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">2. Push a Docker image to Amazon Elastic Container Registry (Amazon ECR)</span></span></span></a>
<a href="https://skundunotes.com/2024/05/06/continuous-deployment-of-amazon-ecs-service-using-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">3. Create a service/task from the Docker image and host it on Amazon ECS</span></span></span></a>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Optionally, if you are interested, you may also go through these two notes:</span></span></span>
<a href="http://skundunotes.com/2024/06/27/enabling-health-checks-and-cloudwatch-logs-for-aws-fargate-tasks/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">4. Enabling Health Checks and CloudWatch Logs for AWS Fargate Tasks</span></span></span></a>
<a href="http://skundunotes.com/2024/07/02/protecting-credentials-and-variables-in-aws-fargate-containers-using-aws-secrets-manager/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">5. Protecting Credentials and Variables in AWS Fargate Containers using AWS Secrets Manager</span></span></span></a>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will walk through the Terraform code to provision all the AWS Cloud resources; hence, it'd be helpful to access the GitHub code repository with the Terraform code. Here is the link: <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/tree/enable-blue-green-deployment" target="_blank" rel="noopener"><span style="color: #0000ff">GitHub: kunduso/add-aws-ecr-ecs-fargate</span></a>.<em><span style="color: #ff0000"> Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = enable-blue-green-deployment</code>.</span></em></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create Amazon ECS resources</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are four AWS cloud resources required:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. ECS execution role</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. ECS task role</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. ECS task definition</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. ECS service</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I've covered these in detail in note #3; you can read about them there. However, there is one change in the resource <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">"aws_ecs_service"</code>; the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deployment_controller</code> property with the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">type = "CODE_DEPLOY"</code> value.</span></span></span>
<img class="alignnone size-full wp-image-4987" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-1.png" alt="104-image-1" width="510" height="164" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This property enables CodeDeploy to manage deployment to the Amazon ECS service. <span style="text-decoration: underline">Please note</span> that if you have an existing Amazon ECS service and then make this change, Terraform will destroy that Amazon ECS service and recreate it.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create an IAM role for AWS Code Deploy</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The CodeDeploy service requires an <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/codedeploy_IAM_role.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">IAM role to manage deployments</span></span></span></a>. The below code creates the IAM role and attaches the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">assume_role_policy</code> to it. Then, it attaches a managed policy <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS</code> to the IAM role that enables it to manage deployments and load balancer to target group attachments/detachments.</span></span></span>
<img class="alignnone size-full wp-image-4988" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-2.png" alt="104-image-2" width="863" height="431" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create a CodeDeploy application and deployment group</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Two CodeDeploy resources are required for this use case -the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_codedeploy_app</code> and the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_codedeploy_deployment_group</code> . The app stores the type of <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">compute_platform</code>, which can be ECS, Lambda, or Server, as of October 2024. Since our use case is on Amazon ECS, that is the value in the Terraform code. The deployment group consists of properties to manage the deployment, such as the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deployment_config_name</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">blue_green_deployment_config</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">ecs_service</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deployment_style</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">auto_rollback_configuration</code>, and <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">load_balancer_info</code>.</span></span></span>
<img class="alignnone size-full wp-image-4989" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-3.png" alt="104-image-3" width="832" height="611" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Through these properties, CodeDeploy manages blue-green deployment. For updated information on the values supported by these properties, please check <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/codedeploy_deployment_group" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Terraform AWS Registry: aws_codedeploy_deployment_group</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create the CodeDeploy deployment</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last set of AWS cloud resources to create is to support a CodeDeploy deployment. That is managed by:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Creating the appspec content,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Creating a shell script to run the AWS CLI command <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws deploy create-deployment</code>, and finally</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Running the shell script on the GitHub-hosted runner using the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform_data</code> AWS cloud resource.</span></span></span>
<img class="alignnone size-full wp-image-4990" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-4.png" alt="104-image-4" width="661" height="545" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will now walk through the process with screenshots of a blue-green deployment process. Two target groups are required for an Amazon ECS supporting blue-green deployment. When an application is live and serving traffic, the requests route from the load balancer to one of the attached target groups (blue) and from there to the containers attached to that target group.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see from the image below, before CodeDeploy started a new Blue-Green deployment, two tasks were running version #74 of the task definition.</span></span></span>
<img class="alignnone size-full wp-image-4991" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-5.png" alt="104-image-5" width="799" height="201" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see in the image below, both these tasks/containers were registered with the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-blue</code> target group, which was associated with the load balancer: app-6.</span></span></span>
<img class="alignnone size-full wp-image-4992" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-6.png" alt="104-image-6" width="816" height="484" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can see from the image below that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-green</code> target group was not associated with the load balancer. Moreover, there were no containers registered with that target group.</span></span></span>
<img class="alignnone size-full wp-image-4993" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-7.png" alt="104-image-7" width="818" height="502" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, when the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform apply</code> command was executed, a new version of the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">local_file.code_deploy_sh</code> was created, which triggered the resource <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform_data</code> to be recreated. That was managed by the property <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">triggers_replace = local_file.code_deploy_sh</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The logic in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">terraform_data</code> runs the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">code_deploy.sh</code> file, which triggers a CodeDeploy deployment using the AWS CLI. The image below shows a CodeDeploy deployment in progress.</span></span></span>
<img class="alignnone size-full wp-image-4994" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-8.png" alt="104-image-8" width="778" height="433" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As part of the CodeDeploy deployment, new ECS tasks were started, as seen in the image below.</span></span></span>
<img class="alignnone size-full wp-image-4995" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-9.png" alt="104-image-9" width="909" height="309" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see, the new tasks are on version #75 of the task definition. After a few seconds, the Health status changed from <strong>Unknown</strong> to <strong>Healthy</strong>. Compare the images above and below.</span></span></span>
<img class="alignnone size-full wp-image-4996" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-10.png" alt="104-image-10" width="927" height="311" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, on the Load balancer page, the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-green</code> target group started listing the two tasks, but the Health status was <strong>Unused</strong>.</span></span></span>
<img class="alignnone size-full wp-image-4997" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-11.png" alt="104-image-11" width="945" height="499" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After a few seconds, it changed from <strong>Unused</strong> to <strong>Initial</strong>. That is when the two tasks were getting registered with the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-green</code> target group.</span></span></span>
<img class="alignnone size-full wp-image-4998" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-12.png" alt="104-image-12" width="938" height="314" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A few seconds later, when the Health Status changed to <strong>Healthy</strong>, you can see that the load balancerâ€™s traffic routing changed to the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-green</code> target group from <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-blue</code> target group.</span></span></span>
<img class="alignnone size-full wp-image-4999" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-13.png" alt="104-image-13" width="936" height="503" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And under the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app-6-blue</code> target group, the two tasks were deregistered.</span></span></span>
<img class="alignnone size-full wp-image-5000" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-14.png" alt="104-image-14" width="940" height="523" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With that change, the CodeDeploy deployment was completed.</span></span></span>
<img class="alignnone size-full wp-image-5001" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-15.png" alt="104-image-15" width="880" height="446" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To verify, I navigated to the Amazon ECS console and checked the tasks. As you can see from the image below, the new two tasks (#75) were up and running while the older tasks (#74) were being stopped.</span></span></span>
<span style="text-decoration: underline"><img class="alignnone size-full wp-image-5002" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-16.png" alt="104-image-16" width="921" height="324" /></span>
<span style="text-decoration: underline"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000;text-decoration: underline">So, the process of Blue-Green deployment is as follows:</span></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">When a newer version of the ECS task definition is available, Amazon ECS spins up <span style="text-decoration: underline">new containers</span> and waits for the container health check status to be <span style="text-decoration: underline">Healthy</span>. After that, the containers are registered with a target group (green) that isn't attached to the load balancer. After the containers are <span style="text-decoration: underline">successfully registered</span> with the target group (green), CodeDeploy routes traffic from the load balancer to the green target group and stops sending traffic to the blue target group. Then, depending on the specifications of the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_codedeploy_deployment_group</code> resource, the containers in the old target group are managed. In this use case, the action was to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">TERMINATE</code> the containers after a minute of detaching from the load balancer.</span></span></span>
<img class="alignnone size-full wp-image-5003" src="https://skundunotes.com/wp-content/uploads/2024/10/104-image-17.png" alt="104-image-17" width="457" height="213" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of all the Terraform-managed AWS cloud resources to enable blue-green deployment using AWS Code Deploy. Please check the Use-Case 2: Update GitHub Actions Workflow with Deploy Job section of <a href="https://skundunotes.com/2024/05/06/continuous-deployment-of-amazon-ecs-service-using-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">note#3</span></span></span></a> to continue with the next steps. And, let me know if you have any questions.</span></span></span>
