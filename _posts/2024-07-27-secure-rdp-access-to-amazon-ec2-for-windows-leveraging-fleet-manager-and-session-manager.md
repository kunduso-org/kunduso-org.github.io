---
title: "Secure RDP Access to Amazon EC2 for Windows: Leveraging Fleet Manager and Session Manager"
date: 2024-07-27 11:30:09 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Fleet Manager</strong> is a service AWS Systems Manager provides to securely manage Amazon EC2 instances at scale. Cloud engineers can log in via remote desktop (RDP) to Amazon EC2 instances for Windows using Fleet Manager to perform troubleshooting or management tasks.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Previously, a set of configurations were required to access an Amazon EC2 instance for Windows using RDP. These were: (a) a security group with ingress on <code><span style="font-size: 15px"><span style="color: #0047ab">port# 3389</span></span></code> from the destination CIDR/IP address, (b) a public IP address for the Amazon EC2 instance, (c) a PEM file to decrypt the Administrator password, (d) an Internet Gateway, and (e) a route to <code><span style="font-size: 15px"><span style="color: #0047ab">0.0.0.0/0</span></span></code> in the route table using the Internet Gateway.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, with Session Manager, accessing an Amazon EC2 for Windows instance was convenient. This option was more secure than the previous one because it did not require an ingress rule in the security group. However, this option did not present a GUI-based experience that Windows Administrators are familiar with.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Further on, with VPC Endpoint integration for Session Manager, the option was better because it did not require a public IP address associated with the Amazon EC2 instance, an Internet Gateway, or any route to <code><span style="font-size: 15px"><span style="color: #0047ab">0.0.0.0/0</span></span></code>. However, an ingress rule was required on <code><span style="font-size: 15px"><span style="color: #0047ab">port# 443</span></span></code>. Like the previous option, it presented only a CLI-based experience.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, with Fleet Manager integration, Cloud Engineers and Windows Administrators <span style="text-decoration: underline">benefit from the security best practices of using Session Manager and VPC Endpoint with the familiar GUI-based experience</span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I demonstrate <span style="text-decoration: underline">how to configure</span> the required AWS Cloud services to <span style="text-decoration: underline">enable RDP access</span> to an Amazon EC2 instance for Windows using Fleet Manager.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested and want to follow along, I have the code in my <code><a href="https://github.com/kunduso/ec2-userdata-terraform/blob/enable-rdp-session-manager" target="_blank" rel="noopener">GitHub repository: ec2-userdata-terraform</a></code>. Please ensure you are on the right git branch – <code><span style="font-size: 15px"><span style="color: #0047ab">enable-rdp-session-manager</span></span></code>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The following <span style="text-decoration: underline">eight steps</span> are required to create an Amazon EC2 instance for Windows with RDP access using Session Manager and VPC endpoint.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create an Amazon VPC with enabled DNS hostnames and support</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create a security group with ingress on only <code><span style="font-size: 15px"><span style="color: #0047ab">port# 443</span></span></code> for the VPC Endpoint</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Create VPC Endpoints for <code><span style="font-size: 15px"><span style="color: #0047ab">ssm</span></span></code>, <code><span style="font-size: 15px"><span style="color: #0047ab">ec2messages</span></span></code>, and <code><span style="font-size: 15px"><span style="color: #0047ab">ssmmessages</span></span></code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Create a security group for the Amazon EC2 instance to allow ingress from the VPC Endpoint security group</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">5. Create and attach an IAM policy to enable access to the Amazon EC2 instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">6. Create a Password for the Windows User</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">7. Create a User Data script to add a user to the Windows instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">8. Create an Amazon EC2 instance for Windows</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I discussed four of these eight steps in detail in my previous note <a href="https://skundunotes.com/2023/12/27/create-an-amazon-ec2-instance-using-terraform-with-session-manager-access-using-vpc-endpoint/" target="_blank" rel="noopener"> -create-an-amazon-ec2-instance-using-terraform-with-session-manager-access-using-vpc-endpoint</a>. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I'll discuss the rest of the steps here.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">5. Create and attach an IAM policy to enable access to the Amazon EC2 instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In one of my previous notes, I demonstrated <a href="https://skundunotes.com/2021/11/16/attach-iam-role-to-aws-ec2-instance-using-terraform/" target="_blank" rel="noopener">how to create and attach an IAM role to an Amazon EC2 instance using Terraform</a>. If you are new to it, that note walks through the basics of the concept. Per <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/fleet-rdp.html#fleet-rdp-iam-policy-examples" target="_blank" rel="noopener">AWS-Docs</a>, the IAM role requires additional permissions to allow RDP access via Session Manager. The below image contains a section of the IAM policy statement.</span></span></span>
<img class="alignnone size-full wp-image-4497" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-1.png" alt="98-image-1" width="572" height="639" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that there are other required permissions that you may access in the GitHub code <code><span style="font-size: 15px"><span style="color: #0047ab">repository → iamrole.tf</span></span></code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After creating the <code><span style="font-size: 15px"><span style="color: #0047ab">aws_iam_policy</span></span></code>, I attached that policy to the IAM role the Amazon EC2 instance assumed.</span></span></span>
<img class="alignnone size-full wp-image-4498" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-2.png" alt="98-image-2" width="489" height="100" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">6. Create a Password for the Windows User</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created a random password using the <code><span style="font-size: 15px"><span style="color: #0047ab">random {}</span></span></code> provider and stored that as an Amazon Systems Manager Parameter Store parameter.</span></span></span>
<img class="alignnone size-full wp-image-4499" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-3.png" alt="98-image-3" width="714" height="276" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">7. Create a User Data script to add a user to the Windows instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The User Data script adds a Windows User to the Amazon EC2 instance and then adds that user to the Administrators group using the PowerShell code below.</span></span></span>
<img class="alignnone size-full wp-image-4500" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-4.png" alt="98-image-4" width="670" height="309" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that this is not the complete code and that you may access it in the GitHub code <code><span style="font-size: 15px"><span style="color: #0047ab">repository → user_data → user_data.tpl</span></span></code>.</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">8. Create an Amazon EC2 instance for Windows</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I created an Amazon EC2 instance with the configuration properties determined in the previous steps.</span></span></span>
<img class="alignnone size-full wp-image-4501" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-5.png" alt="98-image-5" width="596" height="312" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code><span style="font-size: 15px"><span style="color: #0047ab">iam_instance_profile</span></span></code> property provides the Amazon EC2 instance with the IAM role and permissions to allow RDP access. The <code><span style="font-size: 15px"><span style="color: #0047ab">user_data</span></span></code> property provides the PowerShell template file and passes the user password stored in the Systems Manager Parameter Store parameter.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that <span style="text-decoration: underline">no public IP address</span> is associated with the Amazon EC2 instance.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After Terraform provisioned all the resources, I waited 5 minutes before connecting to the Amazon EC2 instance from the AWS Console. That was sufficient time for the Amazon EC2 instance user data script to create the Windows user.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>As of July 2024,</strong> there are two ways to connect to the Amazon EC2 instance to use RDP. From the AWS Console, search for AWS Systems Manager → Node Management → Fleet Manager. Your Amazon EC2 instance must be listed here. Select the instance, and on the right-hand side, choose under Node actions → Connect → Connect with Remote Desktop.</span></span></span>
<img class="alignnone size-full wp-image-4502" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-6.png" alt="98-image-6" width="786" height="540" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">From the User Data script, you can examine that the User name was User03. The Password value was stored as a Systems Manager Parameter Store parameter. I submitted both inputs and clicked on Connect.</span></span></span>
<img class="alignnone size-full wp-image-4503" src="https://skundunotes.com/wp-content/uploads/2024/07/98-image-7.png" alt="98-image-7" width="781" height="613" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that is how you, too, can connect to an Amazon EC2 instance using RDP.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">By leveraging AWS Fleet Manager, you can now <span style="text-decoration: underline">securely RDP</span> into your Amazon EC2 instances for Windows <span style="text-decoration: underline">without needing a public IP address</span> or complex network configurations. This approach offers the <span style="text-decoration: underline">best of both worlds</span>  - the security of Session Manager and the familiar GUI-based experience that Windows Administrators are accustomed to. While the limitation of the 60-minute session is something to consider, there are potential workarounds you can explore. Please try this setup and let me know if you have any questions or feedback. Stay tuned for more cloud-related content, and remember to subscribe to my blog for the latest updates. Happy cloud computing!</span></span></span>
