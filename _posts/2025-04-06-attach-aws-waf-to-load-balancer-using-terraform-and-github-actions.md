---
title: "Attach AWS WAF to load balancer using Terraform and GitHub Actions"
date: 2025-04-06 09:09:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Public-facing load balancers are vulnerable to attacks, including DDoS, SQL injection, cross-site scripting (XSS), and bot attacks. These attacks can degrade the load balancer's performance, rendering it unavailable to legitimate users and <span style="text-decoration: underline">negatively impacting business operations</span>.</span></span></span>
<!--more-->

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>AWS Web Application Firewall (WAF)</strong> is a service designed to protect resources like load balancers, Amazon CloudFront distributions, API Gateway, and other web-facing services from external threats, such as DDoS attacks, SQL injection, cross-site scripting (XSS), and bot traffic. For example, when AWS WAF integrates with an Application Load Balancer (ALB), all incoming HTTP/HTTPS traffic passes through AWS WAF before reaching the load balancer. This makes AWS WAF the <span style="text-decoration: underline">first line of defense</span> for the load balancer. It checks each HTTP/HTTPS request against a set of rules to decide whether to allow or block the traffic.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, you will learn how to <span style="text-decoration: underline">protect a public-facing load balancer</span> by attaching an AWS WAF. This use case follows DevOps <span style="text-decoration: underline">best practices</span> by creating the required AWS cloud resources using Terraform (IAC) and automating the deployment using GitHub actions.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested and want to follow along, please refer to the <a href="https://github.com/kunduso/add-aws-elb-ec2-private-subnet-terraform/tree/add-waf" target="_blank" rel="noopener"><span style="color: #0000ff">GitHub repository: kunduso/add-aws-elb-ec2-private-subnet-terraform</span></a>. <span style="color: #ff0000">Please note the branch name is</span> <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">add-waf</code>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note builds upon a previous use case where a load balancer was attached to three Amazon EC2 instances. That architecture adhered to secure practices by placing the EC2 instances in a private subnet and allowing access through a load balancer security group in the public subnet. A private subnet is defined as one with no direct routes to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code> via the Internet Gateway. In that use case, the EC2 instances utilized NAT gateways in their respective availability zones to access the Internet (e.g., for downloading packages). The load balancer, on the other hand, was in the public subnet, which was attached to an Internet Gateway.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, the load balancer in that setup lacked adequate protection, which is addressed in this use case.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">When <strong>AWS WAF</strong> is attached to a load balancer, it collects data related to incoming web requests directed at it, such as request metadata, IP addresses, HTTP headers, and any detected malicious activity. This data is logged and stored in <strong>Amazon CloudWatch</strong> for monitoring and analysis.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As per security best practices, <strong>Amazon CloudWatch Logs</strong> must be encrypted using a <strong>KMS (Key Management Service) key</strong> to maintain their confidentiality and integrity.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Additionally, security best practices dictate that the <strong>KMS key</strong> must be configured with a <span style="text-decoration: underline">specific permission policy</span> tailored to its intended usage. This practice ensures that only authorized users and services can access and use the key for encryption and decryption operations.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Tying all these security best practices together and building on the load balancer from the previous use case, this use case involves <strong>(1)</strong> creating a KMS key and attaching a KMS key policy, <strong>(2)</strong> creating a CloudWatch log group and encrypting it with the KMS key, <strong>(3)</strong> creating an AWS WAF with a set of custom rules, <strong>(4)</strong> attaching the AWS WAF to the load balancer, and <strong>(5)</strong> configuring the AWS WAF to send all logs to the CloudWatch log group for analysis.</span></span></span>
<img class="alignnone size-large wp-image-6000" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-9.png?w=656" alt="" width="656" height="288" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let us dive deeper into these steps.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create a KMS key and a KMS key policy</span></span></span></strong>
<img class="alignnone size-full wp-image-5992" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-1.png" alt="" width="602" height="294" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This Terraform code creates an AWS KMS key and a key policy to <span style="text-decoration: underline">encrypt WAF logs</span> stored in CloudWatch Logs.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create an Amazon CloudWatch log group</span></span></span></strong>
<img class="alignnone size-full wp-image-5993" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-2.png" alt="" width="483" height="108" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this step, Terraform creates a CloudWatch Log Group to store the AWS WAF logs with a one-year retention period. The log group is configured with server-side encryption using the specified KMS key (created in the previous step), ensuring that all stored WAF logs are <span style="text-decoration: underline">encrypted at rest for enhanced security</span>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Create an AWS WAF with a set of custom rules</span></span></span></strong>
<img class="alignnone size-full wp-image-5994" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-3.png" alt="" width="358" height="171" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS WAF web ACL resource is configured with a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">REGIONAL</code> scope for protecting Application Load Balancers, with a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">default_action</code> to allow traffic that doesn't match any rules.</span></span></span>
<img class="alignnone size-full wp-image-5995" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-4.png" alt="" width="537" height="186" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">AWS WAF also implements multiple layers of protection through <span style="text-decoration: underline">five prioritized rules</span>: <strong>AWS-managed rules</strong> for known bad inputs (including Log4j protection), common threats, and SQL injection prevention, along with custom rules for rate limiting (2000 requests per IP) and geographic blocking.</span></span></span>
<img class="alignnone size-full wp-image-5996" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-5.png" alt="" width="491" height="108" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The web ACL also enables visibility through CloudWatch metrics and request sampling, which allows for monitoring and analyzing the web traffic patterns.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Attach the AWS WAF to the load balancer</span></span></span></strong>
<img class="alignnone size-full wp-image-5997" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-6.png" alt="" width="424" height="84" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This Terraform code creates the association between the AWS WAF web ACL and the Application Load Balancer, essentially linking these resources so that all traffic to the ALB is first inspected by the WAF rules defined.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">5. Configure AWS WAF to send all logs to the CloudWatch log group for analysis</span></span></span></strong>
<img class="alignnone size-full wp-image-5998" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-7.png" alt="" width="480" height="417" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, in this step, the Terraform code configures logging for the AWS WAF web ACL, sending logs to a CloudWatch Log Group. The logging filter is set to keep all logs by default, with a specific filter to ensure that blocked requests are logged. This helps monitor and analyze security events where WAF has blocked potentially malicious traffic.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Terraform code was deployed automatically with GitHub Actions to provision all the required AWS cloud resources. Once AWS WAF was successfully attached to the load balancer, the traffic overview was available on the AWS Console → AWS WAF → Web ACLs → Select ACL.</span></span></span>
<img class="alignnone size-large wp-image-5999" src="https://skdevops.wordpress.com/wp-content/uploads/2025/04/113-image-8.png?w=656" alt="" width="656" height="230" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Several other dashboards were also available that analyzed the traffic based on whether <span style="text-decoration: underline">a bot was detected, the client device type, attack types, the country of origin of the request, and more.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Each client request to the load balancer generates detailed logs that capture request metadata, threat detection, and the corresponding WAF actions. These logs are securely stored in Amazon CloudWatch for ongoing analysis.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This step ensures that cloud engineering teams can create effective rules in AWS WAF over time after evaluating the data generated from client requests to ensure the underlying compute (load balancer) is protected and available to serve genuine requests. This process ensures that the load balancer <span style="text-decoration: underline">remains resilient against threats, guaranteeing a seamless user experience and maintaining business continuity even during traffic spikes or attacks</span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you have any questions or feedback, please use the comments section below. This note is part of a series on elastic load balancing. To learn more, please click on the links below.</span></span></span>

<a href="https://skundunotes.com/2022/07/30/add-an-application-load-balancer-to-aws-ec2-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Add an application load balancer to Amazon EC2 using Terraform</span></span></span></a>
<a href="https://skundunotes.com/2023/07/26/attach-an-application-load-balancer-to-amazon-ec2-instances-in-a-private-subnet/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Add an application load balancer to Amazon EC2 instances in a private subnet</span></span></span></a>
<a href="https://skundunotes.com/2023/09/12/create-amazon-ec2-auto-scaling-group-and-load-balancer-using-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Create an Amazon EC2 Auto Scaling group and load balancer using Terraform and GitHub Actions</span></span></span></a>
<a href="https://skundunotes.com/2025/03/25/automate-amazon-route-53-hosted-zone-acm-and-load-balancer-provisioning-with-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Automate Amazon Route 53 hosted zone, ACM, and Load Balancer provisioning with Terraform and GitHub Actions</span></span></span></a>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are using an external load balancer, how was your experience after enabling AWS WAF?</span></span></span>
