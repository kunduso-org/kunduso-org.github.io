---
title: "Terraform workspace with multiple AWS accounts"
date: 2021-06-19 06:31:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">My objective was to use Terraform to provision resources across environments in the AWS cloud infrastructure. Following a typical CI/CD model, my idea was to build once and deploy multiple. Since there was nothing to build in terraform, I wanted to apply the same terraform code across all environments. So I thought, let's run <code>terraform init</code> and <code>terraform validate</code> inside a CI build and package that into an artifact. The package would also contain the <code>.terraform</code> folder where versioned modules and provider plugins referenced by the terraform configuration are stored. By including the <code>.terraform</code> folder, I ensured that the configuration was the same across all environments. <i>There are pros and cons on whether to include that folder in the build artifact</i>. Then, on the CD side, I thought that I'd run <code>terraform plan</code> and <code>terraform apply</code> on the same package. If you want to read, I ideated on that approach in my <span style="text-decoration: underline"><a href="https://skundunotes.com/2021/06/18/ci-cd-using-terraform-and-azure-pipelines-ideation/" target="_blank" rel="noopener">previous note</a></span> and listed the limitation. The solution was to use <strong>terraform workspace.</strong></span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There is already a good amount of information related to terraform workspace available, and hence, I am keeping out of discussing the concept behind it. In this (part one of a two part) note, I explore the idea of integrating terraform workspace usage with Azure DevOps pipelines. In part two, I have a detailed <a href="https://skundunotes.com/2021/07/10/ci-cd-of-terraform-workspace-with-yaml-based-azure-pipelines/" target="_blank" rel="noopener"><span style="text-decoration: underline">walkthrough of the automation process</span></a>. If you are new to terraform workspace, I'd suggest reading <strong><span style="text-decoration: underline"><a href="https://www.terraform.io/docs/cli/workspaces/index.html#the-purpose-of-workspaces" target="_blank" rel="noopener">this article</a></span></strong> and also familiarizing yourself with the <a href="https://www.terraform.io/docs/cli/commands/workspace/index.html" target="_blank" rel="noopener"><strong><span style="text-decoration: underline">workspace commands.</span></strong></a></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is another interesting note on <strong><span style="text-decoration: underline"><a href="https://www.terraform.io/docs/language/state/workspaces.html#workspace-internals" target="_blank" rel="noopener">workspace internals</a></span></strong>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let me expand on the use case I was working on to achieve this integration objective. I wanted to provision an Amazon VPC and subnets for three environments -Dev, Test, and Prod. And I want to use the same Terraform configuration (files) to provision these resources. These environments belonged to different AWS accounts... So Dev was a separate AWS account, Test was a separate AWS account, and so was Prod. Also, I used Azure DevOps pipelines for automation (in part two. I will provide the URL here once that is ready).</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In all my previous terraform projects, I did not have to access across AWS accounts. The idea in this project, was to automate terraform using the credentials of an AWS IAM user in a separate AWS account (let's call it Automation account) and be able to provision resources in -Dev, Test, and Prod AWS accounts. AWS IAM has a concept associated with such a use case, which creates a trust relationship between two accounts. I have a detailed note on that at<a href="https://skundunotes.com/2021/06/05/creating-iam-assume-role-relationship-between-two-aws-accounts/" target="_blank" rel="noopener"> Creating IAM assume-role relationship between two AWS accounts.</a></span></span></span>

<img class="alignnone size-full wp-image-1319" src="https://skundunotes.com/wp-content/uploads/2021/06/43.-image-2.png" alt="43. image-2" width="592" height="302" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have committed the code to my GitHub repository  -<span style="text-decoration: underline"><a href="https://github.com/kunduso/Working-with-Terraform-workspace-and-AWS" target="_blank" rel="noopener">Working-with-Terraform-workspace-and-AWS</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">While navigating through the code, I want to mention a few necessary concepts.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Using terraform.workspace local variable:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the previous links on terraform workspace, per HashiCorp Docs, every initialized working directory has at least one workspace (If you haven't created other workspaces, it is a workspace named <em>default</em> ). Hence after initialization, the value of <code>terraform.workspace</code> is `default`. Type terraform <code>workspace list</code> to check which workspace is selected. The selected workspace will have a * against its name. However, while using terraform, you can select a specific workspace before you proceed with managing resources if there are workspaces already created. The value of <code>terraform.workspace</code> is the value we set at last <code>terraform workspace select $(workspacename)</code> or <code>terraform workspace new $(workspacename)</code></span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">At any particular time, there is only one workspace that is active in a repository.</span></span></span></strong>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Map variable type and associated lookup() functions:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the <strong>"variables.tf"</strong> source file there are three variables of type = map. These are key-value pairs. The <a href="https://www.terraform.io/docs/language/functions/lookup.html">lookup function ()</a> is used to pass the key to the variable and receive the value/s in return. In this case, we pass the value of <code>terraform.workspace</code> as key, and hence all the variables have values specifically for Dev, Test, and Prod. For this reason, it is suggested that we create three separate workspaces named  -Dev, Test, and Prod.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Assume role:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I haven't seen a better article than the one below to explain this concept. I would highly recommend going through that to understand how to use <span style="text-decoration: underline"><a href="https://support.hashicorp.com/hc/en-us/articles/360041289933-Using-AWS-AssumeRole-with-the-AWS-Terraform-Provider" target="_blank" rel="noopener">AWS assume-role to provision resources in multiple AWS accounts</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this project, in the <strong>"provider.tf"</strong> source file, you will see that I am selecting the <code>role_arn</code> based on the selected workspace. That way, I can map roles from separate accounts to separate environments. For example, the user in the Automation account (which is the Trusted account) will have permission to take on a role in one of the Trusting accounts -Dev, Test, and Prod, depending on the value of the key (<code>terraform.workspace</code>) we pass. I then used the Automation account's user access and secret key to provision resources across the three AWS accounts.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to give this a try, please go through the steps below to work with the code.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create a Trust relationship between multiple AWS accounts.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this project, we have three environment accounts and one Automation account. Create a trust relationship between the Automation account user and the three environment accounts. I have a separate note on how to create that at  -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/06/05/creating-iam-assume-role-relationship-between-two-aws-accounts/" target="_blank" rel="noopener">create trust relationship between AWS accounts</a>.</span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create an Amazon S3 bucket and an Amazon DynamoDB table in the Automation account to store the remote state.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to this, please go through my note on the same at  -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/04/03/create-terraform-pre-requisites-for-aws-using-aws-cli-in-3-easy-steps/" target="_blank" rel="noopener">create terraform pre-requisites</a></span>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Initialize with <code>terraform init</code></span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After you get a copy of the code, populate the variables correctly and initialize the code with the command below.</span></span></span>

https://gist.github.com/kunduso/2729ebec0fc88fc58862f9fcd88d59f1

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Check <code>workspace</code></span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Run <code>terraform workspace list</code> to identify which is the current workspace. There is an asterisk (*) next to the current workspace.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Create a new workspace</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Run <code>terraform workspace new Dev</code> to create a new Dev workspace. OR, select a workspace if it is already created using <code>terraform workspace select $(workspacename)</code></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Run Terraform trio</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Run <code>terraform validate -&gt; plan -&gt; apply</code> to see how the resources are provisioned in the Dev AWS account.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To provision resources in the Test and Prod account, we must first change the workspace from Dev to Test or Prod. The below steps are to provision the resources in the Test account.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 7: Create a new Test workspace and select that</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Type <code>terraform workspace new Test</code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This way, we shift into the Test workspace. For confirmation, type <code>terraform workspace list</code> and see where the asterisk is (*).</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step8 : Run Terraform tri0</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Run <code>terraform validate -&gt; plan -&gt; apply</code> to see how the resources are provisioned in the Test AWS account.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Similarly, you can run the same sequence of commands to provision resources in the Prod AWS account.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Observation:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Amazon S3 bucket where the state file is stored <em>has a different structure</em>. Now you will see there is an extra level <strong>env:</strong> to separate the resources from one workspace to another.</span></span></span>

<img class="alignnone size-full wp-image-1320" src="https://skundunotes.com/wp-content/uploads/2021/06/43.-image-3.png" alt="43. image-3" width="776" height="489" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the above configuration, the S3 bucket name value in <strong>backend.tf</strong> was set to <strong>"terraform-project4-vpc-peering"</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Resources created in the Dev account <strong>do not conflict</strong> with the Test or the Prod account or vis-versa. Meaning, using the same terraform configuration, <strong>we can now create and manage resources in multiple AWS accounts.</strong> Stated differently, Dev and Test account <strong>resources do not get destroyed if we provision resources in Prod account.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Also, using <strong>AWS assume-role</strong> feature with trusting relationships across multiple AWS accounts ensures we are not using separate AWS credentials to work with different AWS accounts and instead are <strong>working with only one set of credentials.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note useful, and let me know if there are any questions or suggestions.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested in reading about working with terraform workspace in an automated scenario, check my next note -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/07/10/ci-cd-of-terraform-workspace-with-yaml-based-azure-pipelines/" target="_blank" rel="noopener">CI/CD of Terraform workspace with YAML based Azure Pipelines</a></span>.</span></span></span>
