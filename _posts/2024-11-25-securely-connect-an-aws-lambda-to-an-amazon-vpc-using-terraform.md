---
title: "Securely Connect an AWS Lambda to an Amazon VPC Using Terraform"
date: 2024-11-25 04:17:49 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Amazon Virtual Private Cloud (VPC)</strong> is a service that allows cloud engineering teams to create a private network within the Amazon Web Services (AWS) cloud. It enables them to define a virtual network environment, including IP address ranges, subnets, and route tables while providing <span style="text-decoration: underline">control over network configuration and security</span>.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>AWS Lambda</strong> is a serverless computing service that allows cloud engineers to run code in response to events <span style="text-decoration: underline">without provisioning or managing servers</span>. AWS Lambda functions run in a managed, serverless environment provided by AWS, which is not tied to a specific VPC unless configured that way. By default, the Lambda functions can access the Internet and AWS services without being constrained to a VPC. This capability allows them to operate seamlessly without needing user-defined infrastructure management.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, <span style="text-decoration: underline">AWS Lambda can be connected to a custom Amazon Virtual Private Cloud (VPC)</span>. Connecting AWS Lambda to an Amazon VPC provides <strong>enhanced security</strong> by allowing cloud engineering teams to control access to resources through VPC <span style="text-decoration: underline">security groups</span> and network access control lists (ACLs). It also enables the Lambda functions to connect to private resources, such as databases and internal services, without exposing them to the public Internet. Additionally, deploying Lambda within a VPC can improve compliance with <span style="text-decoration: underline">regulatory requirements</span> by keeping data within a defined network boundary.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are a <strong>few factors</strong> to consider when connecting an AWS Lambda to an Amazon VPC. I will discuss them in this note and review the Terraform code for this use case. If you are interested and want to follow along, here is the link to my <a href="https://github.com/kunduso/add-aws-lambda-terraform/tree/add-vpc" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub repository: kunduso/add-aws-lambda-terraform</span></span></span></a>. Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = add-vpc</code>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will be deriving heavily from the Terraform <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS Provider documentation</span></span></span></a> for Lambda.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Also, please check  <a href="https://skundunotes.com/2024/06/18/automating-aws-lambda-deployment-harnessing-terraform-github-actions-and-python-for-cloudwatch-logging/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">-automating-aws-lambda-deployment-harnessing-terraform-github-actions-and-python-for-cloudwatch-logging</span></span></span></a>, where I discussed how to provision a Lambda function using Terraform.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Subnet and Security Groups Configuration</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These two properties are defined in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">vpc_config</code> property of the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_lambda_function</code> Terraform resource definition.
<img class="alignnone size-full wp-image-5122" src="https://skundunotes.com/wp-content/uploads/2024/11/106-image-1.png" alt="106-image-1" width="631" height="84" /></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">subnet_ids</code> stores a list of subnets where several instances of a Lambda function can be hosted. Ideally, it is preferred to assign private subnets if the Lambda functions do not need public internet access. A private subnet does not have a route to the Internet (<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">0.0.0.0/0</code>) via an Internet Gateway. Similarly, the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">security_group_ids</code> are a list of security groups that are applied to manage communication with the Lambda function to control inbound and outbound traffic, allowing the Lambda function to communicate with other resources in the VPC. The security group ingress and egress rules determine which protocol, port, and addresses the Lambda can communicate with.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. VPC Endpoint Configuration</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A VPC endpoint is a network component that allows private connections between the Virtual Private Cloud (VPC) and supported AWS services without using public IPs or traversing the Internet. It improves security and performance by enabling direct, secure access to services like S3, DynamoDB, or private service links within the AWS network. So, if the Lambda function requires access to AWS services like S3 or DynamoDB, VPC endpoints can be used to avoid public internet traffic.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Below is an example of a VPC endpoint configuration. As you can examine, an <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_vpc_endpoint</code> resource requires the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">vpc_id</code>, the AWS <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">service_name</code> (which is CloudWatch Logs in this case), the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">endpoint_type</code> (Gateway or Interface), the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">subnet_ids</code> to associate with the endpoint and the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">security_group_ids</code> to manage secure communication with the endpoint. The snippet below also contains the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_security_group</code> and <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_security_group_rule</code> to manage communication with the endpoint.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this case, the VPC endpoint and the Lambda function are hosted in the same subnets.</span></span></span>
<img class="alignnone size-full wp-image-5123" src="https://skundunotes.com/wp-content/uploads/2024/11/106-image-2.png" alt="106-image-2" width="782" height="520" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can read more about that at -<a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc-endpoints.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">configuration-vpc-endpoints</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. IAM Role Configuration</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An AWS Lambda function requires an IAM role to access resources within a VPC. The IAM role needs the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">AWSLambdaVPCAccessExecutionRole</code> policy, which grants the necessary permissions to create and manage network interfaces in the VPC. This role ensures that the Lambda function can securely communicate with resources like RDS, EC2, and other services inside the VPC. The code snippet below shows how to attach the managed policy with the role.</span></span></span>
<img class="alignnone size-full wp-image-5124" src="https://skundunotes.com/wp-content/uploads/2024/11/106-image-3.png" alt="106-image-3" width="816" height="269" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And, under the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_lambda_function</code> resource, the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">role</code> property determines the ARN of the IAM role with the attached managed policy discussed above.</span></span></span>
<img class="alignnone size-full wp-image-5125" src="https://skundunotes.com/wp-content/uploads/2024/11/106-image-4.png" alt="106-image-4" width="809" height="350" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can read more about that at  -<a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AWSLambdaVPCAccessExecutionRole.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWSLambdaVPCAccessExecutionRole</span></span></span></a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With these three configuration changes, the cloud engineering team can smoothly and securely host the AWS Lambda function inside a VPC. After implementing these changes, I navigated to AWS Console and searched for Lambda -&gt; selected the Lambda function  -&gt; Configurations  -&gt; VPC to view the network configurations along with the security group ingress and egress rules applied to the Lambda function.</span></span></span>
<img class="alignnone size-full wp-image-5134" src="https://skundunotes.com/wp-content/uploads/2024/11/106-image-5.png" alt="106-image-5" width="925" height="524" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested in learning more, please check -<a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">giving Lambda functions access to resources in an Amazon VPC</span></span></span></a>. If you have any questions or suggestions, please do not hesitate to contact me via the comments below.</span></span></span>
