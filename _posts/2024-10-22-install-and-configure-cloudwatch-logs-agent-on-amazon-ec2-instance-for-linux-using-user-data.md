---
title: "Install and configure CloudWatch Logs agent on Amazon EC2 instance for Linux using user data"
date: 2024-10-22 03:16:13 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline">Amazon CloudWatch Logs Agent</span> is a software component installed on servers that allows Cloud Engineering teams to monitor and collect log files from the servers and applications in real time. It sends log data to <span style="text-decoration: underline">Amazon CloudWatch Logs</span>, where they can be analyzed, searched, and visualized, thus making it easier to troubleshoot issues and monitor system performance. The agent uses a <span style="text-decoration: underline">configuration file</span> to specify which log files to monitor, log group and log streams to send logs, metrics collection details, append and aggregation dimensions, and specific metrics like CPU, memory, disk usage, and log file paths.</span></span></span>
<!--more-->

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I demonstrate how to install and configure the AWS CloudWatch Logs Agent on an Amazon EC2 instance for <span style="text-decoration: underline">Linux using the user data script and Terraform</span>. The logic inside the user data script is to:</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Download and install the Amazon CloudWatch Logs agent installer.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Download the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">config.json</code> from the SSM Parameter store and store it locally</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Configure and start the CloudWatch Logs agent service.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: If you want to examine how to install and configure the Amazon CloudWatch Logs agent on an <span style="text-decoration: underline">Amazon EC2 instance for Windows</span> using the user data script, head over to -<a href="https://skundunotes.com/2024/07/16/install-and-configure-cloudwatch-logs-agent-on-amazon-ec2-instance-for-windows-using-user-data/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">install-and-configure-cloudwatch-logs-agent-on-amazon-ec2-instance-for-windows-using-user-data</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I separated this use case into eight high-level steps for ease of understanding.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> Create the network components</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2.</strong> Create the security group and egress rule</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> Create an Amazon KMS key and policy</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4.</strong> Create an Amazon CloudWatch Logs Group</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5.</strong> Create an AWS Systems Manager Parameter Store parameter</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>6.</strong> Create an IAM role to attach the Amazon EC2 instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>7.</strong> Update the user data script to install and configure the CloudWatch Logs agent</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>8.</strong> Create the Amazon EC2 instance</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to follow along, please refer to the Terraform code in my <a href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-cloudwatch-agent-linux-ec2" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub repository: kunduso/ec2-userdata-terraform</span></span></span></a>. Please note that the<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = add-cloudwatch-agent-linux-ec2</code>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create the network stack</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The network components include the Amazon VPC, a public subnet, a route table, an Internet gateway, and a route in the route table to the Internet using the Internet gateway.</span></span></span>
<img class="alignnone size-full wp-image-4944" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-1.png" alt="103-image-1" width="1055" height="469" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create the security group and egress rule</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Only one egress rule is attached to the Security Group, which enables traffic from the VPC to access the Internet (using the Internet gateway).</span></span></span>
<img class="alignnone size-full wp-image-4945" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-2.png" alt="103-image-2" width="1142" height="442" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create an Amazon KMS key and policy</span></span></span></strong>
<img class="alignnone size-full wp-image-4946" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-3.png" alt="103-image-3" width="1074" height="618" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS KMS Key encrypts the data stored in the AWS Systems Manager Parameter Store parameter and the AWS CloudWatch Logs. I provisioned a tighter KMS key policy specifically for this use case using the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_kms_key_policy</code>. Please note that adding the AWS KMS key, although optional, helps create a secure solution.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an Amazon CloudWatch Logs Group</span></span></span></strong>
<img class="alignnone size-full wp-image-4947" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-4.png" alt="103-image-4" width="507" height="106" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The logs group stores logs sent by the CloudWatch Logs agent running on the Amazon EC2 instance and is encrypted using the custom KMS key.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Create an AWS Systems Manager Parameter Store parameter</span></span></span></strong>
<img class="alignnone size-full wp-image-4948" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-5.png" alt="103-image-5" width="1100" height="366" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The CloudWatch Logs agent accepts a JSON file with keys and values to configure the service. The JSON file is stored inside the AWS Systems Manager Parameter and downloaded into the Amazon EC2 instance by the logic in the user data script. The data in the parameter store is encrypted using the custom KMS key. This file is stored as a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">.tftpl</code> file in the code repository since it has a variable reference to the AWS CloudWatch Log group name.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Create an IAM role to attach the Amazon EC2 instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I explained the logic of attaching an IAM role to an Amazon EC2 instance in my note <a href="https://skundunotes.com/2021/11/16/attach-iam-role-to-aws-ec2-instance-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">attach-iam-role-to-amazon-ec2-instance</span></span></span></a>. The IAM role attached to the Amazon EC2 instance requires an <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">assume_role_policy</code>. It also requires a list of managed and custom policies. <strong>These are:</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(a)</strong> A custom policy that allows access to the SSM Parameter Store parameter and decrypts it using the custom KMS key.</span></span></span>
<img class="alignnone size-full wp-image-4949" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-6.png" alt="103-image-6" width="550" height="386" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(b)</strong> A managed policy <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy</code> that allows the Amazon EC2 instance to send custom logs from the instance to Amazon CloudWatch.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>(c)</strong> Optionally, you may attach the managed policy <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore</code> to enable a Cloud Engineer to log into the Amazon EC2 instance using Session Manager from the AWS Cloud console for verification or debugging purposes. For details, please refer to this note  <a href="https://skundunotes.com/2023/08/27/provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">-access-amazon-ec2-instance-using-session-manager</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Update the user data script to install and configure the CloudWatch Logs agent</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The user data script is located as a template file in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">user_data</code> folder. The script is configured to download and install the Amazon CloudWatch Logs agent. Then, it connects to the SSM Parameter Store parameter, downloads the parameter value, decrypts it using the custom KMS key, and stores it as a JSON file on the Amazon EC2 instance. Then, it configures the Amazon CloudWatch Logs agent by passing the JSON file and starts the service.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 7: Create the Amazon EC2 instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last step is to create the Amazon EC2 instance with the properties specified in the previous steps, like the security group, the subnet ID, the instance profile, and the user data script. As shown in the image below, the user data script accepts an SSM Parameter Store parameter name. This parameter is referenced in the user data script to download the JSON configuration file for the Amazon CloudWatch Logs agent. I also enabled the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">metadata_options {}</code> to follow best practices, enhancing security and control over instance metadata access.</span></span></span>
<img class="alignnone size-full wp-image-4950" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-7.png" alt="103-image-7" width="646" height="520" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After Terraform provisioned all the resources, I waited a few minutes before accessing the Amazon CloudWatch log group from the AWS Console. That was sufficient time for the Amazon EC2 instance user data script to download the installers, install and configure the CloudWatch Logs agent service, and send the logs to CloudWatch Logs.</span></span></span>
<img class="alignnone size-full wp-image-4951" src="https://skundunotes.com/wp-content/uploads/2024/10/103-image-8.png" alt="103-image-8" width="682" height="437" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Best Practices</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I implemented a few best practices, such as:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> Attaching an IAM role with Amazon EC2 instance.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2.</strong> Using least privilege IAM permissions.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> No ingress rule for any IP address on any ports.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4.</strong> Automate the installation process via the idempotent user data PowerShell script.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5.</strong> Use the IMDv2 metadata options in Amazon EC2 to enhance security and control over instance metadata access.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>6.</strong> Attach a secure KMS key policy instead of using the default key policy</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>7.</strong> Encrypt the SSM Parameter Store parameter and CloudWatch Logs using KMS Key.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, there is one more best practice to consider when creating an Amazon EC2 instance:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Remove public IP address:</strong> The Amazon EC2 instance has a public IP address since it requires Internet access to download the CloudWatch Logs agent installer. However, suppose the installer was stored in an Amazon S3 bucket (such as the Amazon CloudWatch agent installer). We could use a VPC Endpoint to access the installer in that case. That way, the EC2 instance won't require a public IP address. It is a security best practice to avoid having Amazon EC2 instances with public IP addresses because they can be reached from the Internet, making them vulnerable to attacks.</span></span></span>
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that I could have used a NAT gateway in this use case to prevent the Amazon EC2 instance from having a public IP address to access the Internet, but that would have deviated from the primary use case.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that concludes this note. If you have any questions or suggestions, please do not hesitate to contact me via the comments below.</span></span></span>
