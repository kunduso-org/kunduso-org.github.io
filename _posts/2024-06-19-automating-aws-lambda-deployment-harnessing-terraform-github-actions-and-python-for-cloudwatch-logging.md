---
title: "Automating AWS Lambda Deployment: Harnessing Terraform, GitHub Actions, and Python for CloudWatch Logging"
date: 2024-06-19 03:41:21 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/lambda/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>, AWS Lambda is a serverless computing service provided by Amazon Web Services (AWS) that allows developers to run code without provisioning or managing servers. With Lambda, you can execute code in response to events such as HTTP requests, database changes, or file uploads, scaling automatically with usage. It supports various programming languages and<span style="text-decoration: underline"> integrates seamlessly with other AWS services</span>, enabling flexible and cost-effective application development.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I demonstrate how to create an <strong>AWS Lambda function</strong> using <strong>Terraform </strong>and<strong> GitHub Actions</strong>. To add variety to the use case, I added three more functionalities:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Trigger the AWS Lambda function on a <span style="text-decoration: underline">schedule</span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. <span style="text-decoration: underline">Read a parameter value</span> from the AWS Systems Manager Parameter Store.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. <span style="text-decoration: underline">Log</span> the parameter value to the Amazon CloudWatch Log group log.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The use case's scheduling aspect is managed by the <span style="text-decoration: underline">Amazon EventBridge</span> scheduler. You can read more about that at <a href="https://docs.aws.amazon.com/scheduler/latest/UserGuide/what-is-scheduler.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs: EventBridge Scheduler</span></span></span></a>. You will also learn how I automated the provisioning process using GitHub Actions.</span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #3f6608">Please note that you probably won't require such a use case in a real development scenario. I've only combined three specific use cases to show how these AWS Cloud Services interact.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Pre-requisites:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since this note demonstrates communication between AWS Cloud services and GitHub Actions, I created an AWS IAM Role with a trust relationship with this GitHub repository. You can read about that at <a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">-create-an-open-ID-connect</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested in learning about how to integrate Terraform workflow with GitHub Actions, please check out the following note <a href="https://skundunotes.com/2023/03/07/ci-cd-with-terraform-and-github-actions-to-deploy-to-aws/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">-ci-cd-with-terraform-and-github-actions-to-deploy-to-aws</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let us now walk through all the resources provisioned in this repository. If you are interested and want to follow along, here is the link to my <a href="https://github.com/kunduso/add-aws-lambda-terraform/tree/add-lambda" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub repository: kunduso/add-aws-lambda-terraform</span></span></span></a>. Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = add-lambda</code>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an AWS KMS Key to encrypt</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this use case, two AWS cloud resources and an AWS cloud resource property require encryption: the AWS Systems Manager Parameter Store parameter, the Amazon CloudWatch log group, and the environment variable of the AWS Lambda function. These resources are encrypted using the AWS KMS key.</span></span></span>
<img class="alignnone size-full wp-image-4175" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-1.png" alt="95-image-1" width="722" height="266" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A key policy is attached to the AWS KMS key as a <span style="text-decoration: underline">security best practice</span>. Key policies are essential because they ensure that <span style="text-decoration: underline">only authorized entities</span> can access and use the cryptographic keys stored in KMS.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create an Amazon CloudWatch Log group and stream</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Amazon CloudWatch log group and log stream store the logs generated from the AWS Lambda function execution. The AWS Lambda function will log the Systems Manager Parameter Store parameter value into the log stream. The log group is encrypted using the AWS KMS key created in the previous step.</span></span></span>
<img class="alignnone size-full wp-image-4176" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-2.png" alt="95-image-2" width="796" height="262" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create an AWS Systems Manager Parameter Store parameter</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This is the AWS Cloud resource whose value the AWS Lambda function reads and then writes to the Amazon CloudWatch Log group's log stream.</span></span></span>
<img class="alignnone size-full wp-image-4177" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-3.png" alt="95-image-3" width="753" height="166" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an AWS IAM role and policy</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">AWS Lambda requires an IAM role to execute it. An IAM role has two policies: the <span style="text-decoration: underline">assume role policy</span> and the <span style="text-decoration: underline">permission policy</span>. The assume role policy states <span style="text-decoration: underline">who or what</span> can assume that role, and the permission policy states <span style="text-decoration: underline">what operations</span> that role can perform on which AWS cloud resources. Below is the code for the assume role policy, which states that the role can be assumed by the service principal <code><span style="font-size: 15px"><span style="color: #000000">lambda.amazonaws.com</span></span></code>.</span></span></span>
<img class="alignnone size-full wp-image-4178" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-4.png" alt="95-image-4" width="686" height="348" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Below is the code for the permissions role policy.</span></span></span>
<img class="alignnone size-full wp-image-4179" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-5.png" alt="95-image-5" width="449" height="633" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This permission policy provides specific access to only three resources: the Systems Manager Parameter Store parameter to access the parameter value, the Amazon CloudWatch log group to create a log stream and put the log events, and the AWS KMS key to decrypt the key.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You might wonder why I added the <code><span style="font-size: 15px"><span style="color: #000000">logs:CreateLogStream</span></span></code> statement, which was already covered in the previous step. I used the same Log group for this Lambda function's execution logs.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Create the python file</span></span></span></strong>
<img class="alignnone size-full wp-image-4180" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-6.png" alt="95-image-6" width="904" height="478" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Lambda function passes a few variables to the Python file, which, based on that, creates an <code><span style="font-size: 15px"><span style="color: #000000">ssm_client</span></span></code> and a <code><span style="font-size: 15px"><span style="color: #000000">logs_client</span></span></code> using the <code><span style="font-size: 15px"><span style="color: #000000">boto3</span></span></code> library. Then, the Python file reads the parameter value from the <code><span style="font-size: 15px"><span style="color: #000000">ssm_client</span></span></code> and writes that into <code><span style="font-size: 15px"><span style="color: #000000">logs_client</span></span></code>. It also logs a separate message to the Lambda function's execution log using the <code><span style="font-size: 15px"><span style="color: #000000">logging.info()</span></span></code> function.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Create the AWS Lambda</span></span></span></strong>
<img class="alignnone size-full wp-image-4181" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-7.png" alt="95-image-7" width="572" height="105" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Terraform creates a zip file using the <code><span style="font-size: 15px"><span style="color: #000000">archive_file</span></span></code> data. This zip file is then uploaded to the AWS Lambda function.</span></span></span>
<img class="alignnone size-full wp-image-4182" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-8.png" alt="95-image-8" width="636" height="588" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can examine from the preceding image, the AWS Lambda function consumes the Python file stored in the zip. It also requires the IAM role that we created previously. This IAM role provides limited access to the AWS Lambda function on operations that it can perform. The <code><span style="font-size: 15px"><span style="color: #000000">handler</span></span></code> lists where to start execution -<code><span style="font-size: 15px"><span style="color: #000000">PythonFileName.PythonFunctionName</span></span></code>. The AWS KMS key is required to encrypt the environment variables used in the function. The <code><span style="font-size: 15px"><span style="color: #000000">logging_config</span></span></code> stores the <code><span style="font-size: 15px"><span style="color: #000000">log_group</span></span></code> information to store the execution logs along with the <code><span style="font-size: 15px"><span style="color: #000000">log_format</span></span></code> and <code><span style="font-size: 15px"><span style="color: #000000">system_log_level</span></span></code>. Finally, the <code><span style="font-size: 15px"><span style="color: #000000">environment</span></span></code> variables pass the variables shared with the function.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 7: Create an Amazon EventBridge Scheduler</span></span></span></strong>
<img class="alignnone size-full wp-image-4183" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-9.png" alt="95-image-9" width="793" height="458" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The use case required the AWS Lambda to be triggered on a schedule. Three AWS Cloud resources are needed for that: the <code><span style="font-size: 15px"><span style="color: #000000">aws_cloudwatch_event_rule</span></span></code>, which determines the frequency, which is set to <code><span style="font-size: 15px"><span style="color: #000000">10 minutes</span></span></code>; the <code><span style="font-size: 15px"><span style="color: #000000">aws_cloudwatch_event_target</span></span></code>, which is set to the ARN of the AWS Lambda function; and finally, the <code><span style="font-size: 15px"><span style="color: #000000">aws_lambda_permission</span></span></code>, which enables the Amazon EventBridge Scheduler rule to invoke the AWS Lambda function.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once the GitHub Actions pipeline deployed these resources, I logged into my AWS Console and verified that all the resources were created successfully. I also found two log streams; one had logs from the Lambda function, and the other was from the Lambda execution. Below is an image of the log stream that the AWS Lambda function wrote using the <code><span style="font-size: 15px"><span style="color: #000000">put_log_events()</span></span></code> function.</span></span></span>
<img class="alignnone size-full wp-image-4184" src="https://skundunotes.com/wp-content/uploads/2024/06/95-image-10.png" alt="95-image-10" width="809" height="379" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As an experiment, you may change the value of the Systems Manager Parameter Store parameter and see what value is written to the Amazon CloudWatch log on its subsequent execution.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of this note. I hope you learned how to create an AWS Lambda function and other AWS services using Terraform and GitHub Actions. If you have any questions or suggestions, please feel free to reach out via the comments.</span></span></span>
