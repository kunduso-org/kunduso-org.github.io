---
title: "Implement pull request-based workflow using Terraform, Infracost, Checkov, and GitHub Actions"
date: 2023-07-18 20:15:59 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The software development process has continuously evolved over the past several years. The evolution process continued with the wide-scale availability of cloud platforms like AWS and Azure. We realized the practice of infrastructure as code (IAC) when the <strong>development practice of coding</strong> was merged with the <strong>operations practice of creating and managing cloud infrastructure.</strong> Then, with the infrastructure as code mindset, we realized benefits like <strong>versionable, repeatable, and testable processes.</strong> In this note, I explore the nuances of deploying an infrastructure change of operations process using the familiar <strong>pull request-based workflow</strong> of the development process.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As a reader of this note, you might be familiar with the development practice of using a pull request-based workflow. So that we are all on the same page, <strong>a pull request-based workflow encourages collaborative development within a team.</strong> It acts as a <strong>gate</strong> for new changes before merging them into the stable version of the product/application, which generally is managed via the <strong>project's branching-merging strategy.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A pull request <strong>highlights the code difference</strong> between the stable version of the product (generally in the <code>main</code> branch) and the changes in the incoming branch (in the pull request). A pull request could contain a <strong>fix to a bug</strong> or <strong>add new features</strong> to the product/application. The pull request reviewer must <span style="text-decoration: underline">review the difference in the incoming code</span> and decide whether merging that code enhances the existing code in the main branch. Reviewing pull requests can become <strong>cognitively demanding and time-consuming for the reviewer,</strong> and hence there are <span style="text-decoration: underline">additional workflows</span> that can improve the experience.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the case of IAC code using Terraform, I have automated <strong>three review workflows</strong> in a pull request that can help the reviewer better understand the code changes in the pull request. These are:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> Executing the <strong><code>terraform plan</code></strong> step and updating the pull request comments with the proposed changes.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2.</strong> Generating a <strong>cost estimate report</strong> of the resources before the pipeline provisions them.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> Scanning the code for <strong>security vulnerabilities.</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will cover each of these workflows in the following few paragraphs.</span></span></span>

<span style="text-decoration: underline"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000;text-decoration: underline">In this note, I show how to implement a pull request-based workflow using InfraCost, Checkov, and Terraform using GitHub Actions.</span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Execute terraform plan and update the pull request comment.</span></span></span></strong>
<img class="alignnone size-full wp-image-2704" src="https://skundunotes.com/wp-content/uploads/2023/07/78-image-2.png" alt="78-image-2" width="1108" height="286" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are two steps to achieving the above objective -(i) <span style="text-decoration: underline">Run the <code>terraform plan</code> command</span> in the GitHub actions pipeline, and (ii) <span style="text-decoration: underline">update the pull request comment</span> with the findings of the command.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Below is an image of the <code>terraform plan</code> step. As you can see from the <code>if</code> condition, this step will run for either of the two conditions - if the branch is not <code>main</code> (generally when working on a separate private branch) and if the pipeline trigger event is a <code>pull_request</code>.</span></span></span>
<img class="alignnone size-full wp-image-2708" src="https://skundunotes.com/wp-content/uploads/2023/07/78-image-3.png" alt="78-image-3" width="928" height="145" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After running the <code>terraform plan</code> command, the below step updates the pull request comment with the findings of the <code>terraform plan</code> output.</span></span></span>
<img class="alignnone size-full wp-image-2709" src="https://skundunotes.com/wp-content/uploads/2023/07/78-image-4.png" alt="78-image-4" width="798" height="559" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><a href="https://github.com/kunduso/add-aws-elb-ec2-terraform/pull/15#issuecomment-1543308156" target="_blank" rel="noopener">Here is an example of a pull request</a> to view the comment posted by the above step. You can also expand the **Show plan** button to view the command output. As you can see, the pull request comment makes it <strong>convenient</strong> for the reviewer to review the infrastructure changes without leaving the pull request console. Moreover, since the pull request executes only the <code>terraform plan</code> step, the changes are not deployed, which provides necessary <strong>guardrails</strong> to the development process. If you want to learn more, you may access <span style="text-decoration: underline"><a href="https://skundunotes.com/2023/03/07/ci-cd-with-terraform-and-github-actions-to-deploy-to-aws/" target="_blank" rel="noopener">this article</a></span>, where I have a link to my GitHub repo with a sample code.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Generate a cost estimate of the resources.</span></span></span></strong>
<img class="alignnone size-full wp-image-2705" src="https://skundunotes.com/wp-content/uploads/2023/07/78-image-5.png" alt="78-image-5" width="1178" height="256" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Knowing what infrastructure changes will be deployed by the pipeline in a pull request is helpful if the reviewer can also get a <strong>resource cost estimate.</strong> That is possible using <strong>Infracost.</strong> I came across Infracost and integrated the pipeline into my GitHub repository. In <strong>less than 15 minutes</strong>, I had the YAML file ready and checked into my repository. On a subsequent pull request, <strong>Infracost added a cost estimate of the infrastructure changes</strong> in the pull request comment. I have a detailed note on how I used Infracost -using the HCL code option or the Terraform plan option in my note atÂ  -<a href="https://skundunotes.com/2023/07/17/estimate-aws-cloud-resource-cost-with-infracost-terraform-and-github-actions/" target="_blank" rel="noopener">Estimate AWS Cloud resource cost with Infracost, Terraform, and GitHub Actions.</a></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Scan the code for security vulnerabilities.</span></span></span></strong>

<img class="alignnone size-full wp-image-2711" src="https://skundunotes.com/wp-content/uploads/2023/07/78-image-6-1.png" alt="78-image-6" width="1076" height="228" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Automating the <strong>security code review</strong> of the incoming changes in a pull request ensures that the code is scanned for <strong>security vulnerabilities</strong> before it is merged to the stable version of the code, which is usually the <code>main</code> branch. The automated process creates a code review report that informs the <strong>pull request submitter and the reviewer of the code quality in the pull request.</strong> I have a detailed note on integrating <strong>GitHub Actions</strong> with <strong>Checkov</strong> at <a href="https://skundunotes.com/2023/04/12/automate-terraform-configuration-scan-with-checkov-and-github-actions/" target="_blank" rel="noopener">automate-terraform-configuration-scan-with-checkov-and-github-actions</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These three integrations in a pull request <span style="text-decoration: underline">empower</span> and <span style="text-decoration: underline">educate</span> the <strong>entire project team</strong> working with the code repository <strong>to create workable infrastructure code and ensure it is secure and cost-efficient.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. If you followed me here, thanks, and do not hesitate to ask me any questions.</span></span></span>
