---
title: "Setup cross-account Amazon Elastic Container Registry (ECR) access using Terraform and GitHub Actions"
date: 2024-12-04 13:06:07 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Amazon Elastic Container Registry (ECR)</strong> is a fully managed Docker container registry that allows developers to <span style="text-decoration: underline">store container images securely</span>. It does so by storing them in an ECR repository, a logical separation for storing, organizing, and versioning the Docker images inside an ECR repository.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In a typical containerized application CI/CD pipeline, the <span style="text-decoration: underline">Continuous Integration (CI)</span> process builds, tags, and pushes the Docker image to an Amazon Elastic Container Registry (ECR) repository. Subsequently, the <span style="text-decoration: underline">Continuous Delivery (CD)</span> process provisions a container, task, or service from the Docker image (stored in the ECR repository) and deploys it to a container orchestration platform like an Amazon ECS cluster.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Application development teams manage <span style="text-decoration: underline">multiple product environments</span>—Dev, Test, Stage, and Prod—to ensure isolation, security, governance, and management. In this setup, it is common to adopt a <span style="text-decoration: underline">spoke-and-wheel architecture</span>, where an Amazon ECR repository (acting as the hub) is shared across various container hosting environments (such as Amazon ECS clusters) located in <span style="text-decoration: underline">different AWS accounts</span>. This architecture is achieved by hosting the <span style="text-decoration: underline">ECR repository in one AWS account</span> and <span style="text-decoration: underline">deploying ECS services for each environment in separate AWS accounts</span>. To enable <span style="text-decoration: underline">cross-account access</span>, specific AWS IAM permissions must be configured in both the ECR and ECS accounts. While Amazon ECR is commonly used for storing Docker images, managing access across multiple AWS accounts can be tricky. In this note, <span style="text-decoration: underline">I explain the Terraform configuration to apply to the AWS account hosting the Amazon ECR repository and the AWS account hosting the Amazon ECS service.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I classified the use case into four sections.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>#1:</strong> Provision the pre-requisites in the AWS account hosting the Amazon ECS Service</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>#2:</strong> Provision the Amazon ECR in the Central AWS account</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>#3:</strong> Create a CI process to push Docker images to Amazon ECR</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>#4:</strong> Provision an ECS service in the AWS account hosting the Amazon ECS Service</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can check the code in my <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/tree/central-ecr" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub repository: add-aws-ecr-ecs-fargate</span></span></span></a>. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000">Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = central-ecr</code>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">#1: Provision the pre-requisites in the AWS account hosting the Amazon ECS Service</span></span></span></strong>
<img class="alignnone  wp-image-5200" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-1.png" alt="107-image-1" width="549" height="384" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I covered this section in detail in my note -<a href="http://skundunotes.com/2024/04/10/create-infrastructure-to-host-an-amazon-ecs-service-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">create infrastructure to host an Amazon ECS Service using Terraform</span></span></span></a>. There is, however, <span style="text-decoration: underline">one change</span>. In that note, I provisioned an Amazon ECR repository in the same AWS account hosting the Amazon ECS Service. So while following that note, please ignore the Amazon ECR provisioning process.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">#2: Provision the Amazon ECR in the Central AWS account</span></span></span></strong>
<img class="alignnone  wp-image-5201" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-2.png" alt="107-image-2" width="546" height="420" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I provisioned an Amazon ECR repository and policy and an AWS KMS key and policy in the Central AWS account using Terraform. If you are following along, please check the files in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">app\tf</code> folder in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">central-ecr</code> branch of the GitHub repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <span style="text-decoration: underline">resources</span> to provision in the <span style="text-decoration: underline">AWS account to store the Amazon ECR image</span>:</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Amazon ECR to store the Docker image</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon ECR repository is where the (Docker) container images are stored. The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">image_tag_mutability</code> property states whether the same image tag can be reused. Setting it to <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">IMMUTABLE</code> = same image tag cannot be reused.</span></span></span>
<img class="alignnone size-full wp-image-5202" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-3.png" alt="107-image-3" width="506" height="230" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">encryption_configuration</code> stores the KMS key details to encrypt the Docker images stored in the repository.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Amazon ECR repository policy to control access to the Docker image</span></span></span></strong>
<img class="alignnone size-full wp-image-5203" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-4.png" alt="107-image-4" width="522" height="421" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Amazon ECR policy controls access to the Amazon ECR repository. In this case, the policy allows the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">local.development_env_root_arn</code> to communicate with the Amazon ECR to download the Docker images. The value of the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">local.development_env_root_arn</code> is the root arn of the Development environment AWS account.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. AWS KMS key to encrypt the Docker image stored in Amazon ECR</span></span></span></strong>
<img class="alignnone size-full wp-image-5204" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-5.png" alt="107-image-5" width="685" height="215" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Amazon Elastic Container Registry (ECR) allows the storage and management of Docker images securely, and integrating it with AWS Key Management Service (KMS) enhances image protection by enabling encryption at rest. By enabling KMS encryption for the ECR repositories, cloud engineering teams can ensure that all images are encrypted using customer-managed keys, giving the team complete control over access and encryption policies. This integration helps safeguard sensitive data within container images and supports compliance with security standards.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. AWS KMS key policy to control access and usage of the key</span></span></span></strong>
<img class="alignnone size-full wp-image-5205" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-6.png" alt="107-image-6" width="516" height="523" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A KMS key policy in Amazon Web Services (AWS) defines who can access and manage a specific KMS key, ensuring that only authorized entities can use it to encrypt or decrypt data. By carefully configuring the KMS key policy, cloud engineering teams can enforce strict security measures, ensuring that only the intended applications and users can interact with the encryption key and providing granular control over sensitive data in services like Amazon ECR.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used GitHub Actions to provision these resources. Hence, I created an IAM role in the Amazon ECR account with an Open ID connect trust with GitHub. You can learn about that at -<a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">securely integrate aws credentials with github actions using openid connect.</span></span></span></a></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Below is the image of the IAM role, which shows that it has a trust relation with the GitHub repository we're referring to.</span></span></span>
<img class="alignnone size-full wp-image-5206" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-7.png" alt="107-image-7" width="1189" height="686" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This role had the AWS Managed <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">AdministratorAccess</code> permission policy attached to enable resource provisioning and the trust policy to enable usage via GitHub. I stored the ARN of this role as a GitHub secret and referred to that in the GitHub Actions pipeline stored at <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">.github\workflows\terraform-ecr.yml</code> as <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">CENTRAL_ACCOUNT_IAM_ROLE</code>.</span></span></span>
<img class="alignnone size-full wp-image-5207" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-8.png" alt="107-image-8" width="485" height="124" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">#3: Create a CI process to push Docker images to Amazon ECR</span></span></span></strong>
<img class="alignnone  wp-image-5208" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-9.png" alt="107-image-9" width="604" height="286" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I covered this process in detail at -<a href="https://skundunotes.com/2024/04/28/push-docker-image-to-amazon-ecr-using-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Build, Scan, and Push Docker image to Amazon ECR using GitHub Actions</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">#4: Provision an ECS service in the AWS account hosting the Amazon ECS Service</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I covered this process in detail at -<a href="https://skundunotes.com/2024/05/06/continuous-deployment-of-amazon-ecs-service-using-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Continuous Deployment of Amazon ECS service using Terraform and GitHub Actions</span></span></span></a>. However, there is one <span style="text-decoration: underline">additional requirement</span> -the IAM policy attached to the <span style="text-decoration: underline">task execution role</span> in the ECS Service AWS Account also requires <span style="text-decoration: underline">permission to access the Amazon ECR</span> in the Central AWS account and to decrypt the Docker image using the KMS key in that AWS account. Both these permissions are enabled using the IAM policy.</span></span></span>
<img class="alignnone size-full wp-image-5209" src="https://skundunotes.com/wp-content/uploads/2024/12/107-image-10.png" alt="107-image-10" width="710" height="519" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of this note, where we've explored the<span style="text-decoration: underline"> process of setting up cross-account Amazon Elastic Container Registry (ECR) access using Terraform and GitHub Actions</span>. By provisioning resources in both the ECR and ECS accounts, we learned how to <span style="text-decoration: underline">securely share Docker images</span> stored in a central AWS account with ECS services running in separate AWS accounts.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">We also learned how AWS Key Management Service (KMS) can be integrated with ECR for <span style="text-decoration: underline">secure encryption</span>, and how IAM roles and policies are crucial in granting the proper permissions to access resources across accounts. Finally, we walked through the CI/CD pipeline where Docker images are<span style="text-decoration: underline"> pushed to ECR and deployed to an ECS service</span> in a separate AWS account.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With this setup, you can efficiently manage containerized applications <span style="text-decoration: underline">across different AWS accounts</span>, ensuring security and scalability. Try out the Terraform code and GitHub Actions pipeline from the linked GitHub repository, and explore how you can further optimize your containerized workflows. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you have any questions or suggestions, please comment below.</span></span></span>
