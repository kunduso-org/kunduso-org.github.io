---
title: "Create an Amazon ElastiCache for Redis cluster using Terraform"
date: 2023-10-21 15:30:49 +0000
categories: []
tags: []
---

<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Reading the title, you must have a fair idea of what we’re discussing in this note. Also, I followed a few best practices while creating the Amazon ElastiCache service, like enabling multi-availability zone, multi-node, logging, and encryption in transit and at rest. I have a link to my GitHub repository with the Terraform and GitHub Actions pipeline code.</span></span></span><br /><!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Amazon ElastiCache service supports Redis and Memcached. Knowing about this Amazon service will benefit readers of this note. If you want an in-memory caching solution for your application, check out the <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/WhatIs.html" target="_blank" rel="noopener">AWS Docs</a>. In this note, I focus only on how to provision an Amazon ElastiCache for the Redis cluster.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to learn how to provision an Amazon ElastiCache for Memcached, head over to <a href="https://skundunotes.com/2024/08/16/create-amazon-elasticache-for-memcached-using-terraform-and-github-actions/" target="_blank" rel="noopener"> -create an Amazon ElastiCache for Memcached using Terraform and GitHub Actions</a>.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The ElastiCache for Redis cluster exists inside an Amazon VPC; <span style="text-decoration: underline">subnet groups</span> (collection of subnets), to be precise. The service also requires a specific parameter group that holds key-value pairs of properties applicable to the ElastiCache cluster. You can also determine the <span style="text-decoration: underline">instance type</span> of the cache nodes, the number of node groups, and <span style="text-decoration: underline">replicas per node group</span> for the cluster. The cluster must be hosted on <span style="text-decoration: underline">multiple availability zones</span> to maintain high availability. The cache nodes of the cluster accept connections on a specific port; hence, the attached security group requires an ingress on that port. You can also enable logging (slow and engine logs) and publish them to AWS CloudWatch Logs for retrieval and analysis. The ElastiCache cluster also requires an AWS KMS key to <span style="text-decoration: underline">encrypt the data at rest</span> and an AUTH token to <span style="text-decoration: underline">encrypt the data in transit</span>. I know there are a lot of details, so let me explain them one by one, starting with the Amazon VPC.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that there are two branches in the repository. The <code><span style="font-size: 15px"><span style="color: #0047ab">main</span></span></code> branch version includes the Terraform code to create the Amazon ElastiCache cluster and additional resources to test the access to the Amazon ElastiCache cluster from an Amazon EC2 instance in the same Amazon VPC. If you only want to learn about the resources to create the Amazon ElastiCache for the Redis cluster, refer to the branch <code><span style="font-size: 15px"><span style="color: #0047ab">create-amazon-elasticache</span></span></code> in the repository.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are eight high-level steps to creating an Amazon ElastiCache for Redis cluster. Here's the link to my <a href="https://github.com/kunduso/amazon-elasticache-redis-tf/tree/create-amazon-elasticache" target="_blank" rel="noopener"><strong>GitHub repository: amazon-elasticache-redis-tf</strong>,</a> so you can follow along.</span></span></span></p>
<p><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an Amazon VPC and subnets to host the ElastiCache cluster</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created four subnets: - three private for each ElastiCache cluster node and one public. The ElastiCache cluster does not require the public subnet at all. (Note: Although I called that a public subnet, there isn't a route to <code><span style="font-size: 15px"><span style="color: #0047ab">0.0.0.0/0</span></span></code> in the public subnet's route table; hence, it's as good as a private subnet.) Please note that I'm referring to the branch <code><span style="font-size: 15px"><span style="color: #0047ab">create-amazon-elasticache</span></span></code> in the repository.</span></span></span></p>
<p><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create a subnet group to host the ElastiCache cluster</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The cache nodes in the ElastiCache cluster are spread evenly among the subnets you specify in the subnet group. The below code adds the <code><span style="font-size: 15px"><span style="color: #0047ab">private</span></span></code> subnets to the subnet group.</span></span></span><br /><img class="alignnone size-full wp-image-3087" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-1-1.png" alt="85-image-1" width="508" height="82" /><br /><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create a security group to access the ElastiCache cluster</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A security group controls access to an ElastiCache cluster's cache nodes. There are two blocks in a security group -the ingress and egress. Since I selected port number 6379 in the ElastiCache cluster (discussed later), I enabled ingress on that port in the attached security group with the source set to the Amazon VPC's CIDR. And for egress, I have it set to <code><span style="font-size: 15px"><span style="color: #0047ab">0.0.0.0/0</span></span></code>.</span></span></span><br /><img class="alignnone size-full wp-image-2962" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-2.png" alt="85-image-2" width="737" height="405" /><br /><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an AWS KMS key to encrypt the cache data at rest</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS KMS key encrypts the cache data stored in the cache nodes.</span></span></span><br /><img class="alignnone size-full wp-image-3088" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-3-1.png" alt="85-image-3" width="559" height="210" /><br /><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Add an AWS KMS key policy</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The KMS key policy has two statements. The first is the default key policy, and the second ensures the key encrypts AWS CloudWatch Log group logs.</span></span></span><br /><img class="alignnone size-full wp-image-3096" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-13.png" alt="85-image-13" width="729" height="706" /><br /><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Create AWS CloudWatch Log groups</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Amazon ElastiCache for Redis supports two types of logging via AWS CloudWatch logs: slow and engine logs. For more information on log delivery, refer to this note  -<a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/Log_Delivery.html" target="_blank" rel="noopener">ElastiCache-log-delivery</a>.</span></span></span><br /><img class="alignnone size-full wp-image-3097" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-14.png" alt="85-image-14" width="597" height="214" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I could also enable log encryption due to the AWS KMS key policy I created in the previous step.</span></span></span></p>
<p><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 7: Create an AWS Secrets Manager secret to store the AUTH_TOKEN to encrypt the cache data in transit</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code><span style="font-size: 15px"><span style="color: #0047ab">auth_token</span></span></code> is required to communicate with the ElastiCache cluster. I used the <code><span style="font-size: 15px"><span style="color: #0047ab">random_password</span></span></code> resource of the <code><span style="font-size: 15px"><span style="color: #0047ab">random provider{}</span></span></code> to create the token. Certain limitations exist on the length and permissible nonalphanumeric characters of the <code><span style="font-size: 15px"><span style="color: #0047ab">auth_token</span></span></code> that you may read at <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/auth.html#auth-overview" target="_blank" rel="noopener">elasticache-auth-overview</a>.</span></span></span><br /><img class="alignnone size-full wp-image-3037" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-9.png" alt="85-image-9" width="472" height="147" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since this is a sensitive value, I specified an AWS Secrets Manager secret to store that and directed Terraform to fetch the value from the Secrets Manager secret while creating the ElastiCache cluster.</span></span></span><br /><img class="alignnone size-full wp-image-3089" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-4-1.png" alt="85-image-4" width="665" height="212" /><br /><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 8: Create the Amazon ElastiCache for Redis cluster</span></span></span></strong><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, the Amazon ElastiCache for Redis cluster is the last resource to create. The code block below specifies all the properties required to create it. For a list of all the properties, check <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/elasticache_replication_group" target="_blank" rel="noopener">Terraform AWS Registry: elasticache_replication_group</a>. To learn about the supported node types, click here: <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/CacheNodes.SupportedTypes.html" target="_blank" rel="noopener">Cache-Node-Types</a>.</span></span></span><br /><img class="alignnone size-full wp-image-3090" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-5-1.png" alt="85-image-5" width="666" height="685" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That is all the code required to create the ElastiCache cluster.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, please note that to use the ElastiCache cluster, there are a <span style="text-decoration: underline">few additional steps</span> if you want to <strong>follow best practices</strong>. These are not necessary to create the ElastiCache cluster but are required to <span style="text-decoration: underline">use the ElastiCache cluster</span>.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Best practice 1:</strong> Store the ElastiCache endpoint and port number as parameters in the AWS Systems Manager Parameter Store.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Any application using the ElastiCache cluster will access it on the endpoint and the port number. Hence, the application would require those values. Although you can embed values in the application, an alternate approach is to store these as encrypted values in the Systems Manager Parameter Store as parameters and provide permissions to the application to fetch and decrypt them from there. That way, hardcoding the values is not required, and the application stays clear of confidential data.</span></span></span><br /><img class="alignnone size-full wp-image-3091" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-10-1.png" alt="85-image-10" width="822" height="249" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Best practice 2:</strong> Create an IAM policy to access the ElastiCache cluster endpoint and port number from the Systems Manager Parameter Store.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After storing the endpoint and port number as Systems Manager parameters, I created an IAM policy that allows access to those. An application would require the same IAM policy to be attached to the role it assumes to communicate with the Systems Manager parameters. After attaching the IAM policy, the application can communicate with the Systems Manager parameters and get the values of the ElastiCache endpoint and the port number.</span></span></span><br /><img class="alignnone size-full wp-image-3092" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-11-1.png" alt="85-image-11" width="859" height="517" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see from the policy above, it is specific to the two resources (the endpoint and the port number) and access to decrypt it using the same AWS KMS Key used to encrypt it.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Best Practice 3:</strong> Create an IAM policy to access the ElastiCache cluster <code><span style="font-size: 15px"><span style="color: #0047ab">auth_token</span></span></code> from AWS Secrets Manager secret.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An application would require access to the ElastiCache <code><span style="font-size: 15px"><span style="color: #0047ab">auth_token</span></span></code> to communicate with the cache cluster. An <code><span style="font-size: 15px"><span style="color: #0047ab">auth_token</span></span></code> is sensitive data, so it should not be stored inside an application. I followed best practices earlier (Step# 7) and stored the <code><span style="font-size: 15px"><span style="color: #0047ab">auth_token</span></span></code> inside Secrets Manager as a secret. Then, I created an IAM policy to access the Secrets Manager secret. Like the previous one, this IAM policy must also be attached to the IAM role that an application would assume to communicate with the ElastiCache cluster.</span></span></span><br /><img class="alignnone size-full wp-image-3093" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-12-1.png" alt="85-image-12" width="767" height="503" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This IAM policy, too, is restrictive (no wildcards) and allows access only to get the secret value and then decrypt that using the same AWS KMS Key used to encrypt it.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I also automated the provisioning of the AWS resources using GitHub Actions. If you want to learn how I managed the authentication process, head over to this note –<span style="text-decoration: underline"><a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener">securely-integrate-aws-credentials-with-github-actions-using-openid-connect</a></span>. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also scanned my code for vulnerabilities using Bridgecrew Checkov, which generated a scan report. Here is a note on how to enable <span style="text-decoration: underline"><a href="https://skundunotes.com/2023/04/12/automate-terraform-configuration-scan-with-checkov-and-github-actions/" target="_blank" rel="noopener">Checkov with GitHub Actions</a></span>. I'm also interested in the cost of these resources and use Infracost for that, which I have covered in detail in this note –<span style="text-decoration: underline"><a href="https://skundunotes.com/2023/07/17/estimate-aws-cloud-resource-cost-with-infracost-terraform-and-github-actions/" target="_blank" rel="noopener">estimate AWS resource cost</a></span>. The vulnerabilities and <a href="https://github.com/kunduso/amazon-elasticache-redis-tf/pull/9#issuecomment-1765346385" target="_blank" rel="noopener">cost estimate</a> are available in the pull request as comments.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once I had added all the resources and their configurations to my Terraform code, I pushed the changes to my remote repository and created a pull request (<a href="https://github.com/kunduso/amazon-elasticache-redis-tf/pull/9" target="_blank" rel="noopener">open link</a>). After I merged the pull request into the main branch, the GitHub Actions workflow concluded with the command <code><span style="font-size: 15px"><span style="color: #0047ab">terraform apply</span></span></code> enabled and provisioned the resources.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To verify, on the AWS Management Console, I navigated to ElastiCache → Redis clusters and selected the ElastiCache cluster that I created using the Terraform code. The below image lists some of the properties of the cluster.</span></span></span><br /><img class="alignnone size-full wp-image-2967" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-7.png" alt="85-image-7" width="1381" height="696" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Scrolling down, I saw the individual cache nodes, too.</span></span></span><br /><img class="alignnone size-full wp-image-2968" src="https://skundunotes.com/wp-content/uploads/2023/10/85-image-8.png" alt="85-image-8" width="1357" height="700" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of this note. Let me know if you have any questions or suggestions. In my subsequent note, I demonstrate how to <a href="https://skundunotes.com/2023/12/13/connect-to-an-amazon-elasticache-cluster-from-an-amazon-ec2-instance-using-python/" target="_blank" rel="noopener">interact with the Redis cluster to connect using Python to the ElastiCache for Redis cluster from an Amazon EC2 instance in the same VPC</a>.</span></span></span></p>
