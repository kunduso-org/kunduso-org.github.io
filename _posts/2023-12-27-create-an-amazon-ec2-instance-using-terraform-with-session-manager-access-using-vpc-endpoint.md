---
title: "Create an Amazon EC2 instance using Terraform with Session Manager access using VPC Endpoint"
date: 2023-12-27 17:25:33 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As a reader of this note, I believe you are familiar with Session Manager. Per <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/session-manager-to-linux.html" target="_blank" rel="noopener">AWS-Docs</a>, <strong>Session Manager</strong> is a fully managed AWS Systems Manager capability that lets you manage your Amazon EC2 instances through an interactive one-click browser-based shell or through the AWS CLI.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For Session Manager to function, the Amazon VPC requires access to the internet using an attached internet gateway. The process has two steps: (i) create an Internet gateway and attach it to the VPC, and (ii) add a route to a route table in the VPC to <code>0.0.0.0/0</code> using the Internet gateway.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">But how would an Amazon EC2 instance in a VPC connect with Session Manager if it <span style="text-decoration: underline">does not have access to the internet</span> due to security requirements? That is where <strong>VPC endpoints</strong> come in handy.</span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: There is a step-by-step guide on how to do this from the AWS console at <a href="https://repost.aws/knowledge-center/ec2-systems-manager-vpc-endpoints" target="_blank" rel="noopener">ec2-systems-manager-vpc-endpoints</a>.</span></span></span></em>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html" target="_blank" rel="noopener">AWS-Docs</a>, a <strong>VPC endpoint</strong> enables customers to privately connect to supported AWS services and VPC endpoint services powered by AWS PrivateLink. Amazon VPC instances do not require public IP addresses to communicate with resources of the service. Traffic between an Amazon VPC and a service does not leave the Amazon network.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I list the steps to <span style="text-decoration: underline">create an Amazon EC2 instance with Session Manager access that does not have access to the internet using Terraform</span>. Previously, I worked on a similar use case where an internet gateway was available. Since I covered the IAM role and policy requirements applicable to this use case in that note, please read that to understand the required AWS-managed policy. You can read at  - <a href="http://skundunotes.com/2023/08/27/provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform/" target="_blank" rel="noopener">provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform.</a></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested and want to follow along, I have the code in my <a href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-vpc-endpoint" target="_blank" rel="noopener">GitHub repository: ec2-userdata-terraform</a>. Please ensure you are on the right git branch  - `add-vpc-endpoint`.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Continuing from that note, there are <strong>five steps</strong> to the process:</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Enable DNS in the VPC</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are two DNS properties to enable inside the VPC code.</span></span></span>
<img class="alignnone size-full wp-image-3291" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-1.png" alt="88-image-1" width="330" height="159" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Remove Internet gateway and route to the internet</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since I was building off a previous code base, I removed the code to create an Internet gateway and the route to the internet. You can ignore this step.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Effectively, I deleted the below commented-out code block.</span></span></span>
<img class="alignnone size-full wp-image-3292" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-2.png" alt="88-image-2" width="547" height="218" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create a Security group for the VPC endpoint</span></span></span></strong>
<img class="alignnone size-full wp-image-3293" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-3.png" alt="88-image-3" width="462" height="292" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Using the code above, Terraform created a security group for the VPC endpoints with an <code>ingress rule</code> on port# 443 from the VPC’s CIDR block.</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create VPC endpoints</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I created three endpoints: one for <code>ssm</code>, <code>ec2messages</code>, and <code>ssmmessages</code>, each, and attached them to the correct security group and subnet.</span></span></span>
<img class="alignnone size-full wp-image-3306" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-4-1.png" alt="88-image-4" width="488" height="633" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note that I referred to the AWS subnet as private since there’s no route to the internet.</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Update the Amazon EC2 instance’s security group and instance property</span></span></span></strong>
<img class="alignnone size-full wp-image-3295" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-5.png" alt="88-image-5" width="471" height="290" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Like the VPC endpoint security group’s <code>ingress rule</code>, the Amazon EC2 instance’s <code>egress rule</code> has the same properties.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Amazon EC2 instance previously had the value <code>associate_public_ip_address = true</code>, which I set to <code>associate_public_ip_address = false</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After updating the code, I ran <code>terraform apply</code> and provisioned all the resources appropriately. I reviewed the VPC on the AWS console and found no internet gateway. The route table associated with the subnet where the Amazon EC2 was hosted also did not have any route to the internet. I also reviewed the three VPC endpoints that were correctly provisioned.</span></span></span>
<img class="alignnone size-full wp-image-3296" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-6.png" alt="88-image-6" width="1295" height="161" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And finally, I could connect to the Amazon EC2 instance using the AWS console.</span></span></span>
<img class="alignnone size-full wp-image-3297" src="https://skundunotes.com/wp-content/uploads/2023/12/88-image-7.png" alt="88-image-7" width="643" height="353" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you have any questions or suggestions, please do not hesitate to use the comments section below.</span></span></span>
