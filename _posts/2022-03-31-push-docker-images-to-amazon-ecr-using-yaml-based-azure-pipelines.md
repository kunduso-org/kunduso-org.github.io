---
title: "Push Docker images to Amazon ECR using YAML based Azure Pipelines"
date: 2022-03-31 01:01:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">When it comes to identifying a process to deliver continuous value to customers, CI-CD is the defacto standard. And container technology enables that by encapsulating an application and its dependencies into a package that can be hosted and scaled independently of other applications. So DevOps engineers and application developers merged these ideas to forge a concept to create a CI-CD process to deploy containers.</span></span></span>
<!--more-->
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">At a high level, a typical CI-CD cycle involving containers comprises the following steps:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> create the application code (or an executable depending on the technology) that will be hosted in a container by a specific cloud provider,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> create and tag a docker image that contains the application (or executable) and all dependencies,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3:</strong> upload the docker image into an image repository, and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 4:</strong> create a container out of the image that is stored in the image repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note and the associated GitHub repository, <span style="text-decoration: underline"><strong>I share the first three steps</strong></span> of the concept and code to create a continuous integration process to upload a docker image into an image repository in <span style="text-decoration: underline">Amazon Elastic Container Registry (Amazon ECR)</span> using <span style="text-decoration: underline">Azure pipelines, Docker CLI, and AWS Tools for PowerShell</span>. If you are familiar with these underlying technologies, you should be able to do the same by the end of this note.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are a couple of prerequisites to this process  - an IAM user with permission to push images to the Amazon ECR image repository and the image repository to host the image.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Pre-requisite 1:</strong> I followed the documentation available at <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-push.html" target="_blank" rel="noopener">aws-docs-image-push-iam-policy</a></span> and created an IAM policy from the <code>iam-policy.json</code> file with appropriate permissions.</span></span></span>
<img class="alignnone size-full wp-image-1780" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-2.png" alt="62.Image-2" width="546" height="480" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: This file is available in the <code>.\iam-policy</code> folder in my GitHub repository: <span style="text-decoration: underline"><a href="https://github.com/kunduso/app-one" target="_blank" rel="noopener">kunduso/app-one</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see in the image above, the policy file has a couple of extra permissions: <code>ecr:CreateRepository</code>, <code>ecr:DescribeRepositories</code>. These permissions allow the IAM user to create an Amazon ECR repository.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I then associated the IAM policy with an IAM user whose credentials were stored securely in Azure DevOps Library. If you are new to the Azure DevOps library and want to know how to access secure variables via Azure Pipelines, check out this note  -<span style="text-decoration: underline"><a href="https://skundunotes.com/2022/03/30/manage-secure-variables-with-azure-devops-library-and-azure-pipelines/" target="_blank" rel="noopener">Manage secure variables with Azure DevOps Library and Azure Pipelines</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Pre-requisite 2:</strong> Although I could have created the Amazon ECR repository in advance, I addressed that in the <code>azure-pipelines.yml</code> file via a check. I have an image of the code from my GitHub repository below. I checked to see if a repository exists, and if not, create it. Hence, I required the two additional permissions in the <code>iam-policy.json</code> file above.</span></span></span>
<img class="alignnone size-full wp-image-1781" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-3.png" alt="62.Image-3" width="787" height="176" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The following steps were to automate creating and pushing a docker image into the Amazon ECR repository. However, since I used the <code>azure-pipelines.yml</code> file, there were a couple more steps to follow.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Variables:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created a library variable to securely store the <code>access_key</code>, <code>secret_key</code> and <code>aws_account_number</code> associated with the IAM user. In addition, this IAM user had the <code>iam-policy</code> attached to communicate with the Amazon ECR repository.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Install AWS PowerShell Tools:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used the AWS Tools for PowerShell and hence automated the process of installing all the required modules. You may read more about that at <a href="https://docs.aws.amazon.com/powershell/latest/userguide/pstools-getting-set-up-windows.html#ps-installing-awstools" target="_blank" rel="noopener"><span style="text-decoration: underline">Install AWS.Tools</span></a>. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <a href="https://github.com/kunduso/app-one/blob/main/InstallAWSTools.ps1" target="_blank" rel="noopener"><span style="text-decoration: underline">InstallAWSTools.ps1</span></a> PowerShell script in my GitHub repo has all the details.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Set AWS Credentials:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The next step was to create a local profile that was referenced by the subsequent steps to interact with the AWS cloud API. The details are available at <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/powershell/latest/userguide/specifying-your-aws-credentials.html" target="_blank" rel="noopener">specifying-your-aws-credentials</a></span>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Check and create an Amazon ECR repository:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I mentioned that above under prerequisites. Once an AWS profile was available, I checked if an Amazon ECR repository existed before creating a new one. <em>Idempotency</em> is at play here.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Remove AWS Credentials:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last step in the <code>azure-pipelines.yml</code> file was to remove the credentials. Such that even if any of the above steps failed due to specific errors, it would continue due to the <code>condition: always()</code> rule. You may read more at <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/conditions?view=azure-devops&amp;tabs=yaml" target="_blank" rel="noopener">yaml-specify-condition</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Now that the additional pieces of necessary information are out of the way, let us focus on the core CI steps to create and push a docker image to an Amazon ECR repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> Create the application code that will be hosted in a container</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For this project, I used a simple static app. The code for the same is in the <code>\app</code> folder of my GitHub repository: <span style="text-decoration: underline"><a href="https://github.com/kunduso/app-one" target="_blank" rel="noopener">kunduso/app-one</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> Create and tag a docker image</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <a href="https://github.com/kunduso/app-one/blob/main/Dockerfile" target="_blank" rel="noopener">docker file</a> has the details.</span></span></span>
<img class="alignnone size-full wp-image-1782" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-4.png" alt="62.Image-4" width="454" height="425" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see from the image, the docker image is based on an alpine image where I copied the files from the <code>app</code> folder, <code>run npm install</code>, and provide an <code>ENTRYPOINT</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, before <code>docker build</code>, I was required to authenticate <code>docker</code> CLI to my default registry  -AWS ECR. That was possible using <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/powershell/latest/reference/items/Get-ECRLoginCommand.html" target="_blank" rel="noopener"><code>Get-ECRLoginCommand</code></a></span>.</span></span></span>
<img class="alignnone size-full wp-image-1783" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-5.png" alt="62.Image-5" width="822" height="127" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The build and tag steps are relatively self-explanatory.</span></span></span>
<img class="alignnone size-full wp-image-1784" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-6.png" alt="62.Image-6" width="761" height="237" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3:</strong> Upload the docker image into an image repository</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used the <code>docker push</code> command for this step.</span></span></span>
<img class="alignnone size-full wp-image-1793" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-9.png" alt="62.Image-9" width="753" height="120" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And once I completed all the <code>docker</code> CLI steps, I added the <code>docker logout</code> step to close the session.</span></span></span>
<img class="alignnone size-full wp-image-1785" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-7.png" alt="62.Image-7" width="433" height="122" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And as I mentioned above, the last step in the <code>azure-pipelines.yml</code> file was to remove the profile that stored the AWS Credentials. All the AWS.Tools used the profile for PowerShell command using the <code>ProfileName</code> flag.</span></span></span>
<img class="alignnone size-full wp-image-1794" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-10.png" alt="62.Image-10" width="580" height="116" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. I know that there are a lot of detailed pieces of information here, and I created it so that you can find all the relevant information here.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I provided code snippets to explain the process and underlying concept throughout this note. You can find the complete code at my GitHub repository: <span style="text-decoration: underline"><a href="https://github.com/kunduso/app-one" target="_blank" rel="noopener">kunduso/app-one</a></span>, and the Azure pipelines build logs at <span style="text-decoration: underline"><a href="https://littlecoding.visualstudio.com/Open-Project/_build/results?buildId=271&amp;view=results" target="_blank" rel="noopener">Open-Project\kunduso.app-one</a></span>. In addition, you can access the latest build log and walk through the steps comparing the tasks listed in the <code>azure-pipelines.yml</code> file.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Last but not least, here is the docker image in my Amazon ECR app-one repository.</span></span></span>
<img class="alignnone size-full wp-image-1788" src="https://skundunotes.com/wp-content/uploads/2022/03/62.image-8-1.png" alt="62.Image-8" width="894" height="421" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope this note helped you understand how to build and push a docker image into Amazon ECR and how to do the same using a secure process with Azure pipelines. If you have any questions or suggestions, please reach out to me using the <a href="https://skundunotes.com/contact/" target="_blank" rel="noopener">Contact page</a>.</span></span></span>
