---
title: "Azure DevOps and Terraform to provision Amazon S3"
date: 2021-02-14 12:30:18 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here's an interesting use case I came across -that I thought could also be a valuable resource to share- and hence this post.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I've worked on Terraform and am aware of the solution that it provides to IaC principles. I've worked extensively on Azure DevOps and know Azure Pipelines can also be good at orchestration. And I thought to myself, let me bring these two together to provision a relatively simple resource like an Amazon S3 bucket. <strong>The Terraform configuration files are versioned and stored in Github, and Azure DevOps can implement them to provision the resource (s3 bucket) in AWS. It is the tool integration that I am focusing on here.</strong></span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this post, I list the steps I followed to integrate three incredible tools to achieve the objective of IaC, namely -<strong>infrastructure defined as code that is versioned in a source control repository, automated deployment, repeatable process, and consistent environment state</strong>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The tools used are Microsoft Azure DevOps, HashiCorp Terraform, and Amazon S3. I am assuming that the reader is aware of what these tools are. However, just so we are all on the same page, Terraform is an IaC tool allowing us to write infrastructure configuration files to manage various cloud services. It is a declarative language that follows idempotency. Azure DevOps is Microsoft's solution to a software development process that aids collaboration, traceability, and visibility using components like Azure Boards (work items), Azure Repos (code repository), Azure Pipelines (build and deploy), Azure Artifacts (package management), Azure Test Plans along with a plug and play module to integrate a large number of third party tools like Docker, Terraform, etc. And lastly, Amazon S3 is a storage solution from the AWS cloud provider to store and retrieve artifacts -files, and folders.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before we begin with the automation process, there are a few <strong>prerequisites</strong> we need to have. These are:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-AWS IAM user credentials (access key and secret access key) with permission to create a bucket in an AWS account</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-existing Amazon S3 bucket details to store the remote state</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-a Github repo containing Terraform configuration files</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-an Azure DevOps project</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Authenticate Azure DevOps to the GitHub repo, where the Terraform configuration files are stored.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the Azure DevOps portal, at the bottom left corner, click on the gear icon. That launches the project setting page. Navigate to the middle of the list where Service Connections are listed under Pipelines.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Click on the "New service connection" button (top right corner) and search for GitHub in connection types.</span></span></span>
<img class="alignnone size-full wp-image-1084" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image1.png" alt="33. Az-Plines-TF-S3-image1" width="439" height="193" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Select GitHub and click on Next. That loads a new pane requesting details to grant authorization. Click on Authorize to provide credentials to the Github repo.</span></span></span>
<img class="alignnone size-full wp-image-1085" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image2.png" alt="33. Az-Plines-TF-S3-image2" width="487" height="360" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Install <a href="https://marketplace.visualstudio.com/items?itemName=ms-devlabs.custom-terraform-tasks" target="_blank" rel="noopener">Terraform extension</a> from the Azure DevOps marketplace for the Azure DevOps team project.Â </span></span></span></strong>
<img class="alignnone size-full wp-image-1086" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image3.png" alt="33. Az-Plines-TF-S3-image3" width="761" height="282" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This extension adds Terraform tasks and service connection requests that we will use later in pipelines.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Authenticate Azure DevOps to AWS for Terraform service connection.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Navigate back to the bottom left corner to launch a service connection (similar to Github), and this time search for Terraform. </span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: "AWS for Terraform" option won't be visible if Terraform extension in Step 2 above is not installed for the project.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Click on "AWS for Terraform" and then next.</span></span></span>
<img class="alignnone size-full wp-image-1087" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image4.png" alt="33. Az-Plines-TF-S3-image4" width="432" height="240" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That loads a new pane requesting IAM (access key and secret access) details that Terraform will use to provision AWS resources. Provide these values that are available as prerequisites. The region value is the location where the state file of the terraform configuration will be stored. Please provide a name for the service connection and save it.</span></span></span>
<img class="alignnone size-full wp-image-1088" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image5.png" alt="33. Az-Plines-TF-S3-image5" width="523" height="710" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create a release definition</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this step, we create a new release pipeline. From the Pipelines menu on the left, click on Releases. This launches a new page to select a template. I prefer an Empty job, to begin. Then, under Agent job search, click on + to add tasks. This opens a new pane on the right. Enter Terraform to search.</span></span></span>
<img class="alignnone size-full wp-image-1089" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image6.png" alt="33. Az-Plines-TF-S3-image6" width="765" height="487" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"> There are two tasks available, and we use both.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 4a: Select Terraform tool installer and add that step to the Agent job.</strong> </span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then select the Terraform task. Once added, select task (<em>Install Terraform 0.12.3</em>) to close the task pane on the right.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The screen looks as below.</span></span></span>
<img class="alignnone size-full wp-image-1090" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image7.png" alt="33. Az-Plines-TF-S3-image7" width="845" height="407" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I was working with version 0.13.5 of Terraform, and hence I updated that.</span></span></span>
<img class="alignnone size-full wp-image-1091" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image8.png" alt="33. Az-Plines-TF-S3-image8" width="352" height="319" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4b: Terraform init</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The first command is "terraform init," and hence I selected that command from the drop-down. Moreover, I was using the AWS provider in my code, and therefore I choose that from the Provider list. The Configuration directory is the location where this task runs. So here, I provided the path to the terraform configuration files in my repository.</span></span></span>
<img class="alignnone size-full wp-image-1092" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image9.png" alt="33. Az-Plines-TF-S3-image9" width="855" height="552" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Further down, we are requested for the AWS backend configuration details -the AWS connection to use, the bucket to store the terraform.tfstate file and the key, which is the relative path to the terraform.tfstate file inside the bucket. If you recollect in Step 3, we created an AWS for Terraform connection. We provide the name of that connection, and the name of a pre-existing bucket that I mentioned should already exist in the prerequisites.</span></span></span>
<img class="alignnone size-full wp-image-1093" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image10.png" alt="33. Az-Plines-TF-S3-image10" width="568" height="365" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also updated the display name of the task from Terraform : aws to Terraform : init</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4c: Terraform plan</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you've used Terraform, you know that after init (initialize), we plan and then apply the plan. I replicated that by adding two more Terraform tasks. For the next task, update the display name to Terraform : plan and select the command -plan from the drop-down. Populate the configuration directory -this is the path to the terraform configuration files. Under additional command arguments, I am passing some variables.</span></span></span>
<img class="alignnone size-full wp-image-1094" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image11.png" alt="33. Az-Plines-TF-S3-image11" width="579" height="646" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These are the variables that are referenced in the terraform configuration file: the region, <code>access_key</code>, and the <code>secret_key</code>. I am also storing the plan file in a <code>demo.tfpan</code> file, which is helpful in the next step (terraform apply).</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These variables, particularly the <code>access_key</code> and <code>secret_key</code>, should not be added to the repository. I declared them in the terraform configuration files and pass the values using Azure DevOps. These variables can either be stored as a variable group in a library or as variables in the release definition. I have stored these variables in the same release definition.</span></span></span>
<img class="alignnone size-full wp-image-1095" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image12.png" alt="33. Az-Plines-TF-S3-image12" width="1064" height="416" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4d: Terraform apply</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Next, we populate the last terraform task. This is the apply step. The command is: validate and apply. I also pass additional command arguments: "demo.tfplan" This is the output of the plan command that we ran in the previous step.</span></span></span>
<img class="alignnone size-full wp-image-1096" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image13.png" alt="33. Az-Plines-TF-S3-image13" width="573" height="620" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of the release definition, and we can save that. I ran the release definition manually and got a green build (succeeded).</span></span></span>
<img class="alignnone size-full wp-image-1097" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image14.png" alt="33. Az-Plines-TF-S3-image14" width="765" height="555" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Navigating inside the logs, I got a detailed picture of the steps that Azure DevOps executed.</span></span></span>
<img class="alignnone size-full wp-image-1098" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image15.png" alt="33. Az-Plines-TF-S3-image15" width="1263" height="525" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And on my AWS console, I could see Azure DevOps created an S3 bucket with the name terraform-bucket-17097 using the terraform configuration. There is also the skundu-terraform-remote-state bucket that I created earlier (pre-requisite) where the terraform.tfstate file for the newly created resource (an S3 bucket with the name terraform-bucket-17097) is stored.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: ignore the other bucket (terraform-bucket-25676). That is not relevant to this blog.</span></span></span>
<img class="alignnone size-full wp-image-1099" src="https://skundunotes.com/wp-content/uploads/2021/02/33.-az-plines-tf-s3-image16.png" alt="33. Az-Plines-TF-S3-image16" width="783" height="406" />

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Now, I could run the Azure Pipeline multiple times, and in the end, I would have the same bucket -idempotency. I have the resource creation automated using Azure DevOps. This process is repeatable. I have the infrastructure provisioning process in a code that is stored in source control. I have the credentials secured. This process ensured that the state of the environment (only an S3 bucket) is consistent. Although I have the release definition set to manual for this demo, we can change that to be auto-triggered with each check-in (with appropriate guard-rails where required). These are the benefits of infrastructure as code.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found the post informative. Please do reach out if there are any questions I can answer.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">GitHub Code Repository: <a href="https://github.com/kunduso/LearnTerraform/tree/master/Get-Started-AWS-009-CI-CD-AzureDevops" target="_blank" rel="noopener">LearnTerraform/Get-Started-AWS-009-CI-CD-AzureDevops/</a></span></span></span>
