---
title: "Create an Amazon Managed Grafana workspace using Terraform"
date: 2022-11-12 18:40:12 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I describe the steps to provision a new Amazon Managed Grafana workspace using the AWS Terraform provider.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong><em>Grafana</em></strong> is an open-source observability tool to visualize data. It provides charts, graphs, and alerts for the web when connected to supported data sources.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <strong><a href="https://docs.aws.amazon.com/grafana/latest/userguide/what-is-Amazon-Managed-Service-Grafana.html" target="_blank" rel="noopener">AWS-Docs</a></strong>, Amazon Managed Grafana is a fully managed and secure data visualization service that you can use to instantly query, correlate, and visualize operational metrics, logs, and traces from multiple data sources. In addition, Amazon Managed Grafana makes it easy to deploy, operate, and scale Grafana.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A pre-requisite to creating an Amazon Managed Grafana workspace is to <em>enable AWS organizations</em> in your AWS account. You may read about that here: <a href="https://aws.amazon.com/premiumsupport/knowledge-center/get-started-organizations/" target="_blank" rel="noopener"><span style="text-decoration: underline">knowledge-center-get-started-organizations</span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> Terraform must access the AWS Cloud to provision and manage resources. It does so by <strong>securely</strong> accessing the <code>access_key</code> and the <code>secret_key</code> stored in Azure DevOps. I have the procedure detailed in this post: <a href="https://skundunotes.com/2022/03/30/manage-secure-variables-with-azure-devops-library-and-azure-pipelines/" target="_blank" rel="noopener">manage-secure-variables-with-azure-devops-library-and-azure-pipelines</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want the code repository handy as you walk through the steps, here's the link to my <strong>GitHub repo:  <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard" target="_blank" rel="noopener">aws_managed_grafana_workspace_dashboard</a></strong>. You will have to navigate to the <code>amg_workspace</code> folder for the code on Amazon Managed Grafana workspace.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Pre-requisite:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Create an Amazon Identity and Access Management (IAM) user to manage the resources this Terraform stack provisions. Store the <code>access_key</code> and <code>secret_key</code> of the user in Azure DevOps Library. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are cautious and want to use a tight IAM permission policy, I have that in the repository: <code><a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard/blob/main/amg_workspace/user-policy-files/aws-iam-policy.json" target="_blank" rel="noopener">aws-iam-policy.json</a></code>. This tackles only the grafana section of the code. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And here is the path to the IAM permission policy to manage the Terraform state file in an s3 bucket: </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><code><a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard/blob/main/amg_workspace/user-policy-files/aws-iam-tf-statefile-policy.json" target="_blank" rel="noopener">aws-iam-tf-statefile-policy.json</a></code>. Attach these two policies to the IAM user whose credentials are stored in Azure DevOps Library.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Creating and accessing an Amazon Managed Grafana workspace has five steps.</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an Identity Center user</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before creating a user, you must enable "IAM Identity Center" in your AWS account. You can search for the service in your account, and if the service is not enabled, you will be greeted with the following image. Click on the Enable button.</span></span></span>
<img class="alignnone size-full wp-image-1995" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-2.png" alt="67-image-2" width="445" height="343" />
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> When I wrote this post in 2022, the AWS provider version 4.29.0 did not support the IAM Identity Center user resource. <span style="text-decoration: underline">However, as of January 2024, support for this resource is available</span> in the current version, 5.32.0. so I wrote a <a href="https://skundunotes.com/2024/01/16/create-an-amazon-managed-grafana-workspace-and-identity-store-user-using-terraform/" target="_blank" rel="noopener">small extension to this note</a> describing how to manage the <code>aws_identitystore_user</code> resource using Terraform. So, you will still have to manually enable the IAM Identity Center feature (above), but everything described (below) until Step 2 in this note is automated using Terraform. Please refer to that note as you create the Amazon Managed Grafana workspace using Terraform.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once enabled, you may create an IAM Identity Center user by navigating to the Users on the left-hand panel and clicking "Add User."</span></span></span>
<img class="alignnone size-full wp-image-1996" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-3.png" alt="67-image-3" width="423" height="575" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I provided the below info and proceeded with creating a user.</span></span></span>
<img class="alignnone size-full wp-image-1997" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-4.png" alt="67-image-4" width="1113" height="431" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I received the username, one-time password, and a link to the AWS access portal on confirmation. I saved the information which I will require in step 5.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I could see the user on successful creation on the portal. I then clicked on the username and saved the associated User ID. This information is required in step 4 below by Terraform.</span></span></span>
<img class="alignnone size-full wp-image-1998" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-5.png" alt="67-image-5" width="1381" height="440" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">At an enterprise level, technical architects <strong>can select a separate identity provider.</strong> In my case, however, I proceeded with the <strong>IAM Identity Center</strong> directory. Here is a link to the <a href="https://aws.amazon.com/iam/identity-center/?nc=sn&amp;loc=2&amp;dn=2" target="_blank" rel="noopener">AWS-Docs</a> if you are new to IAM Identity Center.</span></span></span>
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: Can Terraform help in provisioning an IAM Identity Center user? I have yet to try that.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Manage access for Amazon Managed Grafana workspace</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon Managed Grafana workspace hosts dashboard/s to display data. In my case, the data source for the dashboard was Amazon CloudWatch. So I created a role that the Grafana workspace could assume to access the data. I achieved that by attaching a policy to the role. If you have worked with IAM roles, you'd know that there are two policies attached to an IAM role: the assume role policy (who can assume this role) and the IAM policy (what can be done to which resources and in my case, access the Amazon Cloudwatch logs).</span></span></span>
<img class="alignnone size-full wp-image-2045" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-11.png" alt="67-image-11" width="535" height="456" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The above code states that only an Amazon Managed Grafana workspace can assume the <code>tf-grafana-assume</code> IAM role. Then I created an IAM policy that allowed access to the Amazon Cloudwatch logs and metrics.</span></span></span>
<img class="alignnone size-full wp-image-2046" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-12.png" alt="67-image-12" width="484" height="708" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And finally, I attached the policy with the desired permissions to the role that the Amazon Managed Grafana workspace can assume.</span></span></span>
<img class="alignnone size-full wp-image-2047" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-13.png" alt="67-image-13" width="733" height="150" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create an Amazon Managed Grafana workspace</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You will rarely create and continuously update your Amazon Managed Grafana, so creating it manually via the AWS console should also be acceptable. However, having worked with Terraform and coming from a DevOps background, I automate as much as possible. I used the <code>aws</code> provider to provision the following resource (<code>aws_grafana_workspace</code>), where I stated the type of resource, the name of the Amazon Managed Grafana workspace, the role that the workspace can assume, and a few other necessary associated features.</span></span></span>
<img class="alignnone size-full wp-image-2024" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-9.png" alt="67-image-9" width="717" height="233" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Grant access to the Amazon Managed Grafana workspace</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this step, I attached the user created in step 1 with the workspace created in step 3 with the following piece of Terraform code.</span></span></span>
<img class="alignnone size-full wp-image-2025" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-10.png" alt="67-image-10" width="751" height="145" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code>user_ids</code> value is the same as that I saved in Step 1 above.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have the Terraform stack and the pipeline to deploy the <em>amg-grafana-stack</em> at my GitHub repository - <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard" target="_blank" rel="noopener">aws_managed_grafana_workspace_dashboard</a>. You will have to navigate to the <code>amg_workspace</code> folder for the code on Amazon Managed Grafana workspace. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So that you know, you will have to tweak the code (only <code>backend.tf</code>) since the configuration (to store the state file) is for my use case.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After the <span style="text-decoration: underline"><a href="https://littlecoding.visualstudio.com/Open-Project/_build?definitionId=33&amp;_a=summary" target="_blank" rel="noopener">CI build ran successfully</a></span>, I verified on the AWS console that Terraform created the Amazon Managed Grafana workspace and associated the correct user with the ADMIN role.</span></span></span>
<img class="alignnone size-full wp-image-1999" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-6.png" alt="67-image-6" width="1429" height="312" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Log in to the Amazon Managed Grafana workspace</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used the Grafana workspace portal URL available on the Workspaces page and the credentials saved in step 1 to log in to the Amazon Managed Grafana workspace. And I was greeted with the familiar home page of an Amazon Grafana Managed workspace.</span></span></span>
<img class="alignnone size-full wp-image-2001" src="https://skundunotes.com/wp-content/uploads/2022/11/67-image-8.png" alt="67-image-8" width="768" height="543" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You might be asked via the login prompt to change your password if you still need to.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I could see the buttons on the left-hand side to create/manage the dashboards, access, and data source configurations.<strong> If my access did not have the gear icon, that would mean I do not have Admin permission.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The next step after creating the workspace is to add a data source, create folders (optional), and create a dashboard/s inside the Amazon Managed Grafana workspace. I have covered that in my next note  -<a href="https://skundunotes.com/2022/12/03/create-an-amazon-managed-grafana-dashboard-using-terraform-and-azure-pipelines/" target="_blank" rel="noopener">Create an Amazon Managed Grafana dashboard using Terraform and Azure Pipelines</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. Let me know if you have any questions or suggestions. For example, creating the Identity center user via Terraform would improve the process. If you know how to do that, please share it with me.</span></span></span>
