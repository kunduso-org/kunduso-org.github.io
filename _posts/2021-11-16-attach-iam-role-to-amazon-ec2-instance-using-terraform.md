---
title: "Attach IAM role to Amazon EC2 instance using Terraform"
date: 2021-11-16 07:55:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have a reasonable level of understanding of the relationship between AWS Identity and Access Management (IAM) policy, role, user, and group. I have also implemented the concept of assumed-role and the <strong>trusted and trusting account association.</strong> You can read more about that at -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/06/05/creating-iam-assume-role-relationship-between-two-aws-accounts/" target="_blank" rel="noopener">Creating IAM assume-role relationship between two AWS accounts</a></span>. So, when I heard of Amazon EC2s being able to assume a role, I was intrigued. Why would I want a virtual machine to assume a role? What is the use case? I did not have to wait too long. I came across two such use cases where I required just that.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before I explored it, the concept was <strong> -assign a set of permissions to an Amazon EC2 instance to carry out a specific set of activities.</strong> Hence I created an<strong> IAM policy file</strong> with a set of permissions/rules and assigned it to an <strong>IAM role</strong>, which was then associated with an <strong>IAM instance profile</strong> that was then assumed by an <strong>Amazon EC2 instance.</strong> The Amazon EC2 instance was then able to perform a set of actions listed in the AWS IAM policy file. If you are new to this concept, please refer to the <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html" target="_blank" rel="noopener">AWS-Docs link.</a></span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I applied the nuances of this concept on a use case I was working on earlier where I created an Amazon EC2 instance in an Amazon Virtual Private Cloud using Terraform. <strong>You can find the code at: <a href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-iam-role" target="_blank" rel="noopener"><span style="text-decoration: underline">add-iam-role</span></a></strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I classified this process into five easy steps.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create a policy file</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The policy file is the blueprint of a list of actions and AWS resources on which an entity can apply those actions. Hence, any entity that is associated with a policy acquires the capability mentioned in the policy file. In this case, the entity has two sets of permissions: (i) the ability to read the parameters mentioned in the parameter store <code>parameter/app-1</code>, and (ii) the ability to list and download the objects in the bucket and folder <code>skundu-proj3-3p-installers/download/</code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><img class="alignnone size-full wp-image-3213" src="https://skundunotes.com/wp-content/uploads/2021/11/55-image-1.png" alt="55-image-1" width="632" height="580" /><code></code></span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create a role that can be assumed by an Amazon EC2 instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A role has two policies: (i) <span style="text-decoration: underline">trust policy:</span> which specifies who or what can assume the role, and (ii) <span style="text-decoration: underline">permission policy:</span> which specifies which actions are available and on which AWS resources. Below is an image of a trust policy associated with a role. The permission policy is inherited from the IAM policy file (Step 1) once associated with the IAM role.</span></span></span>
<img class="alignnone size-full wp-image-3214" src="https://skundunotes.com/wp-content/uploads/2021/11/55-image-2.png" alt="55-image-2" width="462" height="370" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Attach the role to the policy file</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">By attaching the policy to the IAM role, I extended whatever entity assumes this role with the permissions listed under the policy (step 1). Therefore, this is the permission policy of the IAM role.</span></span></span>
<img class="alignnone size-full wp-image-3215" src="https://skundunotes.com/wp-content/uploads/2021/11/55-image-3.png" alt="55-image-3" width="813" height="143" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an instance profile</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">IAM instance profile is the entity that allows IAM role attachment with an Amazon EC2 instance. Conceptually, an instance profile acts like a vessel that contains only one IAM role that an Amazon EC2 instance can assume.</span></span></span>
<img class="alignnone size-full wp-image-3216" src="https://skundunotes.com/wp-content/uploads/2021/11/55-image-4.png" alt="55-image-4" width="768" height="135" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Attach the instance profile to the EC2 instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, the IAM instance profile that carries the IAM role is attached to the Amazon EC2 instance. The Amazon EC2 instance then inherits the permission policy associated with the IAM role (step 3), which the IAM role inherited from the attached IAM policy (step 1).</span></span></span>
<img class="alignnone size-full wp-image-3217" src="https://skundunotes.com/wp-content/uploads/2021/11/55-image-5.png" alt="55-image-5" width="591" height="343" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After making all these changes, I executed the <code>terraform apply</code> command, which ran successfully. Then, I confirmed that the Amazon EC2 instance had the appropriate IAM role attached on the AWS console.</span></span></span>
<img class="alignnone size-full wp-image-3218" src="https://skundunotes.com/wp-content/uploads/2021/11/55-image-6.png" alt="55-image-6" width="1116" height="831" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Generally, attaching an IAM role to an Amazon EC2 instance is part of a more extensive use case. In my case, I required a secure approach to accessing sensitive credentials, and attaching an IAM role with that capability to an Amazon EC2 instance addressed that.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note useful. I would be happy to answer any questions that you might have. Please use the comments section for the same.</span></span></span>
