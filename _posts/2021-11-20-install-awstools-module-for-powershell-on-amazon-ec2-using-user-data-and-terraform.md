---
title: "Install AWS.Tools module for PowerShell on Amazon EC2 using user data and Terraform"
date: 2021-11-20 02:00:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I was under the impression that all Amazon EC2 instances have the latest version of AWS CLI installed. So, I was in for a shock when I discovered that is not always the case. However, I was required to use the AWS CLI, and since this was an Amazon EC2 with Windows OS, I proceeded with installing the <strong>AWS.Tools module for PowerShell.</strong> I automated the installation with the Amazon EC2 user data script and Terraform.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested in the steps to install AWS CLI on an Amazon EC2 instance using the user data script, check this note - <a href="https://skundunotes.com/2021/12/07/install-aws-cli-on-a-windows-ec2-instance-using-terraform-and-user-data/" target="_blank" rel="noopener">Install AWS CLI on an Amazon EC2 instance using Terraform and user data.</a></span></span></span>
<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: I wrote this note as part of a series on Amazon EC2 user data script. However, reading all the earlier notes is unnecessary if you are interested ONLY in the steps involved in installing AWS.Tools module for PowerShell on Amazon EC2. But it won't hurt to read the other notes if you want to get the complete picture and maybe learn something new. I have the links to the other articles in the GitHub repository.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to the Amazon EC2 user data script, I have a separate note to discuss the steps to start using the user data script  -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/07/working-with-aws-ec2-user-data-and-terraform/" target="_blank" rel="noopener">working with Amazon EC2 user data and Terraform.</a></span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">User data could be set to run only once when the Amazon EC2 instance is provisioned or multiple times with each restart. That is managed via the <code>&lt;persist&gt;</code></span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"> flag in the user data script. I prefer having the flag set to <code>&lt;persist&gt;true&lt;/persist&gt;</code> since specific provisioning requirements involve restarts. That implies that the user data script needs to be <span style="text-decoration: underline">idempotent -run as many times, but the end state is the same.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To install <code>AWS.Tools</code> module for PowerShell, I also required the NuGet package to be installed, which had to be idempotent. So the algorithm was:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> Get a list of all the modules installed.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> Check if the <code>AWS.Tools.Installer</code> module exists.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3:</strong> Exit out if the module exists since the desired state exists. Else, move to Step 4.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 4:</strong> Check the list of packages installed since the <code>AWS.Tools.Installer</code> module requires NuGet package version 2.8.5.201 or above.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 5:</strong> If the correct version of the NuGet package is installed, move to Step 6. Otherwise, install the correct version of the package.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 6:</strong> Install the <code>AWS.Tools.Installer</code> module.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I converted the logic associated with the algorithm in the user data script<code>(user_data\user_data.tpl)</code> and stored it in my Github repo: <span style="text-decoration: underline"><a href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-aws.tools-powershell-to-userdata" target="_blank" rel="noopener">add-aws.tools-powershell-to-userdata</a></span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that is how I installed the <code>AWS.Tools</code> module and ran a few AWS CLI commands from the Amazon EC2 instance. If you want to know more, I have two more related notes on the user data script that may interest you: <a href="https://skundunotes.com/2021/11/16/attach-iam-role-to-aws-ec2-instance-using-terraform/" target="_blank" rel="noopener"><span style="text-decoration: underline">How to attach an IAM role to an Amazon EC2</span></a> instance and <a href="https://skundunotes.com/2021/11/17/manage-sensitive-variables-in-aws-ec2-user-data-with-terraform/" target="_blank" rel="noopener"><span style="text-decoration: underline">how to manage sensitive variables in the user data script.</span></a></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note useful. Please do not hesitate to reach out with your suggestions or comments.</span></span></span>
