---
title: "Create an Amazon Managed Grafana dashboard using Terraform and Azure Pipelines"
date: 2022-12-03 21:57:07 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Recently I came across a use case where I was required to create <strong>Grafana dashboards</strong> using the <strong>Terraform Grafana provider</strong>. Although it did not sound too complex, it soon became once I started automating the process using Azure Pipelines. In this note, I documented the challenge and the solution.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before diving deeper, an <strong>Amazon Managed Grafana</strong> workspace is created using the <span style="text-decoration: underline">Terraform AWS provider</span>. Then, a <strong>dashboard</strong> is created in the Amazon Managed Grafana workspace using the <span style="text-decoration: underline"><a href="https://registry.terraform.io/providers/grafana/grafana/latest/docs" target="_blank" rel="noopener">Terraform Grafana provider</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So, it is necessary to have <strong>the Amazon Managed Grafana workspace provisioned before working with the dashboard</strong>. I covered the process of creating one in a separate note, and you can read about that at: <span style="text-decoration: underline"><a href="https://skundunotes.com/2022/11/12/create-an-amazon-managed-grafana-workspace-using-terraform/" target="_blank" rel="noopener">create-an-amazon-managed-grafana-workspace-using-terraform</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As a reader, you might question the decision to separate the deployment of the Amazon Managed Grafana workspace and the dashboard into separate Terraform stacks. And you would be right to ask that. Because by managing two different stacks (one for the workspace and one for the dashboard,) we are increasing the effort to maintain the setup. Before I discuss that, let me walk through the steps to create a dashboard in an Amazon Managed Grafana workspace.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you follow the below process, you might also question the usage of the PowerShell modules in the pipeline. For example, I used the PowerShell modules to create and delete the Grafana workspace API key. Why did I need the API key? The <strong>Terraform Grafana provider</strong> requires two values: the <strong>URL to the workspace</strong> and an <strong>API key with an ADMIN role</strong> to manage resources (folders, dashboards, etc.) in the Amazon Managed Grafana workspace.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Yes, I know there are alternate ways of generating the API key. However, the process I followed was suitable for my use case.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> Terraform must access the AWS Cloud to provision and manage resources. It does so by <strong>securely</strong> accessing the <code>access_key</code> and the <code>secret_key</code> stored in Azure DevOps. I have the procedure detailed in this post: <a href="https://skundunotes.com/2022/03/30/manage-secure-variables-with-azure-devops-library-and-azure-pipelines/" target="_blank" rel="noopener">manage-secure-variables-with-azure-devops-library-and-azure-pipelines</a>. </span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Another Note:</strong> As of January 2024, I updated the code in my GitHub repository to work with the current latest version of the Grafana provider, version <code>2.8.1</code> . When this note was written, the latest version was <code>1.30.0</code> , and hence you might find some images in this post with a reference to that version. Kindly ignore those minor issues.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want the code repository handy as you walk through the steps, here's the link to my <strong>GitHub repo:  <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard" target="_blank" rel="noopener">aws_managed_grafana_workspace_dashboard</a></strong>. You will have to navigate to the <code>amg_dashboard</code> folder for the code on Amazon Managed Grafana dashboard.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Pre-requisite:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Create an Amazon Identity and Access Management (Amazon IAM) user who can manage the resources in this Terraform stack. Store the <code>access_key</code> and <code>secret_key</code> of the user in Azure DevOps Library. If you are cautious and want to use a tight IAM permission policy, I have that in the repository: <code><a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard/blob/main/amg_workspace/user-policy-files/aws-iam-policy.json" target="_blank" rel="noopener">aws-iam-policy.json</a></code>. This policy file provides permissions to manage only the Grafana resources in the code. And here is the path to the IAM permission policy to manage the Terraform state file in an s3 bucket: <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard/blob/main/amg_dashboard/user-policy-files/aws-iam-tf-statefile-policy.json" target="_blank" rel="noopener"><code>aws-iam-tf-statefile-policy.json</code></a>. I attached these two policies to the IAM user whose credentials I stored in Azure DevOps Library.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">From a skillset standpoint, as a developer, you must <span style="text-decoration: underline">know and understand how to create a dashboard in Amazon Managed Grafana workspace using the UI</span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Creating a dashboard in an Amazon Managed Grafana workspace using Terraform and CI-CD pipeline can be broken down into five steps:</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> <strong>Install the PowerShell modules and create an AWS Profile</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since I am deploying this Terraform stack via Azure DevOps Pipelines and have experience working with PowerShell, my defacto standard while interacting with the AWS cloud resources is AWS Tools for PowerShell. If you have yet to hear or use this, please refer to this note : <a href="https://skundunotes.com/2022/09/18/install-and-use-aws-tools-for-powershell-on-azure-devops-pipelines-yaml/" target="_blank" rel="noopener">install-and-use-aws-tools-for-powershell-on-azure-devops-pipelines-yaml</a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I was required to use these three PowerShell modules: <code>AWS.Tools.Installer</code>, <code>AWS.Tools.Common</code>, <code>AWS.Tools.ManagedGrafana</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These are specified in the <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard/blob/main/amg_dashboard/InstallAWSTools.ps1" target="_blank" rel="noopener"><code>InstallAWSTools.ps1</code></a> file stored in the repository.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Using the <code>PowerShell@2</code> task, I installed the modules and then created an AWS Profile that had the <code>access_key</code> and <code>secret_key</code> of the user.</span></span></span>
<img class="alignnone  wp-image-2073" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-2.png" alt="68-image-2" width="703" height="245" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2: Create an API key for the workspace and store the value in</strong> <code>terraform.tfvars</code></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this step, I used the <code>New-GRFWorkspaceApiKey</code> PowerShell Cmdlet to generate an API key. How was I able to use this? In the previous step, I installed the <code>AWS.Tools.ManagedGrafana</code> PowerShell module that provided me with a list of PowerShell Cmdlets. If you want to learn more, click <strong><a href="https://www.powershellgallery.com/packages?q=AWS.Tools.ManagedGrafana" target="_blank" rel="noopener">here</a></strong> and then click on the AWS module. On the new page, scroll down to view the Package Details. All the Cmdlets supported by the module will be listed there.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After creating the API key, I stored the Key value in the variable <code>$apikey</code> and then, using PowerShell, created a string with the <code>grafana_workspace_auth</code> value and the <code>grafana_workspace_url</code> value. Once done, I copied that into the <code>terraform.tfvars</code> file. You will see that the <code>workingDirectory</code> of this step is <code>$(System.DefaultWorkingDirectory)/amg_dasboard</code>. That meant the <code>terraform.tfvars</code> was created in the same directory where the rest of the Terraform source code was stored.</span></span></span>
<img class="alignnone size-full wp-image-2074" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-3.png" alt="68-image-3" width="1215" height="434" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3: Initialize the repository with <code>terraform init</code></strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before getting into the <code>init</code> command, let me discuss the <a href="https://github.com/kunduso/aws_managed_grafana_workspace_dashboard/blob/main/amg_dashboard/provider.tf" target="_blank" rel="noopener"><code>provider.tf</code></a> file.</span></span></span>
<img class="alignnone  wp-image-2075" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-4.png" alt="68-image-4" width="503" height="296" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You will see that the <code>grafana</code> provider requires two variables. The <code>url</code> and the <code>auth</code>, and in the previous step, I added those into the <code>terraform.tfvars</code> file. </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The credential (API Key) of the Amazon Managed Grafana workspace was <strong>generated as part of a build pipeline step</strong> and was not checked-in/committed into the repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The first step while working with Terraform code is to initialize the repository, and I did that using the command, as shown below. Since the Grafana provider credentials were stored in the <code>terraform.tfvars</code> file, the default file for storing Terraform variable values, I did not have to pass the variable file in the <code>terraform init</code> command.</span></span></span>
<img class="alignnone  wp-image-2076" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-5.png" alt="68-image-5" width="688" height="230" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 4: Create a data source</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">One of the first steps while working with an Amazon Managed Grafana workspace is to create a data source. As the name suggests, the data source is where the workspace will pull its data to generate graphs and charts. The role assumed by the Amazon Managed Grafana workspace should have permission to read from the data source. The access is managed in the workspace segment of the code. <em>Refer to Step 2 in this note: <a href="https://skundunotes.com/2022/11/12/create-an-amazon-managed-grafana-workspace-using-terraform/" target="_blank" rel="noopener">create-an-amazon-managed-grafana-workspace-using-terraform</a>. </em></span></span></span>
<img class="alignnone  wp-image-2077" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-6.png" alt="68-image-6" width="679" height="177" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 5: Create a folder and a dashboard</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Creating a folder is an optional step. If I had not created a folder, all the dashboards would have been stored in the root folder of the Grafana workspace. Managing access becomes easier if dashboards are stored in different folders.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created a dashboard using the <a href="https://registry.terraform.io/providers/grafana/grafana/latest/docs/resources/dashboard" target="_blank" rel="noopener"><code>grafana_dashboard</code></a> resource type. I copied the Amazon CloudWatch Logs JSON file from <a href="https://grafana.com/grafana/dashboards/" target="_blank" rel="noopener">grafana-dashboards.</a> </span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That is an <strong>excellent source of pre-built dashboards.</strong> Alternatively, using the UI, you can create a dashboard in an Amazon Managed Grafana workspace. After finalizing all the panels in the dashboard, you can export the dashboard into a JSON file and add that to your Terraform code.</span></span></span>
<img class="alignnone size-full wp-image-2078" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-7.png" alt="68-image-7" width="716" height="228" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 6: Delete the API key and the AWS PowerShell profile</strong></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once the dashboard was deployed successfully via the Azure DevOps Pipeline, I used the <code>Remove-MGRFWorkspaceApiKey</code> Cmdlet to remove the key created in the earlier step (step 2). Then I also deleted the AWS Profile that I created earlier. There is a condition statement with both these tasks that is set to <code>always()</code>, which implies that even if certain tasks have failed before this task, these two tasks will run. Generally, if steps in a pipeline fail, no further steps are executed unless <code>condition: always()</code> added to that task. That way, I ensure that I do not leave an API key and an AWS Profile un-delete once the pipeline has ended  -successfully or otherwise.</span></span></span>
<img class="alignnone  wp-image-2079" src="https://skundunotes.com/wp-content/uploads/2022/12/68-image-8.png" alt="68-image-8" width="646" height="315" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note on generating a dashboard using Terraform and Azure DevOps.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to dive deeper and access the Azure DevOps build logs, you may find them here: <span style="text-decoration: underline"><a href="https://littlecoding.visualstudio.com/Open-Project/_build?definitionId=34&amp;_a=summary" target="_blank" rel="noopener">kunduso.aws_managed_grafana_workspace_dashboard.dashboard</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this article helpful as you learn more about working with Amazon Managed Grafana, Terraform, and the Grafana Terraform provider. If you have any questions or suggestions, please do not hesitate to reach out.</span></span></span>
