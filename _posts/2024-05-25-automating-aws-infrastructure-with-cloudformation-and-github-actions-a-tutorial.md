---
title: "Automating AWS Infrastructure with CloudFormation and GitHub Actions: A Tutorial"
date: 2024-05-25 01:22:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note aims to demonstrate how to deploy a couple of CloudFormation templates using GitHub Actions to create Amazon cloud resources.</span></span></span>
<!--more--><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are two tools we're discussing. The first one is <strong>AWS CloudFormation</strong>, an infrastructure as a code tool to provision AWS cloud resources declaratively. The AWS cloud resources and their relationships are declared in an AWS CloudFormation template written in JSON or YAML format. The template is then deployed using the AWS CLI. The second one is<strong> GitHub Actions</strong>, which enables you to automate workflows and is a suitable tool for running the AWS CLI to deploy the AWS cloud resources. By utilizing both these tools, I will demonstrate how to create an automated process to deploy the IaC and provision AWS cloud resources repetitively.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are four necessary components to understand while working on AWS CloudFormation. These are <strong>'templates,' 'parameters,' 'resources,' </strong>and<strong> 'stacks'</strong>. At the heart of AWS CloudFormation are the templates. These <span style="text-decoration: underline">templates</span> are in either JSON or YAML format. The <span style="text-decoration: underline">parameters</span> are a list of key-value pairs in JSON format to store values referenced in the AWS CloudFormation templates. <span style="text-decoration: underline">Resources</span> are the AWS cloud resources such as Amazon VPC and Amazon EC2 and their associations such as SubnetRouteTableAssocation. And finally, a <span style="text-decoration: underline">stack</span> is the deployed form of the template accessible on the AWS Console. A stack contains information such as the ID, deployment status, the IAM role used to deploy the stack, the resources deployed, the events while deploying the stack, and such. You can read more about AWS CloudFormation at <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html" target="_blank" rel="noopener">AWS-Docs: CloudFormation</a>.</span></span></span>

<strong><span style="font-size: 22px"><span style="font-family: calibri"><span style="color: #000000">Pre-requisites: Configure AWS Credentials for GitHub Actions</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To authenticate with AWS from your GitHub Actions workflow, you'll need to configure AWS credentials. This use case requires <span style="text-decoration: underline">two AWS IAM roles</span>: one to authenticate to the AWS cloud from the GitHub workflow and the other to deploy the AWS CloudFormation template. Follow the steps in [<a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener">this detailed guide</a>] to set up the AWS IAM role required to authenticate to the AWS cloud and store them as a GitHub repository secret. The first IAM role (<code>IAM_ROLE</code> in the code repository), apart from the trust relationship policy (with GitHub, explained in the detailed guide), has a permission policy. The permission policy is stored in the GitHub repository as <code>./iam_policy/github_permission.json</code>. Please replace <code>${replace-with-arn-of-IAM-role-stored-as-secrets.CFN_ROLE}</code> with the ARN of the second IAM role.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The second IAM role (<code>CFN_ROLE</code> in the code repository) has <span style="text-decoration: underline">two policies</span>: a trust policy and a permission policy. The trust policy is stored in the GitHub repository as <code>./iam_policy/cloudformation_permission.json</code>. Please replace <code>${replace-with-arn-of-IAM-role-stored-as-secrets.IAM_ROLE}</code> with the ARN of the first IAM role. The permission policy must also have permission to manage the AWS cloud resources, as mentioned in the two template files stored in the templates folder.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have the code stored in my <a href="https://github.com/kunduso/add-asg-lb-cloudformation" target="_blank" rel="noopener">GitHub repository: add-asg-lb-cloudformation</a>, and you may follow along to learn more.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The code repository is divided into four folders.</span></span></span>
<img class="alignnone size-full wp-image-3856" src="https://skundunotes.com/wp-content/uploads/2024/05/93-image-1.png" alt="93-image-1" width="302" height="368" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The <code>templates</code> folder contains the AWS CloudFormation templates for deploying AWS cloud resources. The <code>parameters</code> folder contains the key-value pairs of properties used in the AWS CloudFormation templates. The <code>iam_policy</code> folder contains the IAM policies for the two roles used in this project. Finally, the <code>.github/workflows</code> folder contains the logic for deploying the templates with the parameters in a repeatable process.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For this example, I chose two templates. The first one (<code>layer-zero.yaml</code>) is to create an Amazon VPC with four subnets. Two subnets have an internet gateway attached to it while the other two have NAT gateways. The route tables for these four subnets have appropriate associations to enable communication to the internet. The template exports the VPC and Subnet IDs as output to be referenced in the second template. The second template (<code>layer-one.yaml</code>) creates a couple of security groups with associated ingress and egress rules. It also creates an Amazon EC2 auto-scaling group with scale-out and scale-in policies using AWS CloudWatch alarms and a load balancer.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The deployment process is automated via the <code>.github/workflows/deploy-cfn.yml</code> GitHub Actions workflow. I set a few defaults, like the working directory and the pipeline's permissions. After setting those, the workflow has three primary steps.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Checkout and Configure AWS credentials for the workflow</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The first step is to checkout the code, followed by configuring AWS credentials for the workflow.</span></span></span>
<img class="alignnone size-full wp-image-3857" src="https://skundunotes.com/wp-content/uploads/2024/05/93-image-2.png" alt="93-image-2" width="724" height="188" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You'll need to configure AWS credentials to authenticate with AWS from your GitHub Actions workflow. Please provide the IAM role created in the pre-requisites section.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Deploy layer-zero AWS CloudFormation template</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS CloudFormation deployment process is classified in a layered approach such that the infrastructure layers above depend on the layers below. In the command below, the AWS CLI calls the deploy function with the template, the stack name, parameters, and the IAM role ARN. The IAM role refers to the CFN_ROLE stored in the repository as a secret. You can read more about the deploy command at <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/cli/latest/reference/cloudformation/deploy/" target="_blank" rel="noopener">aws cloudformation deploy</a></span>.</span></span></span>
<img class="alignnone size-full wp-image-3858" src="https://skundunotes.com/wp-content/uploads/2024/05/93-image-3.png" alt="93-image-3" width="515" height="164" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Deploy layer-one AWS CloudFormation template</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Layer zero exports a few properties required in the Layer one stack. Also, since the layer deploys IAM resources, a  <code>--capabilities</code> property is required. The rest of the options are the same as the layer zero stack.</span></span></span>
<img class="alignnone size-full wp-image-3859" src="https://skundunotes.com/wp-content/uploads/2024/05/93-image-4.png" alt="93-image-4" width="471" height="184" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After the pipeline ran successfully, I navigated to AWS CloudFormation on the AWS Console.</span></span></span>
<img class="alignnone size-full wp-image-3860" src="https://skundunotes.com/wp-content/uploads/2024/05/93-image-5.png" alt="93-image-5" width="1231" height="405" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS CloudFormation stack contained information about when it was created, the IAM role associated with it, the events, the resources, and so forth.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As I was working on automating the deployment process, I integrated Checkov to identify security vulnerabilities. You can read more at  -<a href="https://skundunotes.com/2023/04/12/automate-terraform-configuration-scan-with-checkov-and-github-actions/" target="_blank" rel="noopener">scan-with-checkov-and-github-actions</a>. Although that link is to review Terraform code, the logic remains the same for AWS CloudFormation templates. You can navigate to the workflow file for details: <code>.github/workflows/code-scan.yml</code>.</span></span></span>

<strong><span style="font-size: 22px"><span style="font-family: calibri"><span style="color: #000000">Best Practices</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I implemented a few best practices while working on this project, such as:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline"><strong>Store Source Code in a GitHub Repository:</strong></span> Leverage version control and collaboration features of Git and GitHub for managing your CloudFormation templates.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline"><strong>Use Source Control to Manage Your Templates:</strong></span> Treat your CloudFormation templates as code and follow best practices for source control management, such as branching, committing, and code reviews.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline"><strong>Create a Role for Stack Deployment:</strong> </span>Follow the principle of least privilege and create a dedicated IAM role with the minimum necessary permissions for deploying CloudFormation stacks.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline"><strong>Use Parameter Files with CloudFormation:</strong></span> Separate configuration values from your CloudFormation templates by using parameter files to improve maintainability and manage different configurations for different environments.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline"><strong>Leverage Stack Outputs and Imports to Reference Cross-Stack Resources:</strong> </span>Export and import output values across stacks to build modular and reusable components and create dependencies between stacks.</span></span></span>

<strong><span style="font-size: 22px"><span style="font-family: calibri"><span style="color: #000000">Challenges</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As I was working on this project, I came across a few challenges that I list below:</span></span></span>
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Renaming a Stack in CloudFormation:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- If you rename an existing CloudFormation stack, AWS treats it as an entirely new stack. You cannot simply update the existing stack with the new name.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- Instead, you must create a new stack with the desired name and migrate all resources from the old stack to the new one.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- This process can be time-consuming and error-prone, especially for complex stacks with many resources and dependencies.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- To avoid this issue, it's recommended to carefully plan and choose appropriate stack names from the beginning, as renaming stacks is a complex process.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Rollback and Stack Update Limitations:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- If a previous CloudFormation stack deployment process encountered errors and the stack status is set to ROLLBACK_COMPLETE, you cannot directly update that stack with a new template.</span></span></span>
<img class="alignnone size-full wp-image-3861" src="https://skundunotes.com/wp-content/uploads/2024/05/93-image-6.png" alt="93-image-6" width="1104" height="116" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- In such cases, you need to manually delete the failed stack from the AWS Console or use the AWS CLI before you can deploy the updated CloudFormation template.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- Manually deleting a stack can be a lengthy process, especially for stacks with many resources, as CloudFormation needs to delete each resource in the correct order while handling dependencies.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- This limitation can delay your deployment process and introduce additional manual steps, which can be error-prone and time-consuming.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Lack of Clear Error Indication in GitHub Actions Workflow:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- When a CloudFormation stack deployment fails in a GitHub Actions workflow, the error messages or indications may not be immediately apparent or clear within the workflow logs.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- You may need to log into the AWS Console, navigate to the CloudFormation service, and inspect the specific stack's events to understand the root cause of the failure.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- This extra step of navigating to the AWS Console can be inconvenient, especially when troubleshooting issues within a continuous integration and continuous deployment (CI/CD) pipeline, where you expect clear and concise feedback within the workflow logs.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Parameter Handling in CloudFormation Templates:</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- Simply passing a parameter file to the <code>aws cloudformation deploy</code> command is not sufficient for CloudFormation to recognize and use those parameters.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- The parameters must also be explicitly defined and referenced within the CloudFormation template.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- Failing to include the parameter definitions in the template can lead to deployment errors or unexpected behavior, as CloudFormation will not be able to map the provided parameter values correctly.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- This limitation can be confusing, especially for those new to CloudFormation, as it may not be immediately apparent that parameters must be defined in both the template and the parameter file.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">By understanding and addressing these challenges, you can better prepare for and mitigate potential issues when deploying AWS infrastructure with CloudFormation and GitHub Actions. Proper planning, documentation, and adherence to best practices can help minimize the impact of these drawbacks and ensure a smoother deployment process.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Despite these drawbacks, I believe that AWS CloudFormation has its place in the IaC sphere, particularly if a customer wants to use purely AWS systems. That brings us to the end of this note. I hope you learned something new from it. Please do not hesitate to use the comments box below if you have any questions or suggestions.</span></span></span>
