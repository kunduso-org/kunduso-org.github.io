---
title: "Protecting Credentials and Variables in AWS Fargate Containers using AWS Secrets Manager"
date: 2024-07-02 11:59:54 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Credentials and sensitive variables allow access to confidential data and must be protected from unauthorized access so only <span style="text-decoration: underline">permitted entities can access them</span>. AWS Fargate is a technology that can be used with Amazon ECS to run <a href="https://aws.amazon.com/what-are-containers" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">containers</span></span></span></a>. AWS Fargate is commonly used to run workloads to interact with databases or access confidential data or services. Security best practice demands that credentials enabling access to such confidential data must not be stored in the container or in the code inside the container. Instead, they must <span style="text-decoration: underline">use cloud-native solutions</span> like AWS Secrets Manager secret. <span style="text-decoration: underline">Role-based access control</span> must also be employed to manage who or what can access credentials.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I explain how to store sensitive variables in the AWS Secrets Manager secret and securely access them from an AWS Fargate task container. This use case has five steps:</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> Store a sensitive variable as a secret in AWS Secrets Manager</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2</strong>. Create a VPC Endpoint to access AWS Secrets Manager</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> Update the Amazon ECS task definition to access the secret</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4.</strong> Create an IAM permission policy and attach it to the task roles to access the secret</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5.</strong> Update the Node.js application to access and display the secret</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After implementing these five steps, GitHub Actions pipelines will deploy these changes to the AWS cloud environment.</span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000">Please note that displaying or logging sensitive variable values is not a recommended security best practice. I display that to demonstrate that the Fargate task can access the secret.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I build upon the concepts discussed in my previous three notes. If you are unfamiliar with Amazon ECS and want to learn about the service in detail, I recommend going through these three notes. If you need more time to explore these, go through the last note, where I explain the primary services you will be working with in this note -Amazon ECS Service, ECS task definition, and the two IAM roles.</span></span></span>

<a href="https://skundunotes.com/2024/04/10/create-infrastructure-to-host-an-amazon-ecs-service-using-terraform/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">1. Provision of the underlying infrastructure to host an Amazon ECS service.</span></span></span></a>
<a href="https://skundunotes.com/2024/04/28/push-docker-image-to-amazon-ecr-using-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">2. Push a Docker image to Amazon Elastic Container Registry (Amazon ECR).</span></span></span></a>
<a href="https://skundunotes.com/2024/05/06/continuous-deployment-of-amazon-ecs-service-using-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">3. Create a service/task from the Docker image and host it on Amazon ECS.</span></span></span></a>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have the Terraform code to create and manage these AWS Cloud resources in my GitHub repository. So, if you are interested and want to follow along, here is a link to my code repository on <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/tree/create-ecs-service" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub: kunduso/add-aws-ecr-ecs-fargate</span></span></span></a>.</span></span></span><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000"> Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = create-ecs-service</code>.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Store a sensitive variable as a secret in AWS Secrets Manager</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The below Terraform code adds an AWS Secrets Manager secret resource and updates the latest version with the value from <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">var.ecs_secret</code>.</span></span></span>
<img class="alignnone size-full wp-image-4289" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-1.png" alt="96-image-1" width="954" height="426" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The value of the variable <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">ecs_secret</code> must not be stored in Terraform code as plain text since it is sensitive and inaccessible to all. In this use case, the value is stored as a GitHub Secret and passed to Terraform using the GitHub Actions pipeline step, as shown below.</span></span></span>
<img class="alignnone size-full wp-image-4290" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-2.png" alt="96-image-2" width="770" height="159" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have a separate note explaining <a href="https://skundunotes.com/2023/04/16/create-aws-secrets-manager-secret-using-terraform-secure-variables-and-github-actions-secrets/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">how to manage sensitive credentials with AWS Secrets Manager, Terraform, and GitHub Actions</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create a VPC Endpoint to access AWS Secrets Manager</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS Fargate containers are hosted in the private subnet and, hence, do not have access to the internet. Adding a VPC endpoint to access AWS Secrets Manager enables the request and response traffic to remain within the Amazon network.</span></span></span>
<img class="alignnone size-full wp-image-4291" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-3.png" alt="96-image-3" width="720" height="262" />

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Update the Amazon ECS task definition to access the secret</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The ECS task definition is the blueprint of the ECS service. It defines the Docker image, CPU and memory requirements, networking configuration, and other settings for the tasks in the service. One such setting in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">container_definitions</code> is the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">secrets</code> configuration that holds the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">name</code> and the source(<code style="background-color: #dcdcdc;font-size: 15px;color: #000000">valueFrom</code>) of the secret.</span></span></span>
<img class="alignnone size-full wp-image-4292" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-4.png" alt="96-image-4" width="819" height="178" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">To access all the properties in an Amazon ECS task definition template, choose <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-definition-template.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">ECS-task-definition-template</span></span></span></a>, and for a detailed description of the properties, choose <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Amazon-ECS-task-definition-parameters</span></span></span></a>.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an IAM permission policy and attach it to the task roles to access the secret</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are two IAM roles in this use case - the <span style="text-decoration: underline">task execution role</span> and <span style="text-decoration: underline">the task role</span>. The task execution role must have the permission to create the Amazon ECS service along with a few other mandatory permissions that are included in the AWS Managed policy <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy</code>. The managed policy is attached to the task execution role. I followed the recommendations in <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html#task-execution-private-auth" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Task Execution IAM Role: Private registry authentication permissions</span></span></span></a> and created the IAM policy.</span></span></span>
<img class="alignnone size-full wp-image-4293" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-5.png" alt="96-image-5" width="807" height="460" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since the Amazon ECS task definition refers to the AWS Secrets Manager resource, I attached the IAM permission policy to the task execution role.</span></span></span>
<img class="alignnone size-full wp-image-4294" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-6.png" alt="96-image-6" width="817" height="144" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS Docs</span></span></span></a>, Amazon ECS tasks can have an associated IAM role. The permissions granted in the IAM role are assumed by the containers running in the task. This role allows the application code (on the container) to use other AWS services. In this use case, the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">Node.js</code> application in the Docker container hosted in AWS Fargate interacts with the AWS Secrets Manager to access and decrypt the secret. Hence, I attached the IAM permission policy to the task role.</span></span></span>
<img class="alignnone size-full wp-image-4295" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-7.png" alt="96-image-7" width="805" height="136" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Update the Node.js application to access and display the secret</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The logic to access the AWS Secrest Manager secret is in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">secrets.js</code> file in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">Node.js</code> application that is hosted inside a Docker container.</span></span></span>
<img class="alignnone size-full wp-image-4296" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-8.png" alt="96-image-8" width="734" height="542" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And, the step to display the value of the secret is in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">home.handlebars</code> file.</span></span></span>
<img class="alignnone size-full wp-image-4297" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-9.png" alt="96-image-9" width="527" height="229" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Please note, as I stated earlier, that displaying or logging secrets is poor programming practice. I am only doing that to demonstrate the process of accessing secrets in the AWS Fargate task.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once all the code was updated, I deployed the changes individually. There are <span style="text-decoration: underline">two deployment pipelines</span>:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- The AWS Secrets Manager secret and the VPC endpoint Terraform configuration are inside the Infrastructure stack in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">\infra</code> folder and deployed using the <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/actions/workflows/terraform.yml" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub Actions pipeline: terraform-infra-provisioning</span></span></span></a>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">- The <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">Node.js</code> application and the Amazon ECS service are deployed via the multi-job <a href="https://github.com/kunduso/add-aws-ecr-ecs-fargate/actions/workflows/app-ci-cd.yml" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">GitHub Actions pipeline: docker-build-deploy</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After the GitHub Actions pipelines deployed these changes into the AWS cloud, I logged into the AWS console and navigated to Amazon Elastic Container Service → Cluster = app-6 → Service - app-6 → Tab = Tasks.</span></span></span>
<img class="alignnone size-full wp-image-4298" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-10.png" alt="96-image-10" width="1061" height="438" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Health status of "<strong><span style="color: #05ac26">Healthy</span></strong>" meant that the containers were up and responding successfully to the HealthCheck rule. I have a separate note demonstrating <a href="https://skundunotes.com/2024/06/27/enabling-health-checks-and-cloudwatch-logs-for-aws-fargate-tasks/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">how to add HealthCheck to the AWS Fargate task</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With the HealthCheck passing, I navigated to the Load balancer, copied its DNS name, pasted it into the internet browser (Google Chrome), and followed it with the port number, which is 8080. I was greeted with the message below.</span></span></span>
<img class="alignnone size-full wp-image-4299" src="https://skundunotes.com/wp-content/uploads/2024/06/96-image-11.png" alt="96-image-11" width="1343" height="936" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see, the homepage correctly displayed the Secret Value. To validate, you can log in to the AWS Console → Secrets Manager and change the value of the secret. After you refresh the DNS URL in your browser, you'll examine the updated password.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of this note. I hope you can follow along and learn how to access the AWS Secrets Manager secret from an AWS Fargate task container. Please do not hesitate to contact me via the comments if you have any questions or suggestions.</span></span></span>
