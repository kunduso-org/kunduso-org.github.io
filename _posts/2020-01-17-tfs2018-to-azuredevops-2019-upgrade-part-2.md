---
title: "TFS2018 to AzureDevops 2019 Upgrade -Part 2"
date: 2020-01-17 22:01:04 +0000
categories: []
tags: []
---

<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Table of Contents:</span></span></span></strong>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;"><a href="http://skundunotes.com/2020/01/17/tfs2018-to-azuredevops-2019-upgrade-part-1/">TFS2018 to AzureDevops 2019 Upgrade Part 1: Approach</a></span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TFS2018 to AzureDevops 2019 Upgrade Part 2: Create TFS Sandbox (this article)</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;"><a href="http://skundunotes.com/2020/01/17/tfs2018-to-azuredevops-2019-upgrade-part-3/">TFS2018 to AzureDevops 2019 Upgrade Part 3: Upgrade sandbox instance to Azure Devops 2019</a></span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;"><a href="http://skundunotes.com/2020/01/17/tfs2018-to-azuredevops-2019-upgrade-part-4/">TFS2018 to AzureDevops 2019 Upgrade Part 4 Upgrade production instance to Azure Devops 2019</a></span></span></span>

<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">As stated in the previous note (Part 1: Approach), the objective here is to create a parallel TFS instance (sandbox) that is identical to (but separate from) production TFS instance.</span></span></span><!--more-->

<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Our production TFS instance (application and database tiers) are hosted on:</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TFS application on Windows 2012 Standard Edition</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TFS database on Windows 2012R2 on SQL 2016 SP1</span></span></span>

<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">In order to create a sandbox TFS instance, both the application and database virtual machines were provisioned to be identical to production TFS instances -<strong>same hardware configuration, same version of Windows OS and SQL database were installed.</strong></span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">The idea was to – (i) <strong>install a fresh instance</strong> of TFS2018.Update2; stop and detach the collection</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">(ii) <strong>detach the two databases</strong> that got created as part of installation and restore them from production backups and </span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">(iii) <strong>execute a series of commands</strong> to align the newly attached databases to work with the installed instance of TFS2018.Update2.</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Here is an image of the sequence of steps that were followed... I’ve provided details on these steps below.</span></span></span>
<img class="alignnone size-full wp-image-322" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image1-1.png" alt="AzureDevopsUpgrade-Part2Image1" width="1260" height="799" />
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step1: Install TFS2018.Update2 on sandbox TFS instance</span></span></span></strong>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">I proceeded with a fresh installation of TFS2018.Update2 on the application tier server. I won't be listing down the steps here (<em>there are enough guides available that provide a walk-through of how to install TFS2018.Update2</em>)</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">I named the collection DefaultCollection, because that is the name of my production TFS collection. Below is an image of Administration Console after installation.</span></span></span>
<img class="alignnone size-full wp-image-279" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image2.png" alt="AzureDevopsUpgrade-Part2Image2" width="882" height="502" />
<em><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">(although this is sandbox and the details are short-lived, I'm going to wipe out company specific details)</span></span></span></em>
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step2: TFSServiceControl quiesce to stop all services</span></span></span></strong>
<img class="alignnone size-full wp-image-280" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image3.png" alt="AzureDevopsUpgrade-Part2Image3" width="679" height="110" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">This command took about 4-5 minutes since a lot of related services were stopped.</span></span></span>
<em><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Note: I navigated to the location where TfsServiceControl utility was located. In this case "C:\Program Files\Microsoft Team Foundation Server 2018\Tools" since the path was not added to environment variable.</span></span></span></em>
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step3: Stop Collection</span></span></span></strong>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">On the Administration Console I stopped the Collection as shown in below image.</span></span></span>
<img class="alignnone size-full wp-image-281" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image4.png" alt="AzureDevopsUpgrade-Part2Image4" width="922" height="400" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">...and provided a reason for the same.</span></span></span>
<img class="alignnone size-full wp-image-282" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image5.png" alt="AzureDevopsUpgrade-Part2Image5" width="453" height="201" />
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step4: Detach Collection</span></span></span></strong>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">After stopping, I Detach<em>-ed</em> the Collection.</span></span></span>
<img class="alignnone size-full wp-image-283" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image6.png" alt="AzureDevopsUpgrade-Part2Image6" width="883" height="504" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">This opened a Detach Team Project Collection utility. The console prompted me to have a backup of the database being detached, followed by a verify.</span></span></span>
<img class="alignnone size-full wp-image-284" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image7.png" alt="AzureDevopsUpgrade-Part2Image7" width="750" height="453" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">And then Detach which took less than 15 seconds.</span></span></span>
<img class="alignnone size-full wp-image-285" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image8.png" alt="AzureDevopsUpgrade-Part2Image8" width="749" height="450" />
<img class="alignnone size-full wp-image-286" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image9.png" alt="AzureDevopsUpgrade-Part2Image9" width="751" height="454" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">After detaching the collection this is how the Administration Console looked:</span></span></span>
<img class="alignnone size-full wp-image-287" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image10.png" alt="AzureDevopsUpgrade-Part2Image10" width="882" height="505" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">All the steps on TFS application server were completed and the next 2 steps were performed on the database server.</span></span></span>
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step 5 and 6: Detach Tfs_Configuration and Tfs_DefaultCollection databases from DB Server and restore from production backup</span></span></span></strong>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">On the database server, we noticed two newly created databases as part of fresh TFS2018.Update2 installation. These were Tfs_Configuration and Tfs_DefaultCollection. Since we were setting up a parallel instance (identical to production TFS), we had no use of these two databases and detached them from SQL server.</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">At this point the SQL server had no databases attached to it with the name Tfs_Configuration and Tfs_DefaultCollection. We then restored the production backup versions of the same two databases. <strong>This is an important step.</strong></span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">After both databases were restored, I moved back to the application server and tried to launch TFS Administration console wherein I was presented with the below error.</span></span></span>
<img class="alignnone size-full wp-image-288" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image11.png" alt="AzureDevopsUpgrade-Part2Image11" width="491" height="293" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">This error was expected and quite descriptive. The Tfs_Configuration database <em>still</em> had values from the production DB server and we needed to update them to align with the sandbox TFS DB server.</span></span></span>
<em><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Note: Below series of commands had company specific details and hence I am providing some replacement variables for the sake of understanding.</span></span></span></em>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">${TFSApplicationInstance} = TFS application tier server</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">${TFSDatabaseInstance} = TFS database tier server</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">${TFSUserAccount} = service account under which TFS service run</span></span></span>
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step 7: Remap database</span></span></span></strong>
<img class="alignnone size-full wp-image-289" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image12.png" alt="AzureDevopsUpgrade-Part2Image12" width="648" height="452" />
<code><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TFSConfig RemapDBs /DatabaseName:<em>${TFSDatabaseInstance}</em>\TFSDB;Tfs_Configuration /SQLInstances:<em>${TFSDatabaseInstance}</em>\TFSDB /preview</span></span></span></code>
<em><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Note: the command is being triggered with a "/preview" option.</span></span></span></em>
<img class="alignnone size-full wp-image-290" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image13.png" alt="AzureDevopsUpgrade-Part2Image13" width="645" height="237" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">This error was caused because the production backup of Tfs_DefaultCollection was not restored (instead the same Tfs_DefaultCollection that came with the fresh installation was re-attached) while the Tfs_Configuration DB was from the backup. This was an error on my part. The same command was triggered after (detaching wrong collection and) restoring the correct backup for Tfs_DefaultCollection which displayed a non error response.</span></span></span>
<img class="alignnone size-full wp-image-291" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image14.png" alt="AzureDevopsUpgrade-Part2Image14" width="644" height="247" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">This looked good and I executed the remap command without <em>/preview</em> option.</span></span></span>
<img class="alignnone size-full wp-image-292" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image15.png" alt="AzureDevopsUpgrade-Part2Image15" width="644" height="272" />
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step 8: Reset Owner</span></span></span></strong>
<code><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TFSConfig Accounts /ResetOwner /SQLInstance:<em>${TFSDatabaseInstance}</em>\TFSDB /DatabaseName:Tfs_Configuration</span></span></span></code>
<img class="alignnone size-full wp-image-293" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image16.png" alt="AzureDevopsUpgrade-Part2Image16" width="643" height="324" />
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step 9: Add accounts</span></span></span></strong>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">It is always a good idea to run the sandbox TFS instance under a separate account than production TFS instance and we addressed that via the command below</span></span></span>
<code><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TfsConfig Accounts /add /AccountType:ApplicationTier /account:<em>${TFSUserAccount}</em> /SQLInstance:<em>${TFSDatabaseInstance}</em>\TFSDB /DatabaseName:Tfs_Configuration</span></span></span></code>
<img class="alignnone size-full wp-image-294" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image17.png" alt="AzureDevopsUpgrade-Part2Image17" width="580" height="714" />
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step 10: Register Database</span></span></span></strong>
<code><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TfsConfig RegisterDB /SQLInstance:<em>${TFSDatabaseInstance}</em>\TFSDB /DatabaseName:Tfs_Configuration</span></span></span></code>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">I had the Administration Console (error message with code TF246083; image# 11 above) opened due to which the error in red below was thrown. I closed the console and re-ran the command -without any errors.</span></span></span>
<img class="alignnone size-full wp-image-295" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image18.png" alt="AzureDevopsUpgrade-Part2Image18" width="643" height="398" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">That was the end of re-configuration and I was ready to start services to see if everything was well consumed.</span></span></span>
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Step 11: TfsServiceControl unquiesce</span></span></span></strong>
<img class="alignnone size-full wp-image-296" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image19.png" alt="AzureDevopsUpgrade-Part2Image19" width="643" height="164" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">...and everything went ok till there. After that I opened TFS Administration console once again to check.</span></span></span>
<strong><span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">AND THE CONSOLE CAME UP!!!</span></span></span></strong>
<img class="alignnone size-full wp-image-297" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image20.png" alt="AzureDevopsUpgrade-Part2Image20" width="884" height="503" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">On further review I noticed the URL was pointed to Production TFS instance -I updated that to ${TFSApplicationInstance}. Inorder to do so I navigated to Application Tier and clicked on Change Public URL. After updating that, I Test<em>-ed</em> to make sure it responded -green tick.</span></span></span>
<img class="alignnone size-full wp-image-300" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image23.png" alt="AzureDevopsUpgrade-Part2Image23" width="1078" height="407" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">Also, scheduled backups appeared to be configured. This was a setting that carried forward from production TFS instance. Since this was a sandbox instance, I felt there was no need for backups and disabled them.</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">TFS Administration Console -&gt; Scheduled Backups -&gt; Disable Scheduled Backups</span></span></span>
<img class="alignnone size-full wp-image-298" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image21.png" alt="AzureDevopsUpgrade-Part2Image21" width="1092" height="472" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">The below page confirmed that no backups were scheduled.</span></span></span>
<img class="alignnone size-full wp-image-299" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image22.png" alt="AzureDevopsUpgrade-Part2Image22" width="1093" height="374" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">I also checked the rest of the configuration values on the same page... (scrolled down) to make sure there were no values that referenced TFS production instance (application and database tiers), including the email sender.</span></span></span>
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">On the database server, I checked the value in dbo.tbl_Database table in Tfs_Configuration database. It matched the one in the TFS Administration Console for sandbox instance and not TFS production instance.</span></span></span>
<img class="alignnone size-full wp-image-301" src="https://skundunotes.com/wp-content/uploads/2020/01/azuredevopsupgrade-part2image24.png" alt="AzureDevopsUpgrade-Part2Image24" width="1022" height="373" />
<span style="font-size:18px;"><span style="font-family:calibri;"><span style="color:#000000;">After conducting all these checks, I was able to confirm that the sandbox TFS instance was as good as production TFS instance and that we were ready to move to the next step of upgrading sandbox TFS instance to AzureDevops 2019. Woohoo!!</span></span></span>
