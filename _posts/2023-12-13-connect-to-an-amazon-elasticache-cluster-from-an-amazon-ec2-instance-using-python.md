---
title: "Connect to an Amazon ElastiCache cluster from an Amazon EC2 instance using Python"
date: 2023-12-13 13:19:33 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This note continues my previous note on Amazon ElastiCache for Redis. In my earlier note, I demonstrated how to <span style="text-decoration: underline"><a href="https://skundunotes.com/2023/10/21/create-an-amazon-elasticache-for-redis-cluster-using-terraform/" target="_blank" rel="noopener">create an Amazon ElastiCache for the Redis cluster using Terraform</a></span> and automate the process using GitHub Actions. In this note, I explain how to connect to the ElastiCache cluster using <span style="text-decoration: underline">Python</span> from an Amazon EC2 instance. I have a link to my GitHub repository with the Terraform and Python code.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Prerequisites:</strong> Create all the resources discussed in the previous note.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are three high-level steps to this use case: </span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> Create all the supporting additional infrastructure.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> Log into an Amazon EC2 instance and write into the ElastiCache cluster using Python.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3:</strong> Log into another Amazon EC2 instance and read from the ElastiCache cluster using Python.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I will explain these steps in detail. If you are interested in following along, please check my <a href="https://github.com/kunduso/amazon-elasticache-redis-tf" target="_blank" rel="noopener">GitHub repository: amazon-elasticache-redis-tf.</a></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create all the supporting additional infrastructure</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I discussed the majority of the infrastructure for this use case in my previous note, such as the Amazon Virtual private cloud, subnets, route tables, security groups, Amazon ElastiCache for Redis, and the SSM parameter store to store the ElastiCache endpoint. However, since I am connecting to the ElastiCache cluster from an Amazon EC2 instance using Python, I need <span style="text-decoration: underline">additional AWS cloud resources</span>. These are:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-an internet gateway and a route to the internet,</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-an IAM policy and instance profile to access the Amazon EC2 instance and</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-the Amazon EC2 instances to access the ElastiCache cluster.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This use case does not require internet access. But, since I am using Python3 to access the Amazon ElastiCache for the Redis cluster, there are <span style="text-decoration: underline">specific libraries</span> to install on the Amazon EC2 instance, such as <code><span style="font-size: 15px"><span style="color: #0047ab">python-pip</span></span></code>, <code><span style="font-size: 15px"><span style="color: #0047ab">python3</span></span></code>, <code><span style="font-size: 15px"><span style="color: #0047ab">redis-py-cluster</span></span></code>, and <code><span style="font-size: 15px"><span style="color: #0047ab">boto3</span></span></code>. The Amazon EC2 instances require internet access to install these libraries. That is possible by attaching an internet gateway to the Amazon VPC and adding a route in the route table.</span></span></span>
<img class="alignnone size-full wp-image-3255" src="https://skundunotes.com/wp-content/uploads/2023/12/87-image-1.png" alt="87-image-1" width="548" height="213" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">So, if you have an Amazon machine image (AMI) with these libraries installed, you do not require an internet gateway or the route.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since I connected to the ElastiCache cluster from an Amazon EC2 instance, the instance required specific permissions. In my previous note, I created two IAM policies. One had permission to access the ElastiCache endpoint stored in the SSM parameter store, and the other policy had permission to access the ElastiCache auth-token stored in the AWS Secrets Manager secret. I attached both policies to an IAM role that was then attached to the Amazon EC2 instance. Since I was required to access the Amazon EC2 instance via Session Manager, I also attached an AWS-managed policy to the IAM role.</span></span></span>
<img class="alignnone size-full wp-image-3256" src="https://skundunotes.com/wp-content/uploads/2023/12/87-image-2.png" alt="87-image-2" width="840" height="467" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last AWS cloud resources are the two Amazon EC2 instances. My idea was to create two Amazon EC2 instances, one to <span style="text-decoration: underline">write into the ElastiCache cluster</span> and the other to <span style="text-decoration: underline">read from the ElastiCache cluster</span>. Using the user data script, I created a Python file and stored it in the <code><span style="font-size: 15px"><span style="color: #0047ab">var</span></span></code> folder of the two Amazon EC2 instances. Hence, both the Amazon EC2 instances use separate user data scripts. I also passed the ElastiCache endpoint address, port number, and AWS Secrets manager secret name to the Python file. Below is an image of one of the Amazon EC2 instances' Terraform code.</span></span></span>
<img class="alignnone size-full wp-image-3257" src="https://skundunotes.com/wp-content/uploads/2023/12/87-image-3.png" alt="87-image-3" width="642" height="350" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These are all the additional AWS cloud resources required for this use case. I checked-in my code and merged it with the <code><span style="font-size: 15px"><span style="color: #0047ab">main</span></span></code> branch. That triggered the GitHub Actions pipeline and provisioned all the AWS cloud resources.
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After all the cloud resources were provisioned, I waited an additional 5 minutes since the Amazon EC2 instances had the user data script to run and install a few packages and create the Python file.</span></span></span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Log into an Amazon EC2 instance and write into the ElastiCache cluster using Python</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I selected the Amazon EC2 instance named <code><span style="font-size: 15px"><span style="color: #0047ab">app-4-server-write</span></span></code> and clicked on the Connect button to connect via Session Manager. I could log into the Amazon EC2 instance since I had the correct AWS-managed policy and appropriate security group rule attached to the Amazon EC2 instance. You can read more about that at <a href="https://skundunotes.com/2023/08/27/provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform/" target="_blank" rel="noopener">-provision-an-amazon-ec2-instance-with-session-manager-access-using-terraform.</a></span></span></span></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><img class="alignnone size-full wp-image-3258" src="https://skundunotes.com/wp-content/uploads/2023/12/87-image-4.png" alt="87-image-4" width="1059" height="286" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After logging in, I navigated to the <code><span style="font-size: 15px"><span style="color: #0047ab">/var</span></span></code> folder and ran the <code><span style="font-size: 15px"><span style="color: #0047ab">ls</span></span></code> command. I could see the user data generated <code><span style="font-size: 15px"><span style="color: #0047ab">write_cache.py</span></span></code> file.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I ran <code><span style="font-size: 15px"><span style="color: #0047ab">python3 write_cache.py</span></span></code>, which prompted me to enter a City name.</span></span></span></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><img class="alignnone size-full wp-image-3259" src="https://skundunotes.com/wp-content/uploads/2023/12/87-image-5.png" alt="87-image-5" width="974" height="182" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last message confirmed that the information was successfully stored in the ElastiCache cluster.</span></span></span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Log into another Amazon EC2 instance and read from the ElastiCache cluster using Python</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I repeated the same steps on the other Amazon EC2 instances - <code><span style="font-size: 15px"><span style="color: #0047ab">app-4-server-read</span></span></code> and logged in via Session Manager. Then, I navigated to the <code><span style="font-size: 15px"><span style="color: #0047ab">/var</span></span></code> folder and ran the Python file <code><span style="font-size: 15px"><span style="color: #0047ab">python3 read_cache.py</span></span></code>. And the correct value was printed. As part of the execution, the Python script connected to the ElastiCache cluster and read the value the other Python script wrote.</span></span></span></span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><img class="alignnone size-full wp-image-3260" src="https://skundunotes.com/wp-content/uploads/2023/12/87-image-6.png" alt="87-image-6" width="970" height="220" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can iterate through Steps 2 and 3 multiple times with different values.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. I recommend you <code><span style="font-size: 15px"><span style="color: #0047ab">cat</span></span></code> open the two Python files to review their contents. You will see that the files do not contain any sensitive values, such as the ElastiCache endpoint or the auth_token. Access to those is managed via the IAM role attached to the Amazon EC2 instance.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you found this note helpful. Let me know if you have any questions or suggestions.</span></span></span></span></span></span>
