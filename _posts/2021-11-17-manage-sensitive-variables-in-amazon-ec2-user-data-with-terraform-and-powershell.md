---
title: "Manage sensitive variables in Amazon EC2 user data with Terraform and PowerShell"
date: 2021-11-17 16:25:00 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you have worked with Amazon EC2 user data, you'd have noticed a shortcoming in the approach  -<em>the inability to pass command-line arguments to the user data script at run time.</em></span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Let me explain why I believe that to be a problem. <strong>User data is a capability associated with an Amazon EC2 instance as part of the provisioning process.</strong> Due to its nature, user data is an ideal candidate to carry the load of server provisioning steps like:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Installing 3rd party software.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Configuring permissions and access.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Installing and configuring windows features.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Installing endpoint agents, etc.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A few of these steps involve sharing secure credentials as part of authentication. Due to its inability to work with command-line arguments, the user data script requires that these credentials be provided inside the script. <span style="text-decoration: underline">That means anyone who has access to the user data script in the Amazon EC2 instance also has access to the credentials.</span></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That is not desirable, and there is a way around the problem <strong> -AWS System Manager parameter store.</strong></span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per AWS-Docs, -Parameter Store (is) a capability of AWS Systems Manager (that) provides secure, hierarchical storage for configuration data management and secrets management. More information is available at <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" target="_blank" rel="noopener">AWS Systems Manager Parameter Store</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Hence, my thought process was to <span style="text-decoration: underline">(i) store the sensitive credentials in the ssm-parameter store, (ii) associate an IAM role to the Amazon EC2 instance that had permission to read from the parameter store, (iii) pass the parameter store variable name to the Amazon EC2 user data script to decrypt and (iv) add the capability in the user data script to read from the parameter store.</span> That way, the sensitive credential could be passed to the user data script in the form of a variable without storing the variable's value in plain text for anyone to access. Using Terraform, this approach involved four steps that I listed below. If you are interested, I have the code in my GitHub repo: <span style="text-decoration: underline"><a class="Link--primary break-line-anywhere" title="add-ssm-parameter" href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-ssm-parameter" target="_blank" rel="nofollow noopener">add-ssm-parameter</a></span></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an ssm parameter store object for the sensitive value</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created an "AWS Systems Manager parameter store" object named <code>/dev/SecureVariableOne</code> and stored the sensitive value specified in <code>var.SecureVariableOne</code> using Terraform. I then provided the value of this variable to Terraform using the <code> -var SecureVariableOne=ThisIsASecureValue</code> flag in the <code>terraform plan</code> step.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: You should not store the value of <code>SecureVariableOne</code> in source control, and hence the value must be passed at run time or made available via some other secure process.</span></span></span>
<img class="alignnone size-full wp-image-1606" src="https://skundunotes.com/wp-content/uploads/2021/11/56.image-2.png" alt="56.Image-2" width="714" height="116" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the AWS console, I confirmed that a resource was created with the above specifications.</span></span></span>
<img class="alignnone size-full wp-image-1607" src="https://skundunotes.com/wp-content/uploads/2021/11/56.image-3.png" alt="56.Image-3" width="655" height="503" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create an IAM role and associate the Amazon EC2 instance with appropriate permissions.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This step is quite exhaustive, and hence I created a separate note to describe that in detail. You may read about that at  -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/16/attach-iam-role-to-aws-ec2-instance-using-terraform/" target="_blank" rel="noopener">attach IAM role to an Amazon EC2 instance using Terraform</a></span>. As an overview, the concept was  -assign a set of permissions to an Amazon EC2 instance to carry out a specific set of activities. Hence I created an IAM policy file with a set of permissions/rules and assigned it to an IAM role, which was then associated with an IAM instance profile that was then assumed by an Amazon EC2 instance. The Amazon EC2 instance was then able to perform a set of actions listed in the IAM policy file.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The IAM policy file had the below rule that allowed any entity (user or role) attached with it to <code>GetParameter</code> on the parameter store specified in Resource, which was the same AWS SSM parameter store as specified in Step 1.</span></span></span>
<img class="alignnone size-full wp-image-1608" src="https://skundunotes.com/wp-content/uploads/2021/11/56.image-4.png" alt="56.Image-4" width="558" height="159" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: If you are wondering the difference between <code>ssm:GetParameter</code> and <code>ssm:GetParameters</code> please check this <strong>StackOverflow question <a href="https://stackoverflow.com/questions/61751373/getparameter-vs-getparameters" target="_blank" rel="noopener">getparameter-vs-getparameters</a>.</strong></span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Pass the parameter store variable name to the Amazon EC2 user data script to decrypt</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I provided the name of the variable <code>aws_ssm_parameter.parameter_one.name</code> in the <code>user_data</code> block under <code>aws_instance</code>. That variable is referred to as <code>$SecureVariable</code> in the user data script. I have highlighted that in the below code block.</span></span></span>
<img class="alignnone size-full wp-image-3222" src="https://skundunotes.com/wp-content/uploads/2021/11/56-image-5.png" alt="56-Image-5" width="596" height="343" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Update user data script to read the value from the parameter store</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I added the function call to the <code>ssm-parameter</code> store variable via the <code>get-ssmparameter</code> function in the user data script, as shown in the below block.</span></span></span>
<img class="alignnone size-full wp-image-1610" src="https://skundunotes.com/wp-content/uploads/2021/11/56.image-6.png" alt="56.Image-6" width="894" height="137" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After applying these four steps, I triggered the <code>terraform plan</code> and <code>terraform apply</code> step. As noted earlier (under Step 1), I passed the value of the secure variable at run time via the command line. After the <code>terraform apply</code> command, I logged into the Amazon EC2 instance and verified that the user data script was successful. Here is an image of the log file that the user data script created. As you can see, the logic correctly decrypted the value of the <code>ssm-parameter</code> store via the user data script.</span></span></span>
<img class="alignnone size-full wp-image-1611" src="https://skundunotes.com/wp-content/uploads/2021/11/56.image-7.png" alt="56.Image-7" width="673" height="394" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Moreover, the value of the <code>ssm-parameter</code> store is not stored anywhere in plain text on the Amazon EC2 instance.</span></span></span>

<em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> I logged the value of the secure variable in the log file as an example to show the correct application of the use case. Ideally, secure variables should not be logged or stored in plain text.</span></span></span></em>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Also, note that although the value of the secure variable is not stored anywhere on the Amazon EC2, anybody who can log into the instance can run the <code>get-ssmparameter</code> function and decrypt the secure string. There are a few approaches to addressing that gap.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. If you have any questions or suggestions, please do not hesitate to ask. If you are new to Amazon EC2 user data, I have another note that you might find useful  -<span style="text-decoration: underline"><a href="https://skundunotes.com/2021/11/07/working-with-aws-ec2-user-data-and-terraform/" target="_blank" rel="noopener">working with Amazon EC2 user data and Terraform.</a></span></span></span></span>
