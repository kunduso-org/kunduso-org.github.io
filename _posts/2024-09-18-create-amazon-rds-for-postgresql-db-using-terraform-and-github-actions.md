---
title: "Create Amazon RDS for PostgreSQL DB using Terraform and GitHub Actions"
date: 2024-09-18 11:46:49 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, I discuss creating an Amazon RDS for PostgreSQL DB using Terraform and securely automating the provisioning process using GitHub Actions. By the end of this note, you will learn about the underlying architectural dependencies and specific properties needed to create a secure RDS for PostgreSQL DB using Terraform.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Per <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Welcome.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>, <span style="text-decoration: underline">Amazon Relational Database Service (Amazon RDS)</span> is a web service that makes it easier to set up, operate, and scale a relational database in the AWS Cloud. It provides cost-efficient, resizable capacity for an industry-standard relational database and manages common database administration tasks. Amazon RDS supports several database engines, such as IBM Db2, MariaDB, Microsoft SQL Server, MySQL, Oracle Database, and PostgreSQL. In this note, I will focus on <strong>PostgreSQL</strong>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><span style="text-decoration: underline">Terraform</span> is a popular infrastructure-as-code(IaC) tool that enables developers and cloud engineering teams to write code in HashiCorp Configuration Language (HCL) to provision cloud infrastructure. An IaC tool allows for consistent and repeatable infrastructure deployment, reduces the risk of human error, and enhances collaboration by enabling version control and automation of infrastructure changes.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Furthermore, <span style="text-decoration: underline">GitHub Actions</span> automates the provisioning of AWS cloud resources using Terraform. GitHub Actions is a powerful automation platform that allows developers to define workflows for continuous integration and continuous deployment (CI/CD) within their GitHub repositories. It facilitates the automation of various tasks, including deploying and managing cloud infrastructure, by running predefined scripts and actions in response to code changes or other triggers.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Over the next several minutes, I'll explore all the Terraform code for the AWS cloud resources required to provision an <strong>Amazon RDS for PostgreSQL</strong>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are a few <span style="text-decoration: underline">prerequisites</span> before creating an Amazon RDS for PostgreSQL DB. These are:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>1.</strong> Create an Amazon VPC and Subnets to host the RDS DB instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>2.</strong> Create an AWS KMS key and policy to encrypt the cloud resources</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>3.</strong> Create a Security Group to control access to the Amazon RDS DB instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>4.</strong> Create an IAM role for enhanced monitoring of the Amazon RDS DB instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>5.</strong> Create a subnet group and parameter group for the Amazon RDS DB instance</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After all these resources are provisioned, the last step is <strong>6.</strong> Create an Amazon RDS for PostgreSQL DB instance.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you want to follow along, here is a link to my GitHub repository to access the Terraform code <a href="https://github.com/kunduso/rds-secretsmanager-rotation-lambda-terraform/tree/add-rds-db-instance" target="_blank" rel="noopener"><code style="background-color: #dcdcdc;font-size: 15px;color: #000000">GitHub: kunduso/rds-secretsmanager-rotation-lambda-terraform</code></a>. </span></span></span><em><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #ff0000">Please note that the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">branch name = add-rds-db-instance</code>.</span></span></span></em>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create the network stack (VPC and Subnets)</span></span></span></strong>
<img class="alignnone size-full wp-image-4737" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-1.png" alt="101-image-1" width="536" height="506" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon Virtual Private Cloud (VPC) hosts the Amazon RDS DB instance. By launching the Amazon RDS instance inside a VPC, the cloud engineering team can manage secure access to the instance. This use case did not require a large CIDR, so I allocated one with a <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">/26</code> range (64 IPs, much more than my requirement). I also created two subnets inside the VPC and a route for the local traffic (inside the VPC). I did not attach any NAT or Internet Gateway to the VPC.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create an AWS KMS key and policy</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The AWS KMS key encrypts the data stored in the Database and the password to access it. Encrypting the data ensures that only those with the key can access it.</span></span></span>
<img class="alignnone size-full wp-image-4738" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-2.png" alt="101-image-2" width="577" height="454" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I also followed security best practices by creating a specific KMS Key policy that provides particular service principals access to these specific actions over the KMS key. I expanded one of the KMS key policy statements for your examination.</span></span></span>
<img class="alignnone size-full wp-image-4739" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-3.png" alt="101-image-3" width="593" height="437" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The complete code is in the GitHub repository.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Create a Security Group to control access</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The Amazon RDS DB instance is configured to listen on <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">port# 5432</code>, so I enabled the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">ingress rule</code> on that port in the security group below. This security group is then attached to the Amazon RDS DB instance, which allows communication.</span></span></span>
<img class="alignnone size-full wp-image-4740" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-4.png" alt="101-image-4" width="469" height="523" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Create an IAM role and attach a managed policy for enhanced monitoring</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are new to <span style="text-decoration: underline">Enhanced monitoring</span> in Amazon RDS, please refer to this detailed document on <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Monitoring.OS.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">AWS-Docs</span></span></span></a>. This service can help cloud engineers determine the <span style="text-decoration: underline">proper sizing</span> of their Amazon RDS DB instance to manage <span style="text-decoration: underline">application availability and control cost</span>. Enhanced monitoring is managed by two properties: (i) setting the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">monitoring_interval</code> property in the Amazon RDS resource and (ii) creating and attaching an IAM role to send the Amazon RDS instance OS metrics to Amazon CloudWatch. This step is to create the IAM role and attach a managed IAM policy that has permission to send logs to Amazon CloudWatch.</span></span></span>
<img class="alignnone size-full wp-image-4741" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-5.png" alt="101-image-5" width="645" height="388" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 5: Create a DB subnet group and a parameter group for the Amazon RDS DB instance</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">A DB subnet group is a list of subnets inside a VPC that can host the Amazon RDS DB instance. Since I required a multi-AZ deployment of the Amazon RDS DB instance, these subnets had to be in two separate availability zones. Here is a <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_VPC.WorkingWithRDSInstanceinaVPC.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">link</span></span></span></a> to Amazon Docs for a detailed explanation.</span></span></span>
<img class="alignnone size-full wp-image-4742" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-6.png" alt="101-image-6" width="464" height="104" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">An Amazon RDS parameter group is a container for engine configuration values for Amazon RDS instances. By modifying a parameter group across multiple instances, cloud engineers can easily customize database parameters, such as memory allocation and query performance.</span></span></span>
<img class="alignnone size-full wp-image-4743" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-7.png" alt="101-image-7" width="562" height="325" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Amazon RDS provides default parameter groups, but creating a separate one for the project's unique requirements is better.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 6: Create an Amazon RDS for PostgreSQL</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The last step is to create the Amazon RDS DB instance. As you can examine from the image below, this is the AWS cloud resource where we specify the RDS DB properties such as <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">allocated_storage</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">storage_type</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">engine</code>, and <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">engine_version</code>. We also specify references to previously created resources, such as the subnet group name, the security group, the parameter group, and the KMS key. You will also notice that we followed security best practices and enabled <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">multi_az</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">storage_encrypted</code>, <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">iam_database_authentication_enabled</code>, and <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">deletion_protection</code>. I also learned that as of <a href="https://aws.amazon.com/about-aws/whats-new/2022/12/amazon-rds-integration-aws-secrets-manager/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">December 2022</span></span></span></a>, Amazon RDS manages the password (creation and rotation), which frees up the cloud engineering team from managing that. You can read more about that at <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/rds-secrets-manager.html" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">amazon-rds-secrets-manager</span></span></span></a>.</span></span></span>
<img class="alignnone size-full wp-image-4744" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-8.png" alt="101-image-8" width="622" height="596" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For a full list of all the properties, please refer to the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">Terraform AWS Provider resource page</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That is all the Terraform code required to create the Amazon RDS for PostgreSQL. However, since Amazon RDS created the master user password (configured via the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">manage_master_user_password</code> property in the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_db_instance</code> resource), storing the reference to programmatically access it later is a valuable practice. These are not necessary to create the Amazon RDS for PostgreSQL instance but are required to use it.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Best practice 1: Store the Amazon RDS for PostgreSQL information as an AWS Systems Manager Parameter parameter.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Any application using the Amazon RDS DB will access it on the endpoint. Hence, the application would require that. Although you can embed values in the application, an alternate approach is to store these as encrypted values in the Systems Manager Parameter Store as parameters and provide permissions to the application to fetch and decrypt them from there. That way, hardcoding the values is not required, and the application stays clear of confidential data.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created two resources: an <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_ssm_parameter</code> to store the RDS endpoint, the <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">port#</code>, and the ARN of the AWS Secrets Manager secret and an <code style="background-color: #dcdcdc;font-size: 15px;color: #000000">aws_iam_policy</code> to enable access to the Systems Manager Parameter Store parameter.</span></span></span>
<img class="alignnone size-full wp-image-4745" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-9.png" alt="101-image-9" width="918" height="291" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Best practice 2: Create an IAM policy to access the Amazon RDS for PostgreSQL information from the Systems Manager Parameter Store.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After storing the Amazon RDS information as a Systems Manager parameter, I created an IAM policy that allows access to that. An application would require the same IAM policy to be attached to the role it assumes to communicate with the Systems Manager parameter. After attaching the IAM policy, the application can communicate with the Systems Manager parameter and get the values of the Amazon RDS for PostgreSQL endpoint, port#, and the AWS Secrets Manager ARN.</span></span></span>
<img class="alignnone size-full wp-image-4746" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-10.png" alt="101-image-10" width="993" height="698" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Since these are confidential values, encrypting and decrypting them using a KMS Key, as mentioned above, is a good practice.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I also automated the provisioning of the AWS resources using GitHub Actions. If you want to learn how I managed the authentication process, head over to this note –<a href="https://skundunotes.com/2023/02/28/securely-integrate-aws-credentials-with-github-actions-using-openid-connect/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">securely-integrate-aws-credentials-with-github-actions-using-openid-connect</span></span></span></a>. I also scanned my code for vulnerabilities using Bridgecrew Checkov, which generated a scan report. Here is a note on how to <a href="https://skundunotes.com/2023/04/12/automate-terraform-configuration-scan-with-checkov-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">enable Checkov with GitHub Actions</span></span></span></a>. I'm also interested in the cost of these resources and use Infracost for that, which I have covered in detail in this note –<a href="https://skundunotes.com/2023/07/17/estimate-aws-cloud-resource-cost-with-infracost-terraform-and-github-actions/" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">estimate AWS resource cost</span></span></span></a>. The vulnerabilities and cost estimate are available in the <a href="https://github.com/kunduso/rds-secretsmanager-rotation-lambda-terraform/pull/20#issuecomment-2358219761" target="_blank" rel="noopener"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #0000ff">pull request as comments</span></span></span></a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once I added all the Terraform code for the resources and their configurations, I pushed the changes to my remote repository. The GitHub Actions workflow concluded with the command terraform apply, which enabled and provisioned the resources. This took 15-17 minutes to provision.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Then, on the AWS Management Console, I navigated to RDS → Databases and selected the Database I created in this GitHub repository. The image below is part of the Amazon RDS DB instance.</span></span></span>
<img class="alignnone size-full wp-image-4747" src="https://skundunotes.com/wp-content/uploads/2024/09/101-image-11.png" alt="101-image-11" width="719" height="282" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That brings us to the end of this note. Since you have access to the GitHub code repository, fork it and try to provision the AWS cloud resources. Let me know if you have any questions or suggestions.</span></span></span>
