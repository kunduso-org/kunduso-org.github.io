---
title: "Static analysis with Checkov, Terraform, and Azure Pipelines"
date: 2021-08-28 11:58:39 +0000
categories: []
tags: []
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As the name suggests, Static analysis is the ability to scan software code to search and highlight deviations from specified standards. The purpose of static code analysis is to speed up the feedback process of developing software or infrastructure.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In general, once code is merged/committed to a repository, failures/defects/bugs are identified during the following stages: code build, unit testing, build deployment, functional testing, or after product release. The cost of fixing a defect increases as the code moves further away (towards the right) from the code repository to the production environment. Hence, it makes financial sense to identify defects and fix them as early as possible. <strong>It is possible to reduce and maybe prevent buggy code from being merged using a pull-request-based workflow.</strong> That is achieved by associating a pull-request policy with a code build and unit testing check to ensure that the incoming changes do not (a) break the build and (b) cause unit tests to fail. Static analysis is a practical approach to identifying such code and should be added to the pull request policy. A static analysis tool searches for anomalies in code and determines the level of deviation to highlight depending upon the static-analysis policies selected. The objective is to search for patterns that can turn into defects later and address them as early as possible.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">While researching on this topic, I came across an informative starting point at <span style="text-decoration: underline"><a href="https://docs.microsoft.com/en-us/azure/developer/terraform/best-practices-integration-testing" target="_blank" rel="noopener">Microsoft-docs</a></span>. I read up about the four tools mentioned there and decided to proceed with Checkov. <strong>Per Bridgecrew, Checkov is a static code analysis tool for scanning infrastructure as code (IaC) files for misconfigurations that may lead to security or compliance problems. Checkov includes more than 750 predefined policies to check for common misconfiguration issues.</strong> That was an excellent starting point. On further exploration, I found helpful blogs and Youtube videos on the topic. Before I delve deeper, I want to thank <span style="text-decoration: underline"><a href="https://twitter.com/Ned1313" target="_blank" rel="noopener">Ned Bellavance</a></span> and <span style="text-decoration: underline"><a href="https://twitter.com/AdinErmie" target="_blank" rel="noopener">Adin Ermie</a></span> for showing me how to integrate these tools.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I have a GitHub code repository where I deployed an Amazon VPC and a few other networking infrastructure components using Terraform and Azure Pipelines  -<span style="text-decoration: underline"><a href="https://github.com/kunduso/Working-with-Terraform-workspace-and-AWS" target="_blank" rel="noopener">Working-with-Terraform-workspace-and-AWS</a></span>. My objective in this note was to integrate Checkov into the toolchain.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the project, I used <code>azure-pipelines.yaml</code> to break the infrastructure deployment into multiple stages. These are <code>stage: validate</code> where I ran <code>terraform validate</code> against all the workspaces to check for code correctness, followed by <code>stage: Dev</code>, <code>Test</code>, and <code>Prod</code>, where I deployed the infrastructure changes. Per the <span style="text-decoration: underline"><a href="https://www.checkov.io/4.Integrations/Terraform%20Scanning.html" target="_blank" rel="noopener">documentation</a></span>, Checkov can be used to scan the <code>.tf source files</code> and the <code>terraform plan file</code> to identify anomalies and highlight them. Hence, I planned to run a scan against the terraform source code in the <code>validate</code> stage and scan the plan file in each <code>Dev</code>, <code>Test</code>, and <code>Prod</code> stage since the <code>plan files</code> are separate for these three environments.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">With that objective at hand and a little bit of research, I identified three steps to add to <code>azure-pipelines.yaml</code> that had to be followed for each of these four stages.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Install Checkov.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used a bash task to install Checkov following the installation guide at <a href="https://www.checkov.io/1.Welcome/Quick%20Start.html" target="_blank" rel="noopener">Checkov-quick-start</a>.</span></span></span>
<img class="alignnone size-full wp-image-1447" src="https://skundunotes.com/wp-content/uploads/2021/08/49.image-2.png" alt="49.Image-2" width="365" height="102" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Scan terraform configuration files.</span></span></span>
</strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I used a bash task to run the scan command where the output was formatted in JUnit. The command is self-explanatory. I selected the source folder with terraform configuration files to be the <code>working directory</code>. And ran the <code>checkov -d .</code> command to run that on the current directory. The output would be available on the build logs if I did not provide the <code> -o junitxml</code> flag. By routing the output to an XML file, I published them in the next step.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> I added a <code>continueOnError: true</code> so that, if the build failed (due to code scan identifying vulnerabilities), I could get the next step (publish report) to run and review the code scan failures.</span></span></span>
<img class="alignnone size-full wp-image-1448" src="https://skundunotes.com/wp-content/uploads/2021/08/49.image-3.png" alt="49.Image-3" width="501" height="140" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Publish the result.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Finally, I published the scan result in the last step, which Checkov produced via the familiar <code>PublishTestResults</code> task.</span></span></span>
<img class="alignnone size-full wp-image-1449" src="https://skundunotes.com/wp-content/uploads/2021/08/49.image-4.png" alt="49.Image-4" width="489" height="193" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I applied these three steps to the <code>validate</code> stage.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, as mentioned in the docs, Checkov can scan the Terraform plan file, too, and I followed a tweaked version of the above three steps for all the three stages, <code>Dev</code>, <code>Test</code>, and <code>Prod</code>. I wrote "tweaked version" since I scanned the plan file, not the terraform configuration files. The below three steps provide a little more detail.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Install Checkov.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This step is identical to the previous one, where I installed Checkov on the local build agent.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Scan plan file.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">For the following three stages(<code>Dev</code>, <code>Test</code>, and <code>Prod</code>), I scanned the plan file using the command shown below. This task is started after Terraform created a <code>tfplan file</code>.</span></span></span>
<img class="alignnone size-full wp-image-1450" src="https://skundunotes.com/wp-content/uploads/2021/08/49.image-5.png" alt="49.Image-5" width="620" height="171" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This is a two-step process where the <code>tfplan file</code> is converted to JSON, and then a Checkov scan is run on that to produce an XML file in JUnit format. Here is a little more information on <a href="https://www.terraform.io/docs/cli/commands/show.html" target="_blank" rel="noopener">terraform show</a> and an example from <a href="https://www.checkov.io/4.Integrations/Terraform%20Scanning.html" target="_blank" rel="noopener">checkov-terraform-scanning</a>. </span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Publish scan report.</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This step was identical to step 3 of the <code>validate</code> stage, where the scan report was published to be available for review.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">These reports were available on the build page next to the Summary tab, titled Tests.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is an image of the scan result.</span></span></span>
<img class="alignnone size-full wp-image-1451" src="https://skundunotes.com/wp-content/uploads/2021/08/49.image-6.png" alt="49.Image-6" width="1050" height="282" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Based on the report's title, I drilled down and identified the vulnerabilities in my code.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I titled the code scan report as <code>testRuntitle: Terraform source code scan</code> in the <code>PublishTestResults</code> task and was able to view the information as shown below.</span></span></span>
<img class="alignnone size-full wp-image-1452" src="https://skundunotes.com/wp-content/uploads/2021/08/49.image-7.png" alt="49.Image-7" width="740" height="160" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I followed a similar approach for the plan file scan in <code>Stage: Dev</code> and <code>Test</code> and <code>Prod</code>. If you are interested in knowing more, I have a link to the azure-pipelines build log. Click on the <span style="text-decoration: underline"><a href="https://littlecoding.visualstudio.com/Open-Project/_build/results?buildId=211&amp;view=ms.vss-test-web.build-test-results-tab" target="_blank" rel="noopener">Test tab to review the vulnerabilities</a></span>. The link to my GitHub repository is <span style="text-decoration: underline"><a href="https://github.com/kunduso/Working-with-Terraform-workspace-and-AWS" target="_blank" rel="noopener">Working-with-Terraform-workspace-and-AWS</a></span>. </span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Overall, I found it reasonably easy to integrate Checkov into <code>azure-pipelines.yaml</code> to scan the Terraform configuration and plan files. The Checkov error log notifies which resource configuration has a security vulnerability (<em>points to the line number in the terraform source file</em>) and how to remediate it. E.g., the <code>CKV_AWS_130/Ensure VPC subnets do not assign public IP by default</code> provides a <span style="text-decoration: underline"><a href="https://docs.bridgecrew.io/docs/ensure-vpc-subnets-do-not-assign-public-ip-by-default" target="_blank" rel="noopener">link to the guideline</a></span> where Checkov provides a fix to the vulnerability. In this case, it is to set the <code>map_public_ip_on_launch</code> to <code>false</code>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There are multiple options from here on. I could either decide to review and fix the errors identified in the scan or introduce Checkov policy suppression blocks in the terraform code to suppress these errors. Here is an example of how to <span style="text-decoration: underline"><a href="https://www.checkov.io/2.Basics/Suppressing%20and%20Skipping%20Policies.html" target="_blank" rel="noopener">suppress policies</a></span>.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Either way, it is an excellent mechanism to identify vulnerabilities in the Terraform configuration files. If you are interested, please give Checkov a try and share your findings. As I have shown, it is pretty easy to integrate that with the existing <code>azure-pipelines.yaml</code> file to build the Terraform configuration files. If I can be of help, please don't hesitate to reach out.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Note: I learned this concept from <a href="https://www.youtube.com/watch?v=7wbhs7PFdoA" target="_blank" rel="noopener">Ned's video</a> and <a href="https://adinermie.com/publishing-checkov-terraform-quality-checks-to-azure-devops-pipelines/" target="_blank" rel="noopener">Adin's blog</a>.</span></span></span>

<!-- /wp:paragraph -->
