---
title: "Working with Amazon EC2 user data and Terraform"
date: 2021-11-08 03:23:43 +0000
categories: []
tags: []
---

<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">User data is a feature that allows customization of Amazon Elastic Compute Cloud (virtual machine) when it is created and (if desired) with each restart after being provisioned.</span></span></span><br /><!--more--><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As we all know, Amazon EC2 instance (virtual machine) is the legacy approach to hosting applications. Last year, I attended a webinar sponsored by AWS where the presenter, Mike Pfeiffer, talked about the <strong>four strategies for migrating from on-premises to the cloud.</strong> They were <span style="text-decoration: underline">(i) lift and shift, (ii) modernization (or refactoring application), (iii) re-architect to benefit from the flexibility of the cloud, and finally, (iii) rebuilding from scratch to go cloud-native.</span></span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Note:</strong> If you are interested, here is the link to the webinar: <span style="text-decoration: underline"><a href="https://pages.awscloud.com/AWSMP-SS-OPS-NetApp-Migration-ty.html" target="_blank" rel="noopener">AWS migration services</a></span>.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As the name suggests, <strong>lift-and-shift</strong> is a direct move of the virtual servers and workload from on-premises to the cloud and, hence, is the fastest way to migrate to the cloud. It is, however, the <span style="text-decoration: underline">most expensive</span> way of hosting an application in the cloud among the four strategies listed above. Every organization realizes that and <strong>gradually shifts towards efficient cloud-native products</strong> (starting from infrastructure-as-a-service and moving to platform-as-a-service). An <strong>infrastructure-as-code approach</strong> to provision Amazon EC2 supports the cloud-native strategy, compared to lift-and-shift, but the cost of hosting remains high.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">However, Amazon Web Services has provided an exciting feature to assist in <em>a quicker turnaround time.</em> Just because an application is hosted on a virtual machine does not mean that installing software, enabling features, and converting it to a functional component of an environment has to happen manually and, in the process, take longer. Over the last few years, I have learned of a few tools like Terraform that would help manage a cloud resource (like Amazon EC2) with a few lines of HCL code. But what after that? Merely provisioning a virtual machine is not enough. The provisioned virtual machine won't be usable without installing specific software and/or enabling certain features (I'm talking about Windows OS here).</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">That is when UserData comes into the picture. I found this AWS-Docs page very informative as I learned about UserData and would highly recommend going through it - <span style="text-decoration: underline"><a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-windows-user-data.html#user-data-scripts" target="_blank" rel="noopener">ec2-windows-user-data.</a></span></span></span></span></p>
<p><strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">User data is the answer to automating all the manual steps applied once an Amazon EC2 is provisioned to host an application.</span></span></span></strong></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Learning by practice works best for me, and hence, <span style="text-decoration: underline">I created a use case to provision an Amazon EC2 instance and ran user data as part of the provisioning process.</span> I used Terraform to achieve this objective. As part of provisioning a Windows Amazon EC2 instance, I had the following steps planned:</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create a folder to store the user data log file.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Rename the machine, which is followed by a restart.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Install a Windows feature after the restart.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Previously, I had worked on provisioning an Amazon EC2 instance, so in this note, I built on the work done there. I stored the code at my GitHub repository: <span style="text-decoration: underline"><a href="https://github.com/kunduso/ec2-userdata-terraform/tree/add-userdata" target="_blank" rel="noopener">ec2-userdata-terraform.</a></span></span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 1:</strong> Add <code>user_data</code> block to <code>aws_instance</code> terraform block</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The path to the user data script, along with any input variables, is passed to the <code>user_data</code> block in the Terraform configuration file.</span></span></span><br /><img class="alignnone size-full wp-image-1565" src="https://skundunotes.com/wp-content/uploads/2021/11/54.image-2.png" alt="54.Image-2" width="429" height="80" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see in the above code snippet, I passed the name of the server as input to the user data script, and inside the user data script, I read it using <code>$ServerName = "${ServerName}"</code> assignment.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This approach can pass multiple such variables to the user data script.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 2:</strong> Add the user data template file with detailed instructions.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I chose Powershell as my preferred user data script. The file is stored at <code>user_data\user_data.tpl</code></span></span></span><br /><span style="text-decoration: underline"><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000;text-decoration: underline">I made two important considerations while coming up with a user data based approach, which was: (i) whether the script was run multiple times with each machine restart or just once when Terraform provisioned the machine, and (ii) the status of the user data script execution.</span></span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">There is no right or wrong answer on whether the user data script needs to run once or more than once. It depends on the use case. There was a requirement to run it multiple times for this particular use case since I had inserted a machine restart. In such a case, it was necessary to make the user data script<strong> idempotent -run as many times as you want; the end state is always the same.</strong> If the user data is required to run with each restart, it must be idempotent. If you are new to this concept, I have a short article at <span style="text-decoration: underline"><a href="https://skundunotes.com/2019/04/19/idempotency-in-infrastructure-as-code/" target="_blank" rel="noopener">idempotency-in-infrastructure-as-code.</a></span> [</span></span></span><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><em>TLDR: you check for the desired state and apply only if the state does not match.]</em></span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The second important consideration was whether the user data script ran.Â When I started using user data, that was the #1 question in my mind. Also, <em>to what point did the script run?</em> Instead of checking the desired states manually, like if the folder has been created, the machine renamed, or the Windows update has been installed, I could make intelligent comments in the user data script and log them somewhere.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I addressed both of these concerns with the <code>userdata.tpl</code> file.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 3:</strong> Run a <code>terraform plan</code> and <code>terraform apply</code></span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Remember that even though <code>terraform apply</code> ran just fine without any errors, <code>terraform</code> does not know anything about the status of user data [-did it run at all? Did it run successfully till the end?]. Terraform was instructed to provision an Amazon EC2 correctly and hand over the control to the user data that is run inside the Amazon EC2 instance. So do not be mad at yourself if you logged into the Amazon EC2 instance and found that user data did not work.</span></span></span></p>
<p><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000"><strong>Step 4:</strong> Verify user data</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Although the verification does not need to be done manually when the process is well established, when I was setting up the process, one of my first questions <em>(as I mentioned earlier)</em> wasÂ  -Did user data run without any errors?</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Hence, the first task was finding the log file the user data created. That is why I made the user data script to easily access and review the log file to check the status.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I created a folder to store the log file in the user data in this use case.</span></span></span><br /><img class="alignnone size-full wp-image-1566" src="https://skundunotes.com/wp-content/uploads/2021/11/54.image-3.png" alt="54.Image-3" width="458" height="157" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Remember that this step, too, has to be idempotent, and hence the <code>if() block</code>.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Sometimes, it is also necessary to know where the user data file (in my case, Powershell file) is stored so that I can check the form in which AWS transferred it to the Amazon EC2 instance while debugging. So, I identified that and wrote that path out in the log file with the below logic:</span></span></span><br /><img class="alignnone size-full wp-image-1567" src="https://skundunotes.com/wp-content/uploads/2021/11/54.image-4.png" alt="54.Image-4" width="540" height="48" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The log file for the user data execution is stored below. This information is available in the AWS Docs link I shared above.</span></span></span><br /><img class="alignnone size-full wp-image-1568" src="https://skundunotes.com/wp-content/uploads/2021/11/54.image-5.png" alt="54.Image-5" width="624" height="169" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Here is an image of the log file created with each user data runÂ  -after machine provisioning and after each machine restarts. <strong><em>The user data execution log file and the Powershell script are stored at different locations.</em></strong></span></span></span><br /><img class="alignnone size-full wp-image-1569" src="https://skundunotes.com/wp-content/uploads/2021/11/54.image-6.png" alt="54.Image-6" width="979" height="338" /><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">And that brings us to the end of this note. I hope you found this note helpful. I would be happy to answer any questions that you may have. Would you please share them in the comments section? Also, please do not hesitate to correct me if I have misstated anything.</span></span></span><br /><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">It wouldn't have been possible to gain so much information about user data without the help of my colleague Steve Torrey, who showed me how to work with user data and patiently answered all my questions.</span></span></span></p>

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->
