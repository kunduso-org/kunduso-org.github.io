---
layout: post
title: "Securely integrate AWS Credentials with GitHub Actions using OpenID Connect"
date: 2023-03-01 03:29:30 +0000
categories: [AWS, GitHub Actions]
tags: [AWS, GitHub Actions, OpenID Connect, IAM, Security, CI/CD]
---

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Recently, I had a request come up where I had to interact with AWS resources from GitHub Actions. In the past, I had done this using Azure Pipelines. I did that by: <a href="https://skundunotes.com/2022/03/30/manage-secure-variables-with-azure-devops-library-and-azure-pipelines/" target="_blank" rel="noopener">(a) storing the credentials (access_key and secret_key of the IAM user) as secure variables in the Azure DevOps Library variable group and (b) by allowing Azure Pipelines builder to access the secure variables in the variable group</a>.</span></span></span>
<!--more-->
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In the case of GitHub actions, I could use a similar approach: store the secrets securely (<em>GitHub repo page -&gt; Settings -&gt; Security -&gt; Secrets and variables -&gt; Actions -&gt; New repository secret</em>) in the repository, which would enable the GitHub Actions builder to access to them. And although the credentials are stored as secrets, they can get accidentally exposed if <span style="text-decoration: underline">someone gains access to the build runner machine</span>. And to prevent long-lived access keys, one will have to create new security credentials (access and secret keys in Amazon Identity and Access Management (IAM)) and then update the same in GitHub Actions secrets regularly, <span style="text-decoration: underline">which could become tedious</span>. But there is a better option than that from a security and maintainability standpoint which I discuss here.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In this note, as the title suggests, I explain in detail how to securely integrate AWS Credentials with GitHub Actions using OpenID Connect. I also have a link to my GitHub repo with the actions YAML file that you may fork. </span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">It is best to understand this concept via a use case. The example use case is to check if an S3 bucket exists in my AWS account and delete it if it does. This use case covers the broader objective of interacting with the AWS cloud using an OpenID Connect with GitHub Actions.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As a reader of this note, I assume you are familiar with IAM credentials like user, role, policy, and GitHub Actions. This popular CI-CD platform enables developers to build and deploy the code stored in their GitHub repository.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Before I start, I want to share a couple of references that helped me understand this concept: (1) <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html" target="_blank" rel="noopener">AWS-Docs: Creating OpenID Connect identity providers</a>, (2) <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services" target="_blank" rel="noopener">GitHub-Docs: Configuring OpenId Connect in Amazon Web Services</a> and (3) <a href="https://www.youtube.com/watch?v=k2Tv-EJl7V4" target="_blank" rel="noopener">glick.stream's YouTube video: E6 - GitHub Actions: Learn OpenID Connect (OIDC) and deploy securely to AWS || Full Tutorial</a>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The use case consists of four steps, which are:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">1. Create an OpenID Connect identity provider in IAM.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">2. Create a new IAM role.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">3. Edit the IAM role.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">4. Store the IAM role details in GitHub Actions and refer to that in the YAML file.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 1: Create an OpenID Connect identity provider in IAM for GitHub Actions</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">This page -<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html#manage-oidc-provider-console" target="_blank" rel="noopener">Creating and managing an OIDC provider (console)</a> provides a detailed step-by-step guide to add the Identity provider. The provider URL and the client ID (also known as the audience) are available at this link -<a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#adding-the-identity-provider-to-aws" target="_blank" rel="noopener">adding the identity provider to AWS</a>.</span></span></span>
<img class="alignnone size-full wp-image-2319" src="https://skundunotes.com/wp-content/uploads/2023/02/71-image-2.png" alt="71-image-2" width="857" height="550" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Once done, click on Add Provider. Now, we have created the identity provider. The next step is to create a role associated with the Identity provider.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 2: Create a new role</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the AWS IAM console, navigate to Access Management -&gt; Roles -&gt; Create Role -&gt; Web identity.</span></span></span>
<img class="alignnone size-full wp-image-2320" src="https://skundunotes.com/wp-content/uploads/2023/02/71-image-3.png" alt="71-image-3" width="999" height="575" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">You can assign a permission policy if you have specific permissions that you would want the GitHub action to acquire and then click on next. The easiest option is to associate an AdministratorAccess Policy. However, it is not following the principle of least privilege, so please create a new permission policy with only those permissions that the GitHub Actions builder requires. Once done, click next.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">On the next page, name the role and review the trusted entities. Below is a similar screenshot.</span></span></span>
<img class="alignnone size-full wp-image-2334" src="https://skundunotes.com/wp-content/uploads/2023/02/71-image-4-1.png" alt="71-image-4" width="983" height="375" />
<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 3: Edit the role</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">After creating the role, I edited the trust relationship based on the advice at <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#adding-the-identity-provider-to-aws" target="_blank" rel="noopener">adding-the-identity-provider-to-AWS</a>. After making the change, the trust entity looked like the below image.</span></span></span>
<img class="alignnone size-full wp-image-2335" src="https://skundunotes.com/wp-content/uploads/2023/02/71-image-5-1.png" alt="71-image-5" width="1036" height="490" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">As you can see, I updated the trusted entity with my GitHub repository name, and the wildcard represents any branch in that repository. The trust policy editor might complain because of the wildcard. I ignored that because I wanted the GitHub action step to work for all branches.</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">The final step is to refer to the role in the project pipeline's YAML file.</span></span></span>

<strong><span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Step 4: Store the IAM role ARN in GitHub Actions secret and refer to that in the YAML file</span></span></span></strong>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">In my case, I stored the role ARN as a secret in the GitHub repository and referred to that in the YAML file. You can access that from my <a href="https://github.com/kunduso/TestProjects/blob/add-aws-credentials-to-gh-actions/.github/workflows/pipeline.yml" target="_blank" rel="noopener">GitHub repo: TestProjects</a>.</span></span></span>
<img class="alignnone size-full wp-image-2323" src="https://skundunotes.com/wp-content/uploads/2023/02/71-image-6.png" alt="71-image-6" width="683" height="182" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">Also, please do not forget to update the YAML file with the permissions settings described in this step <a href="https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#adding-permissions-settings" target="_blank" rel="noopener">-adding-permissions-settings</a>.</span></span></span>
<img class="alignnone size-full wp-image-2324" src="https://skundunotes.com/wp-content/uploads/2023/02/71-image-7.png" alt="71-image-7" width="288" height="101" />
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">If you are interested in the build logs, please access them at <span style="text-decoration: underline"><a href="https://github.com/kunduso/TestProjects/actions/workflows/pipeline.yml" target="_blank" rel="noopener">GitHub Actions</a></span>.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I can think of two benefits of the above process:</span></span></span>
<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">-I no longer have to store the aws access and secret key in GitHub, and I no longer have to rotate the <code>access_key</code> and <code>secret key</code>, which frees up my time and strengthens the security posture of my AWS Account and the GiHub Actions workflow.</span></span></span>

<span style="font-size: 18px"><span style="font-family: calibri"><span style="color: #000000">I hope you will try using the federated login option to integrate GitHub Actions with your AWS account next time. Let me know if you have any questions or suggestions.</span></span></span>
